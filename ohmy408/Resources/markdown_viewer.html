<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Markdown + LaTeX 阅读器</title>
                <!-- 引入 Marked.js -->
                <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onload="window.markedLoaded=true;" onerror="window.markedLoadError=true;"></script>
                <!-- 备用CDN链接 -->
                <script>
                    // 早期加载检测
                    window.markedReady = false;
                    window.markedLoaded = false;
                    window.markedLoadError = false;
                    
                    // 监听主脚本加载状态
                    window.addEventListener('load', function() {
                        setTimeout(function() {
                            if (typeof marked !== 'undefined' && window.markedLoaded) {
                                console.log('✅ Marked.js主CDN加载成功');
                                window.markedReady = true;
                            } else if (window.markedLoadError || typeof marked === 'undefined') {
                                console.warn('⚠️ 主CDN加载失败，尝试备用CDN');
                                var fallbackScript = document.createElement('script');
                                fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js';
                                fallbackScript.onload = function() {
                                    console.log('✅ 备用CDN加载成功');
                                    window.markedReady = true;
                                };
                                fallbackScript.onerror = function() {
                                    console.error('❌ 备用CDN也加载失败，使用简单markdown解析器');
                                    window.markedReady = false;
                                    // 确保简单解析器被初始化
                                    if (typeof initSimpleMarkdownParser === 'function') {
                                        initSimpleMarkdownParser();
                                    }
                                };
                                document.head.appendChild(fallbackScript);
                            }
                        }, 100); // 给主脚本100ms加载时间
                    });
                </script>
                <!-- 引入 MathJax 配置 -->
                <script>
                    window.MathJax = {
                        tex: {
                            inlineMath: [['$', '$'], ['\\(', '\\)']],     // 行内公式分隔符
                            displayMath: [['$$', '$$'], ['\\[', '\\]']], // 块级公式分隔符
                            processEscapes: true,                        // 支持反斜杠转义
                            processEnvironments: true,                   // 支持环境
                            packages: {
                                '[+]': ['base', 'ams', 'amssymb', 'boldsymbol', 'physics', 'mhchem', 'newcommand', 'configmacros', 'color', 'textmacros']
                            },
                            macros: {
                                // 中文数制表示宏定义
                                '原': '\\text{原}',
                                '反': '\\text{反}',
                                '补': '\\text{补}',
                                '码': '\\text{码}',
                                // 英文数制表示宏定义
                                'orig': '\\text{orig}',
                                'inv': '\\text{inv}',
                                'comp': '\\text{comp}',
                                'code': '\\text{code}',
                                // 其他常用宏
                                'binary': '\\text{binary}',
                                'decimal': '\\text{decimal}',
                                'hex': '\\text{hex}',
                                'octal': '\\text{octal}'
                            },
                            tags: 'ams',                                 // 公式编号
                            tagSide: 'right',                           // 编号位置
                            tagIndent: '0.8em'                          // 编号缩进
                        },
                        chtml: {
                            scale: 1.1,                                 // 公式缩放
                            minScale: 0.5,                              // 最小缩放
                            matchFontHeight: false,                     // 匹配字体高度
                            displayAlign: 'center',                     // 居中对齐
                            displayIndent: '0em',                       // 显示缩进
                            fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'  // 字体支持
                        },
                        startup: {
                            typeset: false                              // 禁止自动初始化，手动控制渲染
                        },
                        loader: {
                            load: ['[tex]/mhchem', '[tex]/physics', '[tex]/configmacros', '[tex]/color', '[tex]/textmacros']
                        }
                    };
                </script>
                <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
                <!-- 引入 Mermaid.js -->
                <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
                <style>
                    /* === 基础样式重置与设置 === */
                    body {
                        font-family: var(--font-family-text);
                        font-size: var(--font-size-base, 1rem);
                        line-height: var(--line-height-relaxed, 1.75);
                        color: var(--color-text-primary);
                        background-color: var(--color-bg-primary);
                        margin: 0;
                        padding: var(--spacing-5, 20px);
                        max-width: 100vw;
                        box-sizing: border-box;
                        transition: color var(--transition-base), background-color var(--transition-base);
                    }
                    
                    /* === 主要内容容器 === */
                    .markdown-container,
                    #rendered-content {
                        max-width: 54rem; /* 864px - 更现代的阅读宽度 */
                        margin: 0 auto;
                        padding: var(--spacing-4) 0;
                    }
                    
                    /* 样式系统 */
                    :root {
                        /* === 颜色系统 === */
                        --color-bg-primary: #fefefe;
                        --color-bg-secondary: #f8fafc;
                        --color-bg-tertiary: #f1f5f9;
                        --color-bg-accent: #e2e8f0;
                        
                        --color-text-primary: #1a202c;
                        --color-text-secondary: #4a5568;
                        --color-text-tertiary: #718096;
                        --color-text-muted: #a0aec0;
                        
                        --color-accent-blue: #3182ce;
                        --color-accent-blue-light: #63b3ed;
                        --color-accent-green: #38a169;
                        --color-accent-purple: #805ad5;
                        --color-accent-orange: #dd6b20;
                        --color-accent-red: #e53e3e;
                        
                        --color-border-light: #e2e8f0;
                        --color-border-medium: #cbd5e0;
                        --color-border-strong: #a0aec0;
                        
                        /* === 语义化颜色映射 === */
                        --heading-color-1: var(--color-text-primary);
                        --heading-color-2: var(--color-text-secondary);
                        --heading-color-3: var(--color-text-secondary);
                        --heading-color-4: var(--color-text-tertiary);
                        --heading-color-5: var(--color-text-muted);
                        --heading-color-6: var(--color-text-muted);
                        
                        --decoration-blue: linear-gradient(90deg, var(--color-accent-blue) 0%, var(--color-accent-blue-light) 100%);
                        --decoration-green: var(--color-accent-green);
                        --decoration-amber: var(--color-accent-orange);
                        --decoration-amber-hover: #c05621;
                        --decoration-purple: var(--color-accent-purple);
                        
                        /* === 字体系统 === */
                        --font-family-text: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", system-ui, sans-serif;
                        --font-family-display: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", system-ui, sans-serif;
                        --font-family-mono: "SF Mono", "JetBrains Mono", "Fira Code", "Consolas", monospace;
                        
                        /* === 标题尺寸系统 === */
                        --h1-size: 2.25em;
                        --h2-size: 1.75em;
                        --h3-size: 1.4em;
                        --h4-size: 1.15em;
                        --h5-size: 0.9em;
                        --h6-size: 0.85em;
                        
                        /* === 间距系统 === */
                        --spacing-1: 0.25rem;   /* 4px */
                        --spacing-2: 0.5rem;    /* 8px */
                        --spacing-3: 0.75rem;   /* 12px */
                        --spacing-4: 1rem;      /* 16px */
                        --spacing-5: 1.25rem;   /* 20px */
                        --spacing-6: 1.5rem;    /* 24px */
                        --spacing-8: 2rem;      /* 32px */
                        --spacing-10: 2.5rem;   /* 40px */
                        --spacing-12: 3rem;     /* 48px */
                        --spacing-16: 4rem;     /* 64px */
                        
                        --heading-margin-top: var(--spacing-8);
                        --heading-margin-bottom: var(--spacing-4);
                        --h1-padding-bottom: var(--spacing-3);
                        --h2-padding-bottom: var(--spacing-2);
                        --h3-padding-left: var(--spacing-6);
                        --h4-padding-left: var(--spacing-4);
                        
                        /* === 圆角系统 === */
                        --radius-sm: 4px;
                        --radius-md: 8px;
                        --radius-lg: 12px;
                        --radius-xl: 16px;
                        
                        /* === 阴影系统 === */
                        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
                        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.06);
                        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.07);
                        
                        /* === 装饰尺寸系统 === */
                        --h1-line-width: 60px;
                        --h1-line-width-hover: 100px;
                        --h1-line-height: 4px;
                        --h2-line-width: 40px;
                        --h2-line-width-hover: 80px;
                        --h2-line-height: 3px;
                        
                        /* === 过渡系统 === */
                        --transition-fast: 150ms ease-out;
                        --transition-base: 250ms ease-out;
                        --transition-smooth: 350ms cubic-bezier(0.4, 0, 0.2, 1);
                        --scroll-margin: var(--spacing-16);
                        
                        /* === 交互动画增强 === */
                        --hover-scale: scale(1.02);
                        --focus-outline: 2px solid #3b82f6;
                        --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.05);
                        --shadow-medium: 0 2px 6px rgba(0, 0, 0, 0.08);
                        --shadow-heavy: 0 4px 12px rgba(0, 0, 0, 0.1);
                        
                        /* === 响应式尺寸系统 === */
                        /* 平板端(≤768px) */
                        --h1-size-tablet: 1.8em;
                        --h2-size-tablet: 1.5em;
                        --h3-size-tablet: 1.25em;
                        --h4-size-tablet: 1.1em;
                        --h5-h6-size-tablet: 0.9em;
                        --scroll-margin-tablet: 60px;
                        --h1-line-width-tablet: 50px;
                        --h1-line-width-hover-tablet: 75px;
                        --h1-line-height-tablet: 3px;
                        --h2-line-width-tablet: 35px;
                        --h2-line-width-hover-tablet: 60px;
                        --h2-line-height-tablet: 2px;
                        
                        /* 手机端(≤480px) */
                        --h1-size-mobile: 1.6em;
                        --h2-size-mobile: 1.35em;
                        --h3-size-mobile: 1.15em;
                        --h4-size-mobile: 1.05em;
                        --h5-h6-size-mobile: 0.85em;
                        --scroll-margin-mobile: 50px;
                        --h1-line-width-mobile: 40px;
                        --h1-line-width-hover-mobile: 60px;
                        --h1-line-height-mobile: 2px;
                        --h2-line-width-mobile: 30px;
                        --h2-line-width-hover-mobile: 50px;
                        --h2-line-height-mobile: 2px;
                        
                        /* === 深色模式颜色系统 === */
                        --color-dark-bg-primary: #0f172a;
                        --color-dark-bg-secondary: #1e293b;
                        --color-dark-bg-tertiary: #334155;
                        --color-dark-bg-accent: #475569;
                        
                        --color-dark-text-primary: #ffffff;      /* 纯白色，最高对比度 */
                        --color-dark-text-secondary: #f1f5f9;   /* 极浅灰，高对比度 */
                        --color-dark-text-tertiary: #e2e8f0;    /* 提升至原来的secondary级别 */
                        --color-dark-text-muted: #cbd5e0;       /* 提升对比度 */
                        
                        --color-dark-accent-blue: #60a5fa;
                        --color-dark-accent-green: #34d399;
                        --color-dark-accent-purple: #a78bfa;
                        --color-dark-accent-orange: #fb923c;
                        --color-dark-accent-red: #f87171;
                        
                        --color-dark-border-light: #334155;
                        --color-dark-border-medium: #475569;
                        --color-dark-border-strong: #64748b;
                        
                        /* === 深色模式语义化映射 === */
                        --dark-heading-color-1: #ffffff;          /* H1使用纯白色 */
                        --dark-heading-color-2: #f1f5f9;          /* H2使用极浅灰 */
                        --dark-heading-color-3: #e2e8f0;          /* H3使用浅灰 */
                        --dark-heading-color-4: #e2e8f0;          /* H4使用浅灰 */
                        --dark-heading-color-5: #cbd5e0;          /* H5使用中等灰 */
                        --dark-heading-color-6: #cbd5e0;          /* H6使用中等灰 */
                        
                        --dark-decoration-blue: linear-gradient(90deg, var(--color-dark-accent-blue) 0%, #3b82f6 100%);
                        --dark-decoration-green: var(--color-dark-accent-green);
                        --dark-decoration-amber: var(--color-dark-accent-orange);
                        --dark-decoration-amber-hover: #f59e0b;
                        --dark-decoration-purple: var(--color-dark-accent-purple);
                    }
                    
                    /* === 深色模式自动切换 === */
                    [data-theme="dark"] {
                        /* 重新定义所有颜色变量 */
                        --color-bg-primary: var(--color-dark-bg-primary);
                        --color-bg-secondary: var(--color-dark-bg-secondary);
                        --color-bg-tertiary: var(--color-dark-bg-tertiary);
                        --color-bg-accent: var(--color-dark-bg-accent);
                        
                        --color-text-primary: var(--color-dark-text-primary);
                        --color-text-secondary: var(--color-dark-text-secondary);
                        --color-text-tertiary: var(--color-dark-text-tertiary);
                        --color-text-muted: var(--color-dark-text-muted);
                        
                        --color-accent-blue: var(--color-dark-accent-blue);
                        --color-accent-green: var(--color-dark-accent-green);
                        --color-accent-purple: var(--color-dark-accent-purple);
                        --color-accent-orange: var(--color-dark-accent-orange);
                        --color-accent-red: var(--color-dark-accent-red);
                        
                        --color-border-light: var(--color-dark-border-light);
                        --color-border-medium: var(--color-dark-border-medium);
                        --color-border-strong: var(--color-dark-border-strong);
                        
                        /* 重新定义标题颜色 */
                        --heading-color-1: var(--dark-heading-color-1);
                        --heading-color-2: var(--dark-heading-color-2);
                        --heading-color-3: var(--dark-heading-color-3);
                        --heading-color-4: var(--dark-heading-color-4);
                        --heading-color-5: var(--dark-heading-color-5);
                        --heading-color-6: var(--dark-heading-color-6);
                        
                        --decoration-blue: var(--dark-decoration-blue);
                        --decoration-green: var(--dark-decoration-green);
                        --decoration-amber: var(--dark-decoration-amber);
                        --decoration-amber-hover: var(--dark-decoration-amber-hover);
                        --decoration-purple: var(--dark-decoration-purple);
                    }
                    
                    /* === 现代标题系统 === */
                    .markdown-container :is(h1, h2, h3, h4, h5, h6),
                    #rendered-content :is(h1, h2, h3, h4, h5, h6) {
                        font-family: var(--font-family-display);
                        font-weight: 700;
                        line-height: var(--line-height-tight, 1.25);
                        letter-spacing: -0.02em;
                        color: var(--color-text-primary);
                        margin-top: var(--heading-margin-top);
                        margin-bottom: var(--heading-margin-bottom);
                        position: relative;
                        transition: color var(--transition-base);
                        scroll-margin-top: var(--scroll-margin);
                    }
                    
                    /* === H1 主标题：优雅底线装饰 === */
                    .markdown-container h1,
                    #rendered-content h1 {
                        font-size: var(--h1-size);
                        color: var(--heading-color-1);
                        font-weight: 800;
                        margin-top: 0;
                        margin-bottom: var(--spacing-6);
                        padding-bottom: var(--h1-padding-bottom);
                    }
                    
                    .markdown-container h1::after,
                    #rendered-content h1::after {
                        content: '';
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: var(--h1-line-width);
                        height: var(--h1-line-height);
                        background: var(--decoration-blue);
                        border-radius: 2px;
                        transition: width var(--transition-smooth);
                    }
                    
                    .markdown-container h1:hover::after,
                    #rendered-content h1:hover::after {
                        width: var(--h1-line-width-hover);
                    }
                    
                    /* === H2 二级标题：精致细线装饰 === */
                    .markdown-container h2,
                    #rendered-content h2 {
                        font-size: var(--h2-size);
                        color: var(--heading-color-2);
                        margin-top: var(--spacing-12);
                        margin-bottom: var(--heading-margin-bottom);
                        padding-bottom: var(--h2-padding-bottom);
                    }
                    
                    .markdown-container h2::after,
                    #rendered-content h2::after {
                        content: '';
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: var(--h2-line-width);
                        height: var(--h2-line-height);
                        background: var(--decoration-green);
                        border-radius: 1.5px;
                        transition: width var(--transition-smooth);
                    }
                    
                    .markdown-container h2:hover::after,
                    #rendered-content h2:hover::after {
                        width: var(--h2-line-width-hover);
                    }
                    
                    /* === H3 三级标题：动态箭头装饰 === */
                    .markdown-container h3,
                    #rendered-content h3 {
                        font-size: var(--h3-size);
                        color: var(--heading-color-3);
                        font-weight: 650;
                        margin-top: var(--spacing-10);
                        margin-bottom: var(--spacing-4);
                        padding-left: var(--h3-padding-left);
                    }
                    
                    .markdown-container h3::before,
                    #rendered-content h3::before {
                        content: '▶';
                        position: absolute;
                        left: 0;
                        top: 0.05em;
                        font-size: 0.7em;
                        color: var(--decoration-amber);
                        transition: all var(--transition-fast);
                    }
                    
                    .markdown-container h3:hover::before,
                    #rendered-content h3:hover::before {
                        color: var(--decoration-amber-hover);
                        transform: translateX(var(--spacing-1));
                    }
                    
                    /* === H4 四级标题：圆点装饰 === */
                    .markdown-container h4,
                    #rendered-content h4 {
                        font-size: var(--h4-size);
                        color: var(--heading-color-4);
                        font-weight: 600;
                        margin-top: var(--spacing-8);
                        margin-bottom: var(--spacing-3);
                        padding-left: var(--h4-padding-left);
                    }
                    
                    .markdown-container h4::before,
                    #rendered-content h4::before {
                        content: '●';
                        position: absolute;
                        left: 0;
                        top: 0.1em;
                        font-size: 0.6em;
                        color: var(--decoration-purple);
                        transition: opacity var(--transition-fast);
                    }
                    
                    .markdown-container h4:hover::before,
                    #rendered-content h4:hover::before {
                        opacity: 0.7;
                    }
                    
                    /* === H5 & H6 简约标题样式 === */
                    .markdown-container h5,
                    #rendered-content h5 {
                        font-size: var(--h5-size);
                        color: var(--heading-color-5);
                        font-weight: 600;
                        margin-top: var(--spacing-6);
                        margin-bottom: var(--spacing-3);
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                    }
                    
                    .markdown-container h6,
                    #rendered-content h6 {
                        font-size: var(--h6-size);
                        color: var(--heading-color-6);
                        font-weight: 600;
                        margin-top: var(--spacing-5);
                        margin-bottom: var(--spacing-2);
                        font-style: italic;
                        text-transform: uppercase;
                        letter-spacing: 0.08em;
                    }
                    
                    /* === 现代段落与文本系统 === */
                    .markdown-container p,
                    #rendered-content p {
                        margin-bottom: var(--spacing-5);
                        line-height: var(--line-height-relaxed);
                        text-align: justify;
                        word-spacing: 0.05em;
                        color: var(--color-text-secondary);
                        transition: color var(--transition-base);
                    }
                    
                    .markdown-container p:hover,
                    #rendered-content p:hover {
                        color: var(--color-text-primary);
                    }
                    
                    /* 首段落强调样式 */
                    .markdown-container > p:first-of-type,
                    #rendered-content > p:first-of-type {
                        font-size: var(--font-size-lg, 1.125rem);
                        line-height: var(--line-height-normal, 1.5);
                        margin-bottom: var(--spacing-6);
                        color: var(--color-text-primary);
                        font-weight: 400;
                    }
                    
                    /* === 优雅文本选择效果 === */
                    .markdown-container ::selection,
                    #rendered-content ::selection {
                        background-color: var(--color-accent-blue);
                        color: white;
                        text-shadow: none;
                    }
                    
                    .markdown-container ::-moz-selection,
                    #rendered-content ::-moz-selection {
                        background-color: var(--color-accent-blue);
                        color: white;
                        text-shadow: none;
                    }
                    
                    /* === 内联代码样式 === */
                    .markdown-container code,
                    #rendered-content code {
                        background-color: var(--color-bg-tertiary);
                        border: 1px solid var(--color-border-light);
                        border-radius: var(--radius-sm);
                        font-size: 0.9em;
                        font-weight: 500;
                        margin: 0;
                        padding: var(--spacing-1) var(--spacing-2);
                        font-family: var(--font-family-mono);
                        color: var(--color-accent-red);
                        transition: all var(--transition-fast);
                    }
                    
                    .markdown-container code:hover,
                    #rendered-content code:hover {
                        background-color: var(--color-bg-accent);
                        border-color: var(--color-border-medium);
                        transform: scale(1.02);
                    }
                    
                    
                    /* === 优雅引用块系统 === */
                    .markdown-container blockquote,
                    #rendered-content blockquote {
                        border-left: 4px solid var(--color-accent-blue);
                        margin: var(--spacing-8) 0;
                        padding: var(--spacing-6);
                        background-color: var(--color-bg-secondary);
                        border-radius: 0 var(--radius-md) var(--radius-md) 0;
                        color: var(--color-text-secondary);
                        position: relative;
                        font-style: italic;
                        transition: all var(--transition-base);
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .markdown-container blockquote:hover,
                    #rendered-content blockquote:hover {
                        border-left-color: var(--color-accent-blue-light);
                        background-color: var(--color-bg-tertiary);
                        box-shadow: var(--shadow-md);
                        transform: translateX(2px);
                    }
                    
                    .markdown-container blockquote::before,
                    #rendered-content blockquote::before {
                        content: '"';
                        position: absolute;
                        top: -0.5rem;
                        left: var(--spacing-4);
                        font-size: 3rem;
                        color: var(--color-accent-blue);
                        opacity: 0.2;
                        line-height: 1;
                        font-family: var(--font-family-display);
                    }
                    
                    .markdown-container blockquote p,
                    #rendered-content blockquote p {
                        margin-bottom: var(--spacing-3);
                        padding-left: var(--spacing-4);
                        text-align: left;
                    }
                    
                    .markdown-container blockquote p:last-child,
                    #rendered-content blockquote p:last-child {
                        margin-bottom: 0;
                    }
                    
                    /* === 现代列表系统 === */
                    .markdown-container :is(ul, ol),
                    #rendered-content :is(ul, ol) {
                        margin-bottom: var(--spacing-5);
                        padding-left: var(--spacing-8);
                        color: var(--color-text-secondary);
                    }
                    
                    .markdown-container li,
                    #rendered-content li {
                        margin-bottom: var(--spacing-2);
                        line-height: var(--line-height-relaxed);
                    }
                    
                    .markdown-container li::marker,
                    #rendered-content li::marker {
                        color: var(--color-accent-blue);
                        font-weight: 600;
                    }
                    
                    /* 嵌套列表样式 */
                    .markdown-container li > :is(ul, ol),
                    #rendered-content li > :is(ul, ol) {
                        margin-top: var(--spacing-2);
                        margin-bottom: var(--spacing-2);
                        padding-left: var(--spacing-6);
                    }
                    
                    /* === 现代表格系统 === */
                    .markdown-container table,
                    #rendered-content table {
                        width: 100%;
                        margin: var(--spacing-8) 0;
                        border-collapse: separate;
                        border-spacing: 0;
                        border-radius: var(--radius-lg);
                        overflow: hidden;
                        box-shadow: var(--shadow-md);
                        background-color: var(--color-bg-primary);
                        font-size: var(--font-size-sm);
                    }
                    
                    .markdown-container table thead,
                    #rendered-content table thead {
                        background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-tertiary) 100%);
                    }
                    
                    .markdown-container table :is(th, td),
                    #rendered-content table :is(th, td) {
                        padding: var(--spacing-4) var(--spacing-5);
                        text-align: left;
                        border-bottom: 1px solid var(--color-border-light);
                        word-wrap: break-word;
                        vertical-align: top;
                    }
                    
                    .markdown-container table th,
                    #rendered-content table th {
                        font-family: var(--font-family-display);
                        font-weight: 600;
                        color: var(--color-text-primary);
                        font-size: var(--font-size-sm);
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                    }
                    
                    .markdown-container table td,
                    #rendered-content table td {
                        color: var(--color-text-secondary);
                    }
                    
                    .markdown-container table tbody tr:nth-child(even),
                    #rendered-content table tbody tr:nth-child(even) {
                        background-color: var(--color-bg-secondary);
                    }
                    
                    .markdown-container table tbody tr:hover,
                    #rendered-content table tbody tr:hover {
                        background-color: var(--color-bg-tertiary);
                        transition: background-color var(--transition-fast);
                    }
                    
                    /* === 优雅链接系统 === */
                    .markdown-container a,
                    #rendered-content a {
                        color: var(--color-accent-blue);
                        text-decoration: none;
                        border-bottom: 1px solid transparent;
                        transition: all var(--transition-fast);
                        font-weight: 500;
                    }
                    
                    .markdown-container a:hover,
                    #rendered-content a:hover {
                        color: var(--color-accent-blue-light);
                        border-bottom-color: var(--color-accent-blue-light);
                        text-decoration: none;
                    }
                    
                    /* === 现代分割线 === */
                    .markdown-container hr,
                    #rendered-content hr {
                        margin: var(--spacing-12) 0;
                        border: none;
                        height: 1px;
                        background: linear-gradient(90deg, transparent, var(--color-border-medium), transparent);
                        opacity: 0.8;
                    }
                    
                    /* === 优雅图片系统 === */
                    .markdown-container img,
                    #rendered-content img {
                        max-width: 100%;
                        height: auto;
                        border-radius: var(--radius-md);
                        margin: var(--spacing-6) 0;
                        box-shadow: var(--shadow-sm);
                        transition: all var(--transition-base);
                        cursor: zoom-in;
                        display: block;
                    }
                    
                    .markdown-container img:hover,
                    #rendered-content img:hover {
                        transform: scale(1.02);
                        box-shadow: var(--shadow-md);
                        border-radius: var(--radius-lg);
                    }
                    
                    /* MathJax 公式样式 - 使用高特异性选择器 */
                    #rendered-content .MathJax {
                        font-size: 1.1em;
                    }
                    
                    #rendered-content .MathJax_Display {
                        margin: 1em 0;
                    }
                    
                    /* === 现代响应式设计系统 === */
                    
                    /* 移动端优化 (≤640px) */
                    @media (max-width: 640px) {
                        /* 基础布局优化 */
                        body {
                            padding: var(--spacing-4);
                            font-size: var(--font-size-sm);
                        }
                        
                        .markdown-container,
                        #rendered-content {
                            padding: var(--spacing-2) 0;
                        }
                        
                        /* 标题响应式 */
                        .markdown-container h1,
                        #rendered-content h1 {
                            font-size: 1.75rem; /* 28px */
                            margin-bottom: var(--spacing-5);
                        }
                        
                        .markdown-container h2,
                        #rendered-content h2 {
                            font-size: 1.5rem; /* 24px */
                            margin-top: var(--spacing-8);
                        }
                        
                        .markdown-container h3,
                        #rendered-content h3 {
                            font-size: 1.25rem; /* 20px */
                            margin-top: var(--spacing-6);
                        }
                        
                        /* 组件移动端优化 */
                        .markdown-container blockquote,
                        #rendered-content blockquote {
                            margin: var(--spacing-6) 0;
                            padding: var(--spacing-4);
                        }
                        
                        .markdown-container table,
                        #rendered-content table {
                            font-size: 0.75rem; /* 12px */
                            margin: var(--spacing-6) 0;
                        }
                        
                        .markdown-container table :is(th, td),
                        #rendered-content table :is(th, td) {
                            padding: var(--spacing-2) var(--spacing-3);
                        }
                    }
                    
                    /* 平板端优化 (641px - 1024px) */
                    @media (min-width: 641px) and (max-width: 1024px) {
                        body {
                            padding: var(--spacing-6);
                        }
                        
                        .markdown-container,
                        #rendered-content {
                            max-width: 48rem; /* 768px */
                        }
                    }
                    
                    @media (max-width: 480px) {
                        /* === 手机端标题优化 === */
                        h1 {
                            font-size: var(--h1-size-mobile);
                            margin-top: 1.2em;
                            padding-bottom: 0.3em;
                        }
                        
                        h1::after {
                            width: var(--h1-line-width-mobile);
                            height: var(--h1-line-height-mobile);
                        }
                        
                        h1:hover::after {
                            width: var(--h1-line-width-hover-mobile);
                        }
                        
                        h2 {
                            font-size: var(--h2-size-mobile);
                            margin-top: 1em;
                            padding-bottom: 0.2em;
                        }
                        
                        h2::after {
                            width: var(--h2-line-width-mobile);
                            height: var(--h2-line-height-mobile);
                        }
                        
                        h2:hover::after {
                            width: var(--h2-line-width-hover-mobile);
                        }
                        
                        h3 {
                            font-size: var(--h3-size-mobile);
                            padding-left: 0.5em;
                        }
                        
                        h3::before {
                            font-size: 0.5em;
                        }
                        
                        h4 {
                            font-size: var(--h4-size-mobile);
                            padding-left: 0.4em;
                        }
                        
                        h4::before {
                            font-size: 0.45em;
                        }
                        
                        h5, h6 {
                            font-size: var(--h5-h6-size-mobile);
                        }
                        
                        /* 手机端最小化动画效果 */
                        h1, h2, h3, h4 {
                            scroll-margin-top: var(--scroll-margin-mobile);
                        }
                        
                        h3:hover::before {
                            transform: none; /* 移除动画以提升性能 */
                        }
                    }
                    
                    /* === 深色模式系统 === */
                    /* 系统自动检测深色模式 */
                    @media (prefers-color-scheme: dark) {
                        body:not(.light-mode) {
                            background-color: #0d1117;
                            color: #e6edf3;
                            transition: all var(--transition-smooth);
                        }
                    }
                    
                    /* 手动深色模式 + 变量重构 */
                    body.dark-mode {
                        background-color: #0d1117;
                        color: #e6edf3;
                        transition: all var(--transition-smooth);
                        
                        /* 重定义深色模式下的CSS变量 */
                        --heading-color-1: var(--dark-heading-color-1);
                        --heading-color-2: var(--dark-heading-color-2);
                        --heading-color-3: var(--dark-heading-color-3);
                        --heading-color-4: var(--dark-heading-color-4);
                        --heading-color-5: var(--dark-heading-color-5);
                        --heading-color-6: var(--dark-heading-color-6);
                        
                        --decoration-blue: var(--dark-decoration-blue);
                        --decoration-green: var(--dark-decoration-green);
                        --decoration-amber: var(--dark-decoration-amber);
                        --decoration-amber-hover: var(--dark-decoration-amber-hover);
                        --decoration-purple: var(--dark-decoration-purple);
                    }
                    
                    /* 深色模式标题阴影增强 */
                    body.dark-mode h1 {
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    }
                    
                    body.dark-mode h2 {
                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                    }
                    
                    body.dark-mode h3, 
                    body.dark-mode h4 {
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                    }
                    
                    /* === 深色模式文字对比度全面优化 === */
                    
                    /* 深色模式主体文字 - 更高对比度 */
                    body.dark-mode,
                    body.dark-mode #rendered-content,
                    body.dark-mode .markdown-container,
                    [data-theme="dark"],
                    [data-theme="dark"] #rendered-content,
                    [data-theme="dark"] .markdown-container {
                        color: #e2e8f0 !important;  /* 提升基础文字对比度 */
                    }
                    
                    /* 深色模式段落文字 - 高对比度优化 */
                    body.dark-mode #rendered-content p,
                    body.dark-mode .markdown-container p,
                    [data-theme="dark"] #rendered-content p,
                    [data-theme="dark"] .markdown-container p {
                        color: #e2e8f0 !important;  /* 使用更亮的颜色 */
                    }
                    
                    /* 深色模式列表文字 - 高对比度 */
                    body.dark-mode #rendered-content ul,
                    body.dark-mode #rendered-content ol,
                    body.dark-mode #rendered-content li,
                    body.dark-mode .markdown-container ul,
                    body.dark-mode .markdown-container ol,
                    body.dark-mode .markdown-container li,
                    [data-theme="dark"] #rendered-content ul,
                    [data-theme="dark"] #rendered-content ol,
                    [data-theme="dark"] #rendered-content li,
                    [data-theme="dark"] .markdown-container ul,
                    [data-theme="dark"] .markdown-container ol,
                    [data-theme="dark"] .markdown-container li {
                        color: #e2e8f0 !important;
                    }
                    
                    /* 深色模式表格文字 - 高对比度 */
                    body.dark-mode #rendered-content table,
                    body.dark-mode #rendered-content td,
                    body.dark-mode #rendered-content th,
                    body.dark-mode .markdown-container table,
                    body.dark-mode .markdown-container td,
                    body.dark-mode .markdown-container th,
                    [data-theme="dark"] #rendered-content table,
                    [data-theme="dark"] #rendered-content td,
                    [data-theme="dark"] #rendered-content th,
                    [data-theme="dark"] .markdown-container table,
                    [data-theme="dark"] .markdown-container td,
                    [data-theme="dark"] .markdown-container th {
                        color: #e2e8f0 !important;
                        border-color: #4a5568 !important;
                    }
                    
                    /* 深色模式引用文字 - 高对比度 */
                    body.dark-mode #rendered-content blockquote,
                    body.dark-mode .markdown-container blockquote,
                    [data-theme="dark"] #rendered-content blockquote,
                    [data-theme="dark"] .markdown-container blockquote {
                        color: #cbd5e0 !important;
                        border-left-color: #68d391 !important;
                        background: rgba(104, 211, 145, 0.1) !important;
                    }
                    
                    /* 深色模式强调文字 - 更突出 */
                    body.dark-mode #rendered-content strong,
                    body.dark-mode #rendered-content b,
                    body.dark-mode .markdown-container strong,
                    body.dark-mode .markdown-container b,
                    [data-theme="dark"] #rendered-content strong,
                    [data-theme="dark"] #rendered-content b,
                    [data-theme="dark"] .markdown-container strong,
                    [data-theme="dark"] .markdown-container b {
                        color: #ffffff !important;  /* 粗体文字使用纯白色 */
                        font-weight: 600;
                    }
                    
                    /* 深色模式斜体文字 */
                    body.dark-mode #rendered-content em,
                    body.dark-mode #rendered-content i,
                    body.dark-mode .markdown-container em,
                    body.dark-mode .markdown-container i,
                    [data-theme="dark"] #rendered-content em,
                    [data-theme="dark"] #rendered-content i,
                    [data-theme="dark"] .markdown-container em,
                    [data-theme="dark"] .markdown-container i {
                        color: #f1f5f9 !important;
                    }
                    
                    /* 深色模式链接文字 - 更亮的蓝色 */
                    body.dark-mode #rendered-content a,
                    body.dark-mode .markdown-container a,
                    [data-theme="dark"] #rendered-content a,
                    [data-theme="dark"] .markdown-container a {
                        color: #60a5fa !important;  /* 更亮的蓝色 */
                    }
                    
                    body.dark-mode #rendered-content a:hover,
                    body.dark-mode .markdown-container a:hover,
                    [data-theme="dark"] #rendered-content a:hover,
                    [data-theme="dark"] .markdown-container a:hover {
                        color: #93c5fd !important;  /* 悬停时更亮 */
                    }
                    
                    /* 深色模式标题文字 - 更高对比度 */
                    body.dark-mode #rendered-content h1,
                    body.dark-mode .markdown-container h1,
                    [data-theme="dark"] #rendered-content h1,
                    [data-theme="dark"] .markdown-container h1 {
                        color: #ffffff !important;  /* H1纯白色 */
                    }
                    
                    body.dark-mode #rendered-content h2,
                    body.dark-mode .markdown-container h2,
                    [data-theme="dark"] #rendered-content h2,
                    [data-theme="dark"] .markdown-container h2 {
                        color: #f1f5f9 !important;  /* H2极浅灰 */
                    }
                    
                    body.dark-mode #rendered-content h3,
                    body.dark-mode #rendered-content h4,
                    body.dark-mode .markdown-container h3,
                    body.dark-mode .markdown-container h4,
                    [data-theme="dark"] #rendered-content h3,
                    [data-theme="dark"] #rendered-content h4,
                    [data-theme="dark"] .markdown-container h3,
                    [data-theme="dark"] .markdown-container h4 {
                        color: #e2e8f0 !important;  /* H3-H4浅灰 */
                    }
                    
                    body.dark-mode #rendered-content h5,
                    body.dark-mode #rendered-content h6,
                    body.dark-mode .markdown-container h5,
                    body.dark-mode .markdown-container h6,
                    [data-theme="dark"] #rendered-content h5,
                    [data-theme="dark"] #rendered-content h6,
                    [data-theme="dark"] .markdown-container h5,
                    [data-theme="dark"] .markdown-container h6 {
                        color: #cbd5e0 !important;  /* H5-H6中等灰 */
                    }
                    
                    /* 深色模式代码文字 - 确保高对比度 */
                    body.dark-mode #rendered-content code:not(pre code),
                    body.dark-mode .markdown-container code:not(pre code),
                    [data-theme="dark"] #rendered-content code:not(pre code),
                    [data-theme="dark"] .markdown-container code:not(pre code) {
                        background-color: #1a202c !important;
                        color: #e2e8f0 !important;
                        border: 1px solid #4a5568 !important;
                        padding: 2px 4px !important;
                        border-radius: 3px !important;
                    }
                    
                    /* 深色模式分隔线 */
                    body.dark-mode #rendered-content hr,
                    body.dark-mode .markdown-container hr,
                    [data-theme="dark"] #rendered-content hr,
                    [data-theme="dark"] .markdown-container hr {
                        border-color: #4a5568 !important;
                        background: #4a5568 !important;
                    }
                    
                    /* === 深色模式全局文字强化保护 === */
                    
                    /* 所有可能的文字容器 - 全面覆盖 */
                    body.dark-mode #rendered-content *:not(pre):not(code):not(.code-copy-btn):not(.copy-notification),
                    body.dark-mode .markdown-container *:not(pre):not(code):not(.code-copy-btn):not(.copy-notification),
                    [data-theme="dark"] #rendered-content *:not(pre):not(code):not(.code-copy-btn):not(.copy-notification),
                    [data-theme="dark"] .markdown-container *:not(pre):not(code):not(.code-copy-btn):not(.copy-notification) {
                        color: inherit !important;
                    }
                    
                    /* 深色模式根容器文字色 - 最高优先级 */
                    body.dark-mode #rendered-content,
                    body.dark-mode .markdown-container,
                    [data-theme="dark"] #rendered-content,
                    [data-theme="dark"] .markdown-container {
                        color: #e2e8f0 !important;
                    }
                    
                    /* 深色模式特殊元素优化 */
                    body.dark-mode #rendered-content .highlight,
                    body.dark-mode .markdown-container .highlight,
                    [data-theme="dark"] #rendered-content .highlight,
                    [data-theme="dark"] .markdown-container .highlight {
                        background-color: rgba(96, 165, 250, 0.1) !important;
                        color: #e2e8f0 !important;
                    }
                    
                    /* 深色模式键盘按键样式 */
                    body.dark-mode #rendered-content kbd,
                    body.dark-mode .markdown-container kbd,
                    [data-theme="dark"] #rendered-content kbd,
                    [data-theme="dark"] .markdown-container kbd {
                        background-color: #374151 !important;
                        color: #f9fafb !important;
                        border: 1px solid #6b7280 !important;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    /* 深色模式删除线文字 */
                    body.dark-mode #rendered-content del,
                    body.dark-mode #rendered-content s,
                    body.dark-mode .markdown-container del,
                    body.dark-mode .markdown-container s,
                    [data-theme="dark"] #rendered-content del,
                    [data-theme="dark"] #rendered-content s,
                    [data-theme="dark"] .markdown-container del,
                    [data-theme="dark"] .markdown-container s {
                        color: #9ca3af !important;
                        text-decoration-color: #ef4444 !important;
                    }
                    
                    /* 深色模式下划线文字 */
                    body.dark-mode #rendered-content u,
                    body.dark-mode .markdown-container u,
                    [data-theme="dark"] #rendered-content u,
                    [data-theme="dark"] .markdown-container u {
                        color: #e2e8f0 !important;
                        text-decoration-color: #60a5fa !important;
                    }
                    
                    /* 深色模式小字体文字 */
                    body.dark-mode #rendered-content small,
                    body.dark-mode .markdown-container small,
                    [data-theme="dark"] #rendered-content small,
                    [data-theme="dark"] .markdown-container small {
                        color: #cbd5e0 !important;
                    }
                    
                    /* 深色模式文本选中效果 - 使用数据属性选择器 */
                    [data-theme="dark"] ::selection {
                        background-color: var(--color-dark-accent-blue);
                        color: white;
                    }
                    
                    [data-theme="dark"] ::-moz-selection {
                        background-color: var(--color-dark-accent-blue);
                        color: white;
                    }
                    
                    /* 代码块深度优化 */
                    body.dark-mode code {
                        background-color: #161b22;
                        color: #e6edf3;
                    }
                    
                    
                    /* 引用块深度优化 */
                    body.dark-mode blockquote {
                        border-left: 4px solid #58a6ff;
                        color: #8b949e;
                        background-color: #161b22;
                        border-radius: 6px;
                        padding: 16px;
                        margin: 16px 0;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    }
                    
                    /* 表格深度优化 */
                    body.dark-mode table {
                        border: 1px solid #30363d;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                        background-color: #0d1117;
                    }
                    
                    body.dark-mode table th, body.dark-mode table td {
                        border: 1px solid #30363d;
                        background-color: #0d1117;
                        color: #e6edf3;
                    }
                    
                    body.dark-mode table thead tr {
                        background: linear-gradient(135deg, #21262d 0%, #30363d 100%);
                    }
                    
                    body.dark-mode table th {
                        color: #f0f6fc;
                        font-weight: 600;
                    }
                    
                    body.dark-mode table tr:nth-child(2n) {
                        background-color: #161b22;
                    }
                    
                    body.dark-mode table tr:hover {
                        background-color: #21262d;
                        transition: background-color 0.2s ease;
                    }
                    
                    /* 链接深度优化 */
                    body.dark-mode a {
                        color: #58a6ff;
                        transition: all 0.2s ease;
                        text-decoration: none;
                    }
                    
                    body.dark-mode a:hover {
                        color: #79c0ff;
                        text-shadow: 0 0 8px rgba(88, 166, 255, 0.3);
                    }
                    
                    /* 分割线深度优化 */
                    body.dark-mode hr {
                        border-top: 1px solid #30363d;
                        background: linear-gradient(90deg, transparent, #30363d, transparent);
                        opacity: 0.8;
                    }
                    

                    

                    
                    /* 强调文本深度优化 */
                    body.dark-mode strong {
                        color: #f0f6fc;
                        font-weight: 600;
                    }
                    
                    body.dark-mode em {
                        color: #e6edf3;
                        font-style: italic;
                    }
                    
                    body.dark-mode mark {
                        background-color: #9e6a03;
                        color: #f0f6fc;
                        padding: 2px 4px;
                        border-radius: 3px;
                    }
                    
                    body.dark-mode del {
                        color: #8b949e;
                        text-decoration: line-through;
                    }
                    
                    /* 列表深度优化 */
                    body.dark-mode ul, body.dark-mode ol {
                        color: #e6edf3;
                    }
                    
                    body.dark-mode li {
                        margin-bottom: 0.5em;
                    }
                    
                    /* 任务列表深度优化 */
                    body.dark-mode .task-list-item {
                        color: #e6edf3;
                    }
                    
                    body.dark-mode .task-list-item input[type="checkbox"] {
                        accent-color: #58a6ff;
                    }
                    
                    /* 图片 */
                    body.dark-mode img {
                        border: 1px solid #30363d;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                    }
                    
                    body.dark-mode img:hover {
                        border-color: #58a6ff;
                        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
                    }
                    
                      /* 目录面板 */
                    body.dark-mode #toc-panel {
                        background: linear-gradient(180deg, var(--color-dark-bg-secondary) 0%, var(--color-dark-bg-primary) 100%);
                        border-right: 1px solid var(--color-dark-border-light);
                        color: var(--color-dark-text-secondary);
                        backdrop-filter: blur(10px);
                        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5);
                    }


                    
                    /* 目录链接 */
                    #toc-panel .toc-link {
                        color: var(--color-text-primary);
                        transition: var(--transition-base);
                        display: block;
                        padding: var(--spacing-2) var(--spacing-3);
                        text-decoration: none;
                        border-radius: var(--radius-sm);
                    }
                    
                    #toc-panel .toc-link:hover {
                        background: linear-gradient(135deg, var(--color-bg-tertiary) 0%, var(--color-bg-accent) 100%);
                        color: var(--color-accent-blue);
                        box-shadow: var(--shadow-sm);
                    }
                    
                    body.dark-mode #toc-panel .toc-link {
                        color: var(--color-dark-text-secondary);
                    }
                    
                    body.dark-mode #toc-panel .toc-link:hover {
                        background: linear-gradient(135deg, var(--color-dark-bg-tertiary) 0%, var(--color-dark-bg-accent) 100%);
                        color: var(--color-dark-accent-blue);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                        transform: translateX(4px);
                    }
                    
                   
                    
                    /* === 📱 移动端优先代码块设计 === */
                    
                    /* 代码块容器 - 移动端卡片设计 */
                    .markdown-container pre,
                    #rendered-content pre {
                        position: relative;
                        margin: 20px 0;
                        border-radius: 12px;
                        overflow: hidden;
                        background: #f8f9fa;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                        /* 移除过渡效果，移动端不需要 */
                    }
                    
                    /* 代码内容区域 - 移动端优化 */
                    .markdown-container pre code,
                    #rendered-content pre code {
                        display: block;
                        padding: 16px 16px 16px 16px;
                        padding-right: 60px; /* 为右上角按钮预留空间 */
                        margin: 0;
                        background: transparent;
                        border: none;
                        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                        font-size: 14px;
                        font-weight: 400;
                        line-height: 1.5;
                        color: #495057;
                        white-space: pre;
                        word-spacing: normal;
                        word-break: normal;
                        tab-size: 2;
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch; /* iOS滚动优化 */
                    }
                    
                    /* === 📱 移动端复制按钮 === */
                    .markdown-container pre .code-copy-btn,
                    #rendered-content pre .code-copy-btn {
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        width: 36px;
                        height: 28px;
                        background: #ffffff;
                        border: 1px solid #dee2e6;
                        border-radius: 6px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10;
                        user-select: none;
                        -webkit-user-select: none;
                        /* 始终可见，移动端不需要透明度变化 */
                        opacity: 1;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        /* 移除过渡效果 */
                    }
                    
                    /* 触摸按下效果（替代悬停） */
                    .markdown-container pre .code-copy-btn:active,
                    #rendered-content pre .code-copy-btn:active {
                        background: #f8f9fa;
                        transform: scale(0.95);
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
                    }
                    
                    /* 按钮图标 */
                    .markdown-container pre .code-copy-btn svg,
                    #rendered-content pre .code-copy-btn svg {
                        width: 16px;
                        height: 16px;
                        color: #6c757d;
                        stroke-width: 1.5;
                    }
                    
                    /* 成功状态 - iOS风格绿色 */
                    .markdown-container pre .code-copy-btn.success,
                    #rendered-content pre .code-copy-btn.success {
                        background: #28a745;
                        border-color: #28a745;
                        box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
                    }
                    
                    .markdown-container pre .code-copy-btn.success svg,
                    #rendered-content pre .code-copy-btn.success svg {
                        color: white;
                    }
                    
                    /* 错误状态 - iOS风格红色 */
                    .markdown-container pre .code-copy-btn.error,
                    #rendered-content pre .code-copy-btn.error {
                        background: #dc3545;
                        border-color: #dc3545;
                        box-shadow: 0 1px 3px rgba(220, 53, 69, 0.3);
                    }
                    
                    .markdown-container pre .code-copy-btn.error svg,
                    #rendered-content pre .code-copy-btn.error svg {
                        color: white;
                    }
                    
                    /* === 🌙 移动端深色模式 === */
                    [data-theme="dark"] .markdown-container pre,
                    [data-theme="dark"] #rendered-content pre,
                    body.dark-mode .markdown-container pre,
                    body.dark-mode #rendered-content pre {
                        background: #1e2028;
                        border: 1px solid #343a46;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    }
                    
                    /* 深色模式代码文本 */
                    [data-theme="dark"] .markdown-container pre code,
                    [data-theme="dark"] #rendered-content pre code,
                    body.dark-mode .markdown-container pre code,
                    body.dark-mode #rendered-content pre code {
                        color: #e9ecef;
                    }
                    
                    /* 深色模式复制按钮 */
                    [data-theme="dark"] .markdown-container pre .code-copy-btn,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn,
                    body.dark-mode .markdown-container pre .code-copy-btn,
                    body.dark-mode #rendered-content pre .code-copy-btn {
                        background: #2d3748;
                        border-color: #4a5568;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
                    }
                    
                    /* 深色模式按下效果 - 优化为更亮的高亮反馈 */
                    [data-theme="dark"] .markdown-container pre .code-copy-btn:active,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn:active,
                    body.dark-mode .markdown-container pre .code-copy-btn:active,
                    body.dark-mode #rendered-content pre .code-copy-btn:active {
                        background: #4a5568;               /* 更亮的背景 */
                        border-color: #68d391;             /* 绿色边框高亮 */
                        color: #e2e8f0;                    /* 更亮的图标 */
                        transform: scale(0.95);
                        box-shadow: 0 0 12px rgba(104, 211, 145, 0.4), 0 2px 6px rgba(0, 0, 0, 0.3); /* 发光效果 */
                    }
                    
                    [data-theme="dark"] .markdown-container pre .code-copy-btn svg,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn svg,
                    body.dark-mode .markdown-container pre .code-copy-btn svg,
                    body.dark-mode #rendered-content pre .code-copy-btn svg {
                        color: #a0aec0;
                    }
                    
                    /* === 🌙 深色模式代码块整体强化 - 最高优先级 === */
                    
                    /* 深色模式代码块容器 - 防止被覆盖 */
                    body.dark-mode .markdown-container pre,
                    body.dark-mode #rendered-content pre,
                    [data-theme="dark"] .markdown-container pre,
                    [data-theme="dark"] #rendered-content pre,
                    body.dark-mode pre,
                    [data-theme="dark"] pre {
                        background: #1a1f2e !important;
                        border: 1px solid #2d3748 !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                        color: #e2e8f0 !important;
                    }
                    
                    /* 深色模式代码文本内容 - 防止被覆盖 */
                    body.dark-mode .markdown-container pre code,
                    body.dark-mode #rendered-content pre code,
                    [data-theme="dark"] .markdown-container pre code,
                    [data-theme="dark"] #rendered-content pre code,
                    body.dark-mode pre code,
                    [data-theme="dark"] pre code,
                    body.dark-mode code {
                        background: transparent !important;
                        color: #e2e8f0 !important;
                        border: none !important;
                    }
                    
                    /* 深色模式复制按钮 - 超高优先级保护 */
                    body.dark-mode .markdown-container pre .code-copy-btn,
                    body.dark-mode #rendered-content pre .code-copy-btn,
                    [data-theme="dark"] .markdown-container pre .code-copy-btn,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn,
                    body.dark-mode .code-copy-btn,
                    [data-theme="dark"] .code-copy-btn {
                        background: #2d3748 !important;
                        border: 1px solid #4a5568 !important;
                        color: #a0aec0 !important;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    /* 深色模式按钮点击状态 - 更亮的高亮效果 */
                    body.dark-mode .markdown-container pre .code-copy-btn:active,
                    body.dark-mode #rendered-content pre .code-copy-btn:active,
                    [data-theme="dark"] .markdown-container pre .code-copy-btn:active,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn:active,
                    body.dark-mode .code-copy-btn:active,
                    [data-theme="dark"] .code-copy-btn:active {
                        background: #4a5568 !important;    /* 更亮的灰色背景 */
                        border-color: #68d391 !important;  /* 亮绿色边框提示 */
                        color: #e2e8f0 !important;         /* 更亮的文字 */
                        transform: scale(0.95);
                        box-shadow: 0 0 8px rgba(104, 211, 145, 0.3), 0 2px 4px rgba(0, 0, 0, 0.4) !important; /* 绿色发光效果 */
                        animation: darkModeButtonPulse 0.2s ease-out; /* 脉冲动画 */
                    }
                    
                    /* 深色模式按钮脉冲动画 */
                    @keyframes darkModeButtonPulse {
                        0% { 
                            box-shadow: 0 0 8px rgba(104, 211, 145, 0.3), 0 2px 4px rgba(0, 0, 0, 0.4);
                        }
                        50% { 
                            box-shadow: 0 0 16px rgba(104, 211, 145, 0.5), 0 2px 8px rgba(0, 0, 0, 0.4);
                        }
                        100% { 
                            box-shadow: 0 0 8px rgba(104, 211, 145, 0.3), 0 2px 4px rgba(0, 0, 0, 0.4);
                        }
                    }
                    
                    /* 深色模式按钮图标 - 防止图标颜色错误 */
                    body.dark-mode .code-copy-btn svg,
                    [data-theme="dark"] .code-copy-btn svg,
                    body.dark-mode .markdown-container pre .code-copy-btn svg,
                    body.dark-mode #rendered-content pre .code-copy-btn svg,
                    [data-theme="dark"] .markdown-container pre .code-copy-btn svg,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn svg {
                        color: #a0aec0 !important;
                        stroke: #a0aec0 !important;
                    }
                    
                    /* 深色模式按钮点击时图标更亮 */
                    body.dark-mode .code-copy-btn:active svg,
                    [data-theme="dark"] .code-copy-btn:active svg,
                    body.dark-mode .markdown-container pre .code-copy-btn:active svg,
                    body.dark-mode #rendered-content pre .code-copy-btn:active svg,
                    [data-theme="dark"] .markdown-container pre .code-copy-btn:active svg,
                    [data-theme="dark"] #rendered-content pre .code-copy-btn:active svg {
                        color: #e2e8f0 !important;         /* 点击时图标更亮 */
                        stroke: #e2e8f0 !important;
                        filter: drop-shadow(0 0 2px rgba(226, 232, 240, 0.5)); /* 微妙的发光 */
                    }
                    
                    /* 深色模式成功状态按钮 - 更亮的绿色反馈 */
                    body.dark-mode .code-copy-btn.success,
                    [data-theme="dark"] .code-copy-btn.success {
                        background: #38a169 !important;    /* 更亮的绿色背景 */
                        border-color: #68d391 !important;  /* 更亮的绿色边框 */
                        color: #f0fff4 !important;         /* 更亮的白绿色文字 */
                        box-shadow: 0 0 12px rgba(104, 211, 145, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3) !important; /* 绿色发光 */
                    }
                    
                    /* 深色模式错误状态按钮 - 更亮的红色反馈 */
                    body.dark-mode .code-copy-btn.error,
                    [data-theme="dark"] .code-copy-btn.error {
                        background: #e53e3e !important;    /* 更亮的红色背景 */
                        border-color: #fc8181 !important;  /* 更亮的红色边框 */
                        color: #fff5f5 !important;         /* 更亮的白红色文字 */
                        box-shadow: 0 0 12px rgba(252, 129, 129, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3) !important; /* 红色发光 */
                    }
                    
                    /* Toast通知 */
                    .copy-notification {
                        position: fixed;
                        bottom: 24px;
                        left: 50%;
                        transform: translateX(-50%) translateY(60px);
                        background: rgba(0, 0, 0, 0.85);
                        color: white;
                        padding: 12px 18px;
                        border-radius: 8px;
                        font-size: 13px;
                        font-weight: 500;
                        z-index: 1000;
                        opacity: 0;
                        transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                        pointer-events: none;
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
                    }
                    
                    .copy-notification.show {
                        transform: translateX(-50%) translateY(0);
                        opacity: 1;
                    }
                    
                    body.dark-mode .copy-notification {
                        background: rgba(255, 255, 255, 0.9);
                        color: #1a202c;
                    }
                    
                    /* === 📱 移动端响应式优化 === */
                    @media (max-width: 640px) {
                        .markdown-container pre,
                        #rendered-content pre {
                            margin: 16px 0;
                            border-radius: 10px;
                        }
                        
                        .markdown-container pre code,
                        #rendered-content pre code {
                            padding: 12px 12px 12px 12px;
                            padding-right: 50px; /* 为小按钮预留空间 */
                            font-size: 13px;
                            line-height: 1.4;
                        }
                        
                        .markdown-container pre .code-copy-btn,
                        #rendered-content pre .code-copy-btn {
                            top: 8px;
                            right: 8px;
                            width: 32px;
                            height: 24px;
                        }
                        
                        .markdown-container pre .code-copy-btn svg,
                        #rendered-content pre .code-copy-btn svg {
                            width: 14px;
                            height: 14px;
                        }
                    }
                    
                    /* 平板端优化（iPad等） */
                    @media (min-width: 641px) and (max-width: 1024px) {
                        .markdown-container pre code,
                        #rendered-content pre code {
                            padding: 14px 14px 14px 14px;
                            padding-right: 56px;
                            font-size: 14px;
                        }
                        
                        .markdown-container pre .code-copy-btn,
                        #rendered-content pre .code-copy-btn {
                            top: 10px;
                            right: 10px;
                            width: 34px;
                            height: 26px;
                        }
                    }
                    
                    /* 目录面板打开状态 - 使用高特异性选择器 */
                    body #toc-panel.open {
                        left: 0;
                    }
                    
                    /* 目录遮罩层样式 - 使用高特异性选择器 */
                    body #toc-overlay.open {
                        opacity: 1;
                        visibility: visible;
                    }
                    
                    /* 遮罩层深色模式 - 使用设计令牌 */
                    [data-theme="dark"] #toc-overlay {
                        background: radial-gradient(circle, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);
                        backdrop-filter: blur(2px);
                        transition: var(--transition-smooth);
                    }
                    
                    /* Mermaid图表深色模式优化 */
                    body.dark-mode .mermaid-diagram {
                        background: linear-gradient(145deg, #161b22 0%, #0d1117 100%) !important;
                        border: 1px solid #30363d !important;
                        border-radius: 8px !important;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4) !important;
                        padding: 16px !important;
                    }
                    
                    /* MathJax公式深色模式优化 */
                    body.dark-mode .MathJax {
                        color: #e6edf3 !important;
                        background-color: transparent !important;
                    }
                    
                    body.dark-mode .MathJax_Display {
                        background: linear-gradient(145deg, #161b22 0%, #0d1117 100%) !important;
                        border: 1px solid #30363d !important;
                        border-radius: 6px !important;
                        padding: 16px !important;
                        margin: 16px 0 !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    /* 滚动条深度优化 */
                    body.dark-mode::-webkit-scrollbar {
                        width: 8px;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-track {
                        background: #0d1117;
                        border-radius: 4px;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-thumb {
                        background: linear-gradient(180deg, #30363d 0%, #21262d 100%);
                        border-radius: 4px;
                        border: 1px solid #21262d;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-thumb:hover {
                        background: linear-gradient(180deg, #484f58 0%, #30363d 100%);
                    }
                    
                    /* 选择文本深色模式优化 */
                    body.dark-mode ::selection {
                        background-color: #264f78;
                        color: #ffffff;
                    }
                    
                    body.dark-mode ::-moz-selection {
                        background-color: #264f78;
                        color: #ffffff;
                    }
                    
                    /* 焦点状态深度优化 */
                    body.dark-mode button:focus,
                    body.dark-mode a:focus {
                        outline: 2px solid #58a6ff;
                        outline-offset: 2px;
                        border-radius: 4px;
                    }
                    
                    /* 页面加载动画优化 */
                    body.dark-mode #rendered-content {
                        animation: fadeInUp 0.6s ease-out;
                    }
                    
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                        transform: translateY(0);
                        }
                    }
                    
                    /* 移除了重复的目录按钮CSS样式，由原生代码管理 */
                    
                    /* 响应式设计 - 移动端优化 */
                    @media (max-width: 480px) {
                        /* 小屏幕：目录面板75% */
                        #toc-panel {
                            width: 75vw !important;
                            max-width: 320px !important;
                            left: -75vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                        
                        /* 小屏幕下显示遮罩层 */
                        #toc-overlay.open {
                            display: block !important;
                        }
                    }
                    
                    @media (min-width: 481px) and (max-width: 768px) {
                        /* 中等屏幕：目录面板60% */
                        #toc-panel {
                            width: 60vw !important;
                            max-width: 350px !important;
                            left: -60vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                        
                        /* 中等屏幕下显示遮罩层 */
                        #toc-overlay.open {
                            display: block !important;
                        }
                    }
                    
                    @media (min-width: 769px) {
                        /* 大屏幕：隐藏遮罩层 */
                        #toc-overlay {
                            display: none !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        /* 优化目录面板头部 */
                        #toc-panel > div:first-child {
                            padding-top: 50px !important;
                        }
                    }
                    

                    
                    /* Mermaid图表样式 */
                    .mermaid-diagram {
                        transition: all 0.3s ease;
                        max-width: 100%;
                        overflow-x: auto;
                    }
                    
                    .mermaid-diagram svg {
                        max-width: 100%;
                        height: auto;
                        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
                    }
                    
                    /* 深色模式下的Mermaid图表 */
                    body.dark-mode .mermaid-diagram {
                        border-color: #30363d !important;
                        background-color: rgba(22, 27, 34, 0.8) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg {
                        filter: drop-shadow(0 2px 8px rgba(255, 255, 255, 0.1));
                    }
                    
                    /* 增强Mermaid图表文本对比度 */
                    .mermaid-diagram svg text {
                        font-weight: 700 !important;
                        stroke: none !important;
                        fill: #000000 !important;
                        font-size: 14px !important;
                        font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .nodeLabel,
                    .mermaid-diagram svg .edgeLabel text,
                    .mermaid-diagram svg .messageText,
                    .mermaid-diagram svg .labelText,
                    .mermaid-diagram svg .loopText,
                    .mermaid-diagram svg .noteText {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 13px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .actor {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                        fill: #ffffff !important;
                    }
                    
                    .mermaid-diagram svg .actor-line {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .messageLine0,
                    .mermaid-diagram svg .messageLine1 {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg text {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .nodeLabel,
                    body.dark-mode .mermaid-diagram svg .edgeLabel text,
                    body.dark-mode .mermaid-diagram svg .messageText,
                    body.dark-mode .mermaid-diagram svg .labelText,
                    body.dark-mode .mermaid-diagram svg .loopText,
                    body.dark-mode .mermaid-diagram svg .noteText {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .actor {
                        stroke: #e5e7eb !important;
                        fill: #374151 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .actor-line {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .messageLine0,
                    body.dark-mode .mermaid-diagram svg .messageLine1 {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 优化Mermaid图表背景和边框 */
                    .mermaid-diagram svg rect,
                    .mermaid-diagram svg polygon,
                    .mermaid-diagram svg circle,
                    .mermaid-diagram svg ellipse {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .edgePath .path {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg rect,
                    body.dark-mode .mermaid-diagram svg polygon,
                    body.dark-mode .mermaid-diagram svg circle,
                    body.dark-mode .mermaid-diagram svg ellipse {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .edgePath .path {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 时间线图样式 */
                    .mermaid-diagram svg .section0,
                    .mermaid-diagram svg .section1,
                    .mermaid-diagram svg .section2 {
                        fill: #333333 !important;
                        stroke: #333333 !important;
                    }
                    
                    .mermaid-diagram svg .cScale0,
                    .mermaid-diagram svg .cScale1,
                    .mermaid-diagram svg .cScale2 {
                        fill: #000000 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .section0,
                    body.dark-mode .mermaid-diagram svg .section1,
                    body.dark-mode .mermaid-diagram svg .section2 {
                        fill: #ffffff !important;
                        stroke: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .cScale0,
                    body.dark-mode .mermaid-diagram svg .cScale1,
                    body.dark-mode .mermaid-diagram svg .cScale2 {
                        fill: #ffffff !important;
                    }
                    
                    /* Git图样式 */
                    .mermaid-diagram svg .commit-id,
                    .mermaid-diagram svg .commit-msg {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 12px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .branch-label {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .commit-id,
                    body.dark-mode .mermaid-diagram svg .commit-msg,
                    body.dark-mode .mermaid-diagram svg .branch-label {
                        fill: #ffffff !important;
                    }
                    
                    /* 饼图样式 */
                    .mermaid-diagram svg .pieTitleText {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 16px !important;
                    }
                    
                    .mermaid-diagram svg .slice {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .legend text {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .pieTitleText,
                    body.dark-mode .mermaid-diagram svg .legend text {
                        fill: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .slice {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 象限图样式 */
                    .mermaid-diagram svg .quadrant-text-0,
                    .mermaid-diagram svg .quadrant-text-1,
                    .mermaid-diagram svg .quadrant-text-2,
                    .mermaid-diagram svg .quadrant-text-3 {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .xAxisLabel,
                    .mermaid-diagram svg .yAxisLabel {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .quadrant-text-0,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-1,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-2,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-3,
                    body.dark-mode .mermaid-diagram svg .xAxisLabel,
                    body.dark-mode .mermaid-diagram svg .yAxisLabel {
                        fill: #ffffff !important;
                    }
                    
                    /* 旅程图样式 */
                    .mermaid-diagram svg .journey-section-text {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 14px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .task-text {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .task-score-text {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .journey-section-text,
                    body.dark-mode .mermaid-diagram svg .task-text,
                    body.dark-mode .mermaid-diagram svg .task-score-text {
                        fill: #ffffff !important;
                    }
                    
                    /* 需求图样式 */
                    .mermaid-diagram svg .requirement,
                    .mermaid-diagram svg .requirementText {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .element {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .requirement,
                    body.dark-mode .mermaid-diagram svg .requirementText {
                        fill: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .element {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 思维导图样式 */
                    .mermaid-diagram svg .mindmap-node {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .mindmap-label {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 13px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .mindmap-node {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .mindmap-label {
                        fill: #ffffff !important;
                    }
                    
                    /* 全局增强所有Mermaid图表的文本对比度 */
                    .mermaid-diagram svg * {
                        font-weight: 700 !important;
                    }
                    
                    .mermaid-diagram svg tspan {
                        font-weight: 700 !important;
                        fill: #000000 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg tspan {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    /* 甘特图移动端优化 */
                    .mermaid-diagram svg .taskText {
                        font-size: 13px !important;
                        font-weight: 600 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    .mermaid-diagram svg .sectionTitle {
                        font-size: 15px !important;
                        font-weight: 700 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .today {
                        fill: #ef4444 !important;
                        stroke: #dc2626 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .done0,
                    .mermaid-diagram svg .done1,
                    .mermaid-diagram svg .done2,
                    .mermaid-diagram svg .done3 {
                        fill: #10b981 !important;
                        stroke: #059669 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .active0,
                    .mermaid-diagram svg .active1,
                    .mermaid-diagram svg .active2,
                    .mermaid-diagram svg .active3 {
                        fill: #f59e0b !important;
                        stroke: #d97706 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .crit0,
                    .mermaid-diagram svg .crit1,
                    .mermaid-diagram svg .crit2,
                    .mermaid-diagram svg .crit3 {
                        fill: #ef4444 !important;
                        stroke: #dc2626 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .task {
                        fill: #6b7280 !important;
                        stroke: #4b5563 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .taskTextOutside {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #374151 !important;
                    }
                    
                    .mermaid-diagram svg .grid .tick text {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #4b5563 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .taskText,
                    body.dark-mode .mermaid-diagram svg .sectionTitle {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .taskTextOutside,
                    body.dark-mode .mermaid-diagram svg .grid .tick text {
                        fill: #e5e7eb !important;
                    }
                    
                    /* 实体关系图移动端优化 */
                    .mermaid-diagram svg .entity {
                        fill: #f8f9fa !important;
                        stroke: #374151 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .entityLabel {
                        font-size: 14px !important;
                        font-weight: 700 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    .mermaid-diagram svg .attributeBoxOdd,
                    .mermaid-diagram svg .attributeBoxEven {
                        fill: #ffffff !important;
                        stroke: #d1d5db !important;
                        stroke-width: 1px !important;
                    }
                    
                    .mermaid-diagram svg .attributeBoxOdd text,
                    .mermaid-diagram svg .attributeBoxEven text {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #374151 !important;
                    }
                    
                    .mermaid-diagram svg .relationshipLine {
                        stroke: #374151 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .relationshipLabel {
                        font-size: 11px !important;
                        font-weight: 600 !important;
                        fill: #6b7280 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .entity {
                        fill: #374151 !important;
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .entityLabel {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .attributeBoxOdd,
                    body.dark-mode .mermaid-diagram svg .attributeBoxEven {
                        fill: #4b5563 !important;
                        stroke: #6b7280 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .attributeBoxOdd text,
                    body.dark-mode .mermaid-diagram svg .attributeBoxEven text {
                        fill: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .relationshipLine {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .relationshipLabel {
                        fill: #d1d5db !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    /* 移动端响应式优化 */
                    @media (max-width: 768px) {
                        .mermaid-diagram svg {
                            max-width: 100% !important;
                            height: auto !important;
                            transform-origin: top left !important;
                        }
                        
                        /* 甘特图移动端缩放 */
                        .mermaid-diagram svg[viewBox*="gantt"] {
                            transform: scale(0.8) !important;
                            transform-origin: top left !important;
                        }
                        
                        /* 实体关系图移动端缩放 */
                        .mermaid-diagram svg[viewBox*="er"] {
                            transform: scale(0.9) !important;
                            transform-origin: top left !important;
                        }
                        
                        .mermaid-diagram svg .taskText {
                            font-size: 12px !important;
                        }
                        
                        .mermaid-diagram svg .sectionTitle {
                            font-size: 14px !important;
                        }
                        
                        .mermaid-diagram svg .entityLabel {
                            font-size: 13px !important;
                        }
                        
                        .mermaid-diagram svg .attributeBoxOdd text,
                        .mermaid-diagram svg .attributeBoxEven text {
                            font-size: 11px !important;
                        }
                        
                        .mermaid-diagram svg .relationshipLabel {
                            font-size: 10px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        /* 超小屏幕进一步缩放 */
                        .mermaid-diagram svg[viewBox*="gantt"] {
                            transform: scale(0.7) !important;
                        }
                        
                        .mermaid-diagram svg[viewBox*="er"] {
                            transform: scale(0.8) !important;
                        }
                        
                        .mermaid-diagram svg .taskText {
                            font-size: 11px !important;
                        }
                        
                        .mermaid-diagram svg .sectionTitle {
                            font-size: 13px !important;
                        }
                        
                        .mermaid-diagram svg .entityLabel {
                            font-size: 12px !important;
                        }
                        
                        .mermaid-diagram svg .attributeBoxOdd text,
                        .mermaid-diagram svg .attributeBoxEven text {
                            font-size: 10px !important;
                        }
                        
                        .mermaid-diagram svg .relationshipLabel {
                            font-size: 9px !important;
                        }
                    }
                    
                    /* 自定义classDef样式支持 */
                    /* 系统架构流程图样式 */
                    .mermaid-diagram svg .startEnd {
                        fill: #e1f5fe !important;
                        stroke: #01579b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .process {
                        fill: #f3e5f5 !important;
                        stroke: #4a148c !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .engine {
                        fill: #fff3e0 !important;
                        stroke: #e65100 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .feature {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 应用状态转换图样式 */
                    .mermaid-diagram svg .activeState {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .errorState {
                        fill: #ffebee !important;
                        stroke: #c62828 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .processState {
                        fill: #fff3e0 !important;
                        stroke: #ef6c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .interactState {
                        fill: #e3f2fd !important;
                        stroke: #1565c0 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 功能优先级分布图样式 */
                    .mermaid-diagram svg .coreFeatures {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .importantFeatures {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .supportFeatures {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .optionalFeatures {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 类图样式 */
                    .mermaid-diagram svg .renderer {
                        fill: #e1f5fe !important;
                        stroke: #01579b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .manager {
                        fill: #f3e5f5 !important;
                        stroke: #4a148c !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .handler {
                        fill: #fff3e0 !important;
                        stroke: #e65100 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 开发时间线图样式 */
                    .mermaid-diagram svg .milestone {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 3px !important;
                    }
                    
                    .mermaid-diagram svg .optimization {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .release {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 系统需求关系图样式 */
                    .mermaid-diagram svg .requirement {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .lowRisk {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .mediumRisk {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .highRisk {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .component {
                        fill: #f3e5f5 !important;
                        stroke: #7b1fa2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 系统架构图样式 */
                    .mermaid-diagram svg .root {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 3px !important;
                    }
                    
                    .mermaid-diagram svg .category {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .module {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 深色模式下的自定义classDef样式 */
                    body.dark-mode .mermaid-diagram svg .startEnd,
                    body.dark-mode .mermaid-diagram svg .process,
                    body.dark-mode .mermaid-diagram svg .engine,
                    body.dark-mode .mermaid-diagram svg .feature,
                    body.dark-mode .mermaid-diagram svg .activeState,
                    body.dark-mode .mermaid-diagram svg .errorState,
                    body.dark-mode .mermaid-diagram svg .processState,
                    body.dark-mode .mermaid-diagram svg .interactState,
                    body.dark-mode .mermaid-diagram svg .coreFeatures,
                    body.dark-mode .mermaid-diagram svg .importantFeatures,
                    body.dark-mode .mermaid-diagram svg .supportFeatures,
                    body.dark-mode .mermaid-diagram svg .optionalFeatures,
                    body.dark-mode .mermaid-diagram svg .renderer,
                    body.dark-mode .mermaid-diagram svg .manager,
                    body.dark-mode .mermaid-diagram svg .handler,
                    body.dark-mode .mermaid-diagram svg .milestone,
                    body.dark-mode .mermaid-diagram svg .optimization,
                    body.dark-mode .mermaid-diagram svg .release,
                    body.dark-mode .mermaid-diagram svg .requirement,
                    body.dark-mode .mermaid-diagram svg .lowRisk,
                    body.dark-mode .mermaid-diagram svg .mediumRisk,
                    body.dark-mode .mermaid-diagram svg .highRisk,
                    body.dark-mode .mermaid-diagram svg .component,
                    body.dark-mode .mermaid-diagram svg .root,
                    body.dark-mode .mermaid-diagram svg .category,
                    body.dark-mode .mermaid-diagram svg .module {
                        opacity: 0.8;
                        filter: brightness(1.2);
                    }

                    /* 移动端Mermaid图表优化 */
                    @media (max-width: 768px) {
                        .mermaid-diagram {
                            padding: 10px !important;
                            margin: 10px 0 !important;
                        }
                        
                        .mermaid-diagram svg {
                            touch-action: pan-x pan-y;
                        }
                    }
                </style>
            </head>
    <body>
        
        <!-- 目录面板背景遮罩 -->
        <div id="toc-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.3); z-index: 997; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;"></div>
        
        <!-- 目录面板 -->
        <div id="toc-panel" style="width: 280px; background-color: #f6f8fa; border-right: 1px solid #d0d7de; position: fixed; top: 0; left: -280px; height: 100vh; height: 100dvh; overflow-y: auto; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 998; box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1); will-change: transform;">
            <div style="padding: 20px; padding-top: 60px; border-bottom: 1px solid #d0d7de;">
                <h3 style="font-size: 16px; font-weight: 600; margin: 0;">目录</h3>
            </div>
            <div style="padding: 20px;">
                <ul id="toc-list" style="list-style: none; padding: 0; margin: 0;">
                    <!-- 目录将自动生成 -->
                </ul>
            </div>
        </div>
        
        <div id="rendered-content"></div>
        
        <script>
            
            // 简化的性能监控
            function initPerformanceOptimizations() {
                console.log('🚀 初始化性能优化...');
                
                // 检测GPU加速支持
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (gl) {
                    console.log('✅ GPU加速支持已启用');
                    const renderer = gl.getParameter(gl.RENDERER);
                    const vendor = gl.getParameter(gl.VENDOR);
                    console.log(`📱 GPU信息: ${vendor} ${renderer}`);
                }
                
                // 简化的性能计时器
                window.startRenderingTimer = function() {
                    window._renderingStartTime = performance.now();
                };
                
                window.endRenderingTimer = function(operation) {
                    if (window._renderingStartTime) {
                        const duration = performance.now() - window._renderingStartTime;
                    console.log(`⏱️ ${operation} 耗时: ${duration.toFixed(2)}ms`);
                    }
                };
            }
            
            // 初始化简化的优化
            window.addEventListener('load', () => {
                initPerformanceOptimizations();
            });
            
            // 简单的Markdown解析器（降级方案）
            function initSimpleMarkdownParser() {
                window.simpleMarkdown = {
                    parse: function(text) {
                        if (!text) return '';
                        
                        // 基础HTML转义
                        function escapeHtml(unsafe) {
                            return unsafe
                                .replace(/&/g, "&amp;")
                                .replace(/</g, "&lt;")
                                .replace(/>/g, "&gt;")
                                .replace(/"/g, "&quot;")
                                .replace(/'/g, "&#039;");
                        }
                        
                        // 处理标题
                        text = text.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
                        text = text.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
                        text = text.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
                        
                        // 处理粗体和斜体
                        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        
                        // 处理代码块
                        text = text.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');
                        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                        
                        // 处理链接
                        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                        
                        // 处理列表
                        text = text.replace(/^- (.*?)$/gm, '<li>$1</li>');
                        text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                        
                        // 处理段落
                        text = text.replace(/\n\n/g, '</p><p>');
                        text = '<p>' + text + '</p>';
                        
                        // 清理空段落
                        text = text.replace(/<p><\/p>/g, '');
                        
                        return text;
                    }
                };
                console.log('✅ 简单Markdown解析器已初始化');
            }
            
            // 配置 Marked.js - 兼容现代版本和iOS WebView
            function configureMarked() {
                if (typeof marked === 'undefined') {
                    console.warn('⚠️ marked.js未加载，跳过配置');
                    return;
                }
                
                try {
                    marked.setOptions({
                        breaks: true,        // 支持换行
                        tables: true,        // 支持表格
                        gfm: true,          // 支持GitHub Flavored Markdown
                        headerIds: true,     // 生成标题ID
                        smartLists: true,    // 智能列表
                        smartypants: true,   // 智能标点
                        xhtml: true,         // XHTML兼容
                        mangle: false,       // 禁用邮箱混淆
                        // 移除sanitize选项，使用renderer自定义HTML处理
                    });
                    
                    // 自定义HTML渲染器 - 确保HTML内容被正确解析
                    const renderer = new marked.Renderer();
                    
                    // 保留原始HTML渲染方法
                    const originalHtml = renderer.html;
                    renderer.html = function(html) {
                        // 确保html是字符串类型
                        if (typeof html !== 'string') {
                            return originalHtml ? originalHtml.call(this, html) : '';
                        }
                        // 直接返回HTML内容，不进行转义
                        return html;
                    };
                    
                    // 简化渲染器，专注于LaTeX和基本HTML标签
                    const originalParagraph = renderer.paragraph;
                    renderer.paragraph = function(text) {
                        // 确保text是字符串类型
                        if (typeof text !== 'string') {
                            return originalParagraph.call(this, text);
                        }
                        
                        // 检查是否包含LaTeX公式，如果有则保持原始渲染
                        if (text.includes('$') || text.includes('\\(') || text.includes('\\[') || text.includes('\\begin{')) {
                            // 包含LaTeX公式，使用默认段落渲染以确保MathJax正常处理
                            return originalParagraph.call(this, text);
                        }
                        
                        // 否则使用默认的段落渲染
                        return originalParagraph.call(this, text);
                    };
                    
                    // 应用自定义渲染器
                    marked.setOptions({
                        renderer: renderer
                    });
                    
                    console.log('✅ Marked.js配置完成');
                } catch (error) {
                    console.error('❌ Marked.js配置失败:', error);
                }
            }
            
            var text = "";
            
            // 安全的Markdown解析函数
            function safeMarkdownParse(content) {
                if (!content) return '';
                
                // 检查marked.js是否可用
                if (typeof marked !== 'undefined' && marked.parse) {
                    try {
                        return marked.parse(content);
                    } catch (error) {
                        console.error('❌ marked.parse()失败:', error);
                        console.log('🔄 使用简单解析器降级');
                        return fallbackMarkdownParse(content);
                    }
                } else {
                    console.warn('⚠️ marked.js不可用，使用简单解析器');
                    return fallbackMarkdownParse(content);
                }
            }
            
            // 降级Markdown解析函数
            function fallbackMarkdownParse(content) {
                if (window.simpleMarkdown && window.simpleMarkdown.parse) {
                    return window.simpleMarkdown.parse(content);
                } else {
                    // 最基础的降级方案
                    console.warn('⚠️ 简单解析器也不可用，使用最基础方案');
                    return '<pre style="white-space: pre-wrap; font-family: inherit;">' + 
                           content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                           '</pre>';
                }
            }
            
            // 初始化 Mermaid
            function initMermaid() {
                if (typeof mermaid !== 'undefined') {
                    console.log('🎨 初始化Mermaid图表渲染器');
                    
                    // 检查当前主题
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      (!document.body.classList.contains('light-mode') && 
                                       window.matchMedia('(prefers-color-scheme: dark)').matches);
                    
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: isDarkMode ? 'dark' : 'base',
                        securityLevel: 'loose',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        fontSize: 16,
                        flowchart: {
                            htmlLabels: true,
                            curve: 'basis',
                            padding: 15
                        },
                        sequence: {
                            diagramMarginX: 30,
                            diagramMarginY: 30,
                            actorMargin: 50,
                            width: 150,
                            height: 65,
                            boxMargin: 10,
                            boxTextMargin: 8,
                            noteMargin: 15,
                            messageMargin: 40
                        },
                        gantt: {
                            leftPadding: 60,
                            gridLineStartPadding: 30,
                            fontSize: 12,
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            sectionFontSize: 14,
                            axisFormat: '%m月',
                            barHeight: 20,
                            rightPadding: 20,
                            topPadding: 50,
                            bottomPadding: 50,
                            numberSectionStyles: 3,
                            useWidth: 800
                        },
                        class: {
                            titleTopMargin: 25
                        },
                        state: {
                            titleTopMargin: 25
                        },
                        er: {
                            diagramPadding: 15,
                            layoutDirection: 'TB',
                            minEntityWidth: 120,
                            minEntityHeight: 80,
                            entityPadding: 12,
                            stroke: '#333333',
                            fill: '#f8f9fa',
                            fontSize: 13,
                            useMaxWidth: true,
                            alignment: 'center'
                        }
                    });
                    
                    console.log('✅ Mermaid初始化完成，主题:', isDarkMode ? 'dark' : 'default');
                } else {
                    console.warn('⚠️ Mermaid未加载');
                }
            }
            
            // 原生应用通信桥梁
            class NativeBridge {
                constructor() {
                    this.isNativeEnvironment = this.detectNativeEnvironment();
                    this.setupMessageHandlers();
                    this.setupNativePrint();
                }
                
                detectNativeEnvironment() {
                    // 检测是否在原生WebView环境中
                    return window.webkit && window.webkit.messageHandlers;
                }
                
                setupNativePrint() {
                    // 设置原生打印函数
                    if (this.isNativeEnvironment && window.webkit.messageHandlers.nativePrint) {
                        window.nativePrint = function(message) {
                            try {
                                // 如果消息是对象，将其转换为字符串
                                let logMessage = message;
                                if (typeof message === 'object' && message !== null) {
                                    logMessage = JSON.stringify(message, null, 2);
                                } else if (typeof message === 'undefined') {
                                    logMessage = 'undefined';
                                } else if (message === null) {
                                    logMessage = 'null';
                                } else {
                                    logMessage = String(message);
                                }
                                
                                // 发送到原生代码
                                window.webkit.messageHandlers.nativePrint.postMessage(logMessage);
                            } catch (error) {
                                console.error('原生打印失败:', error);
                            }
                        };
                        
                        // 也可以直接覆盖console.log（可选）
                        const originalConsoleLog = console.log;
                        console.log = function(...args) {
                            // 保持原有的console.log功能
                            originalConsoleLog.apply(console, args);
                            
                            // 同时发送到原生代码
                            const message = args.map(arg => {
                                if (typeof arg === 'object' && arg !== null) {
                                    return JSON.stringify(arg, null, 2);
                                }
                                return String(arg);
                            }).join(' ');
                            
                            window.nativePrint(message);
                        };
                        
                        console.log('✅ 原生打印功能已启用');
                        
                        // 测试原生打印功能
                        setTimeout(() => {
                            window.nativePrint('🔧 原生打印功能测试 - 这条消息应该出现在Xcode控制台');
                            window.nativePrint({
                                test: '对象测试',
                                timestamp: new Date().toISOString(),
                                type: 'native_print_test'
                            });
                        }, 1000);
                    } else {
                        // 如果不在原生环境中，nativePrint回退到console.log
                        window.nativePrint = function(message) {
                            console.log(message);
                        };
                    }
                }
                
                setupMessageHandlers() {
                    // 监听来自原生应用的消息
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'themeChanged') {
                            this.handleNativeThemeChange(event.data.theme);
                        }
                    });
                    
                    // 暴露给原生调用的全局函数
                    window.handleNativeThemeChange = (theme) => {
                        this.handleNativeThemeChange(theme);
                    };
                }
                
                handleNativeThemeChange(theme) {
                    console.log('🔄 原生应用主题变化:', theme);
                    if (window.themeManager) {
                        // 在原生环境中，强制设置主题（即使是首次初始化）
                        const isFirstTimeSetup = window.themeManager.currentTheme === null;
                        
                        // 更新所有现有的复制按钮样式
                        this.updateCopyButtonsTheme(theme);
                        window.themeManager.setTheme(theme, false); // 不通知原生，避免循环
                        if (isFirstTimeSetup) {
                            console.log('🎨 WebView首次主题初始化完成:', theme);
                        }
                    }
                }
                
                // 更新所有复制按钮的主题样式
                updateCopyButtonsTheme(theme) {
                    const copyButtons = document.querySelectorAll('.code-copy-btn');
                    console.log(`🎨 更新 ${copyButtons.length} 个复制按钮的主题样式: ${theme}`);
                    
                    copyButtons.forEach(button => {
                        // 清除内联样式，让CSS接管
                        if (typeof clearCopyButtonInlineStyles === 'function') {
                            clearCopyButtonInlineStyles(button);
                        } else {
                            // 备用方案：直接根据主题设置强化样式
                            if (theme === 'dark') {
                                button.style.backgroundColor = '#2d3748';
                                button.style.borderColor = '#4a5568';
                                button.style.color = '#a0aec0';
                                button.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                            } else {
                                button.style.backgroundColor = '';
                                button.style.borderColor = '';
                                button.style.color = '';
                                button.style.boxShadow = '';
                            }
                        }
                    });
                }
                
                notifyNativeThemeChange(theme) {
                    if (!this.isNativeEnvironment) return;
                    
                    try {
                        // iOS WebKit消息传递
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.themeHandler) {
                            window.webkit.messageHandlers.themeHandler.postMessage({
                                type: 'themeChanged',
                                theme: theme
                            });
                        }
                        
                        // Android WebView JavascriptInterface
                        if (window.AndroidInterface && window.AndroidInterface.onThemeChanged) {
                            window.AndroidInterface.onThemeChanged(theme);
                        }
                        
                        console.log('📱 已通知原生应用主题变化:', theme);
                    } catch (error) {
                        console.log('⚠️ 通知原生应用失败:', error);
                    }
                }
            }
            
            // 主题管理 - 增强版
            class ThemeManager {
                constructor() {
                    this.nativeBridge = new NativeBridge();
                    this.init();
                }
                
                init() {
                    // 在原生环境中，不要立即设置主题，等待原生应用同步主题
                    if (this.nativeBridge && this.nativeBridge.isNativeEnvironment) {
                        console.log('🎨 原生环境中，等待主题同步...');
                        // 原生环境中不设置默认主题，完全等待原生同步
                        this.currentTheme = null; // 标记为未初始化状态
                    } else {
                        // 非原生环境，使用本地存储或系统主题
                    const savedTheme = localStorage.getItem('theme');
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    
                    if (savedTheme) {
                            this.setTheme(savedTheme, false);
                    } else if (systemPrefersDark) {
                            this.setTheme('dark', false);
                    } else {
                            this.setTheme('light', false);
                        }
                    }
                    
                    // 主题切换按钮已移除，只保留原生应用控制
                    
                    // 监听系统主题变化
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light', true);
                        }
                    });
                }
                
                setInitialTheme() {
                    // 设置一个临时的默认主题，不保存到localStorage
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const defaultTheme = systemPrefersDark ? 'dark' : 'light';
                    
                    const body = document.body;
                    
                    // 移除所有主题类
                    body.classList.remove('dark-mode', 'light-mode');
                    
                    if (defaultTheme === 'dark') {
                        body.classList.add('dark-mode');
                    } else {
                        body.classList.add('light-mode');
                    }
                    
                    this.currentTheme = defaultTheme;
                    console.log('🎨 临时主题设置:', defaultTheme);
                }
                
                setTheme(theme, notifyNative = true) {
                    const body = document.body;
                    
                    // 移除所有主题类
                    body.classList.remove('dark-mode', 'light-mode');
                    
                    if (theme === 'dark') {
                        body.classList.add('dark-mode');
                    } else {
                        body.classList.add('light-mode');
                    }
                    
                    // 只在非原生环境中保存到本地存储
                    if (!this.nativeBridge || !this.nativeBridge.isNativeEnvironment) {
                    localStorage.setItem('theme', theme);
                    }
                    
                    this.currentTheme = theme;
                    
                    // 更新复制按钮样式
                    if (this.nativeBridge && typeof this.nativeBridge.updateCopyButtonsTheme === 'function') {
                        this.nativeBridge.updateCopyButtonsTheme(theme);
                    }
                    
                    // 通知原生应用主题变化
                    if (notifyNative && this.nativeBridge) {
                        this.nativeBridge.notifyNativeThemeChange(theme);
                    }
                    
                    console.log('🎨 主题已切换到:', theme, notifyNative ? '(已通知原生)' : '(未通知原生)');
                }
                
                toggleTheme() {
                    const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                    this.setTheme(newTheme, true); // 用户手动切换时通知原生
                    
                    // 重新初始化Mermaid以应用新主题
                    initMermaid();
                    
                    // 重新渲染所有Mermaid图表
                    renderMermaidDiagrams(document.getElementById('rendered-content'));
                }
                
                getCurrentTheme() {
                    return this.currentTheme;
                }
            }
            
            // 初始化主题管理器
            const themeManager = new ThemeManager();
            
            // 暴露给全局作用域，方便原生调用
            window.themeManager = themeManager;
            
            // 移动端Mermaid图表响应式优化
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const mermaidDiagrams = document.querySelectorAll('.mermaid-diagram svg');
                    mermaidDiagrams.forEach(svg => {
                        const chartType = svg.getAttribute('data-chart-type');
                        
                        if (chartType === 'gantt') {
                            // 重新优化甘特图
                            if (window.innerWidth <= 768) {
                                const tasks = svg.querySelectorAll('.taskText, .sectionTitle');
                                tasks.forEach(task => {
                                    task.style.fontSize = window.innerWidth <= 480 ? '11px' : '12px';
                                });
                                
                                const axisLabels = svg.querySelectorAll('.grid .tick text');
                                axisLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                });
                            }
                        } else if (chartType === 'er') {
                            // 重新优化实体关系图
                            if (window.innerWidth <= 768) {
                                const entityLabels = svg.querySelectorAll('.entityLabel');
                                entityLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '12px' : '13px';
                                });
                                
                                const attributeTexts = svg.querySelectorAll('.attributeBoxOdd text, .attributeBoxEven text');
                                attributeTexts.forEach(text => {
                                    text.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                });
                                
                                const relationLabels = svg.querySelectorAll('.relationshipLabel');
                                relationLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '9px' : '10px';
                                });
                            }
                        }
                    });
                    
                    console.log('📱 移动端Mermaid图表响应式优化完成');
                }, 300);
            });
            
            // 目录管理
            let tocOpen = false;
            
            // 初始化目录功能（简化版本，只处理面板逻辑）
            function initTOC() {
                const tocPanel = document.getElementById('toc-panel');
                const tocOverlay = document.getElementById('toc-overlay');
                
                // 切换目录显示
                function toggleTOC() {
                    tocOpen = !tocOpen;
                    if (tocOpen) {
                        tocPanel.classList.add('open');
                        tocOverlay.classList.add('open');
                    } else {
                        tocPanel.classList.remove('open');
                        tocOverlay.classList.remove('open');
                    }
                }
                
                // 暴露函数到全局作用域供原生代码调用
                window.toggleTOC = toggleTOC;
                
                // 暴露强制重新生成目录功能
                window.forceRegenerateTOC = function() {
                    console.log('🔧 手动强制重新生成目录');
                    const tocList = document.getElementById('toc-list');
                    if (tocList) {
                        tocList.removeAttribute('data-toc-generated');
                    }
                    generateTOC(true);
                };
                
                // 关闭目录
                function closeTOC() {
                    if (tocOpen) {
                        tocOpen = false;
                        tocPanel.classList.remove('open');
                        tocOverlay.classList.remove('open');
                    }
                }
                
                // 点击遮罩层关闭目录
                if (tocOverlay) {
                tocOverlay.addEventListener('click', closeTOC);
                tocOverlay.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    closeTOC();
                });
                }
                
                // 点击面板外区域关闭目录（支持触摸）
                function handleOutsideClick(e) {
                    if (tocOpen && !e.target.closest('#toc-panel') && !e.target.closest('#toc-overlay')) {
                        closeTOC();
                    }
                }
                
                document.addEventListener('click', handleOutsideClick);
                document.addEventListener('touchend', handleOutsideClick);
                
                // 暴露关闭函数供目录链接使用
                window.closeTOC = closeTOC;
                

            }
            
            // 生成目录 - 增强版本，支持复杂文档结构  
            function generateTOC(forceRegenerate = false) {
                console.log('🔍 开始生成目录...', forceRegenerate ? '(强制重新生成)' : '');
                
                // 调试：检查关键元素是否存在
                const renderedContent = document.getElementById('rendered-content');
                const tocList = document.getElementById('toc-list');
                const tocPanel = document.getElementById('toc-panel');
                
                // 防重复生成检查
                if (!forceRegenerate && tocList && tocList.getAttribute('data-toc-generated') === 'true') {
                    console.log('✅ 目录已生成，跳过重复生成');
                    
                    // 检查是否有内容
                    const hasContent = tocList.children.length > 0 && 
                                     !tocList.innerHTML.includes('无标题');
                    
                    if (hasContent) {
                        // 重新通知原生代码（可能之前通知丢失了）
                        notifyTOCCompletion(true, tocList.children.length);
                    }
                    
                    return;
                }
                
                console.log('🔍 调试检查:');
                console.log('  - rendered-content元素:', renderedContent ? '存在' : '❌不存在');
                console.log('  - toc-list元素:', tocList ? '存在' : '❌不存在');
                console.log('  - toc-panel元素:', tocPanel ? '存在' : '❌不存在');
                
                if (!tocList) {
                    console.error('❌ toc-list元素不存在！无法生成目录');
                    return;
                }
                
                // 强化标题检测：支持复杂文档结构
                let headers = getValidHeaders();
                
                function getValidHeaders() {
                    const chunkContainer = document.getElementById('chunk-container');
                    let candidateHeaders = [];
                    
                    if (chunkContainer && window.isChunkRenderingActive === false) {
                        // 分块渲染完成后，从chunk-container中查找标题
                        console.log('🧩 分块渲染模式：从chunk-container查找标题');
                        candidateHeaders = Array.from(chunkContainer.querySelectorAll('h1, h2, h3, h4, h5, h6'));
                    } else {
                        // 普通渲染模式：从rendered-content查找标题
                        console.log('📄 普通渲染模式：从rendered-content查找标题');
                        candidateHeaders = Array.from(document.querySelectorAll('#rendered-content h1, #rendered-content h2, #rendered-content h3, #rendered-content h4, #rendered-content h5, #rendered-content h6'));
                    }
                    
                    // 过滤无效标题：排除明显的干扰内容，但保持宽松
                    const validHeaders = candidateHeaders.filter(header => {
                        const text = header.textContent.trim();
                        
                        // 排除空标题
                        if (!text) return false;
                        
                        // 排除太短的标题（可能是格式问题）
                        if (text.length < 1) return false;
                        
                        // 更智能的伪标题检测：只过滤明确在链接内的标题
                        const parent = header.parentElement;
                        if (parent) {
                            // 只排除直接在链接标签内的标题（这种情况几乎不会出现）
                            if (parent.tagName === 'A') {
                                console.log(`🔍 跳过链接内标题: "${text}"`);
                                return false;
                            }
                        }
                        
                        // 接受所有其他标题，包括在列表中的标题
                        return true;
                    });
                    
                    console.log(`🔍 过滤前候选标题: ${candidateHeaders.length}个`);
                    console.log(`🔍 过滤后有效标题: ${validHeaders.length}个`);
                    
                    return validHeaders;
                }
                
                console.log(`📊 检测到 ${headers.length} 个标题元素`);
                if (headers.length > 0) {
                    headers.forEach((header, index) => {
                        console.log(`📝 标题 ${index + 1}: ${header.tagName} - ${header.textContent}`);
                    });
                    console.log(`✅ 将生成${headers.length}个目录项`);
                } else {
                    // 调试：如果没有标题，检查rendered-content的内容
                    if (renderedContent) {
                        console.log('📄 rendered-content内容长度:', renderedContent.innerHTML.length);
                        console.log('📄 rendered-content前200字符:', renderedContent.innerHTML.substring(0, 200));
                        
                        // 检查是否有任何标题元素，不限于rendered-content
                        const allHeaders = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
                        console.log(`📊 页面中所有标题元素: ${allHeaders.length}`);
                        if (allHeaders.length > 0) {
                            allHeaders.forEach((header, index) => {
                                console.log(`📝 全局标题 ${index + 1}: ${header.tagName} - ${header.textContent} (父元素: ${header.parentElement?.id || header.parentElement?.className || 'no-id-class'})`);
                            });
                        }
                    }
                }
                
                if (headers.length === 0) {
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const noTitleColor = isDarkMode ? '#666' : '#1a1a1a';
                    tocList.innerHTML = `<li style="color: ${noTitleColor}; padding: 12px; text-align: center;">无标题</li>`;
                    console.log('ℹ️ 未找到标题，显示"无标题"');
                    
                    // 通知原生代码没有标题
                    notifyTOCCompletion(false, 0);
                    return;
                }
                
                // 清空目录并移除之前的事件监听器
                tocList.innerHTML = '';
                
                // 防重复标记
                tocList.setAttribute('data-toc-generated', 'true');
                
                // 使用事件委托而不是为每个链接添加监听器
                const handleTocClick = (e) => {
                    const link = e.target.closest('a[data-target]');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.getAttribute('data-target');
                        const element = document.getElementById(targetId);
                        if (element) {

                            
                            // 使用requestAnimationFrame确保平滑滚动
                            const scrollToElement = () => {
                                try {
                                    element.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案：直接滚动
                                    element.scrollIntoView();
                                }
                            };
                            
                            requestAnimationFrame(scrollToElement);
                            
                            // 直接测试目录关闭功能
                            console.log('📱 目录项被点击，准备关闭目录');
                            
                            // 立即尝试关闭（测试基本功能）
                            if (window.closeTOC) {
                                console.log('✅ 找到 window.closeTOC，立即关闭目录');
                                window.closeTOC();
                            } else if (typeof closeTOC === 'function') {
                                console.log('✅ 找到 closeTOC，立即关闭目录');
                                closeTOC();
                            } else {
                                console.error('❌ 无法找到 closeTOC 函数');
                            }
                        }
                    }
                };
                
                // 智能等待滚动完成的函数
                function waitForScrollToComplete(callback) {
                    let scrollTimer;
                    let isScrolling = false;
                    
                    const checkScrollEnd = () => {
                        if (!isScrolling) {
                            isScrolling = true;
                        }
                        
                        // 清除之前的计时器
                        clearTimeout(scrollTimer);
                        
                        // 设置新的计时器：如果150ms内没有新的滚动事件，则认为滚动结束
                        scrollTimer = setTimeout(() => {
                            isScrolling = false;
                            // 移除滚动监听器
                            window.removeEventListener('scroll', checkScrollEnd);
                            document.removeEventListener('scroll', checkScrollEnd);
                            
                            // 额外延迟200ms确保滚动完全停止
                            setTimeout(callback, 200);
                        }, 150);
                    };
                    
                    // 监听窗口和文档的滚动事件
                    window.addEventListener('scroll', checkScrollEnd);
                    document.addEventListener('scroll', checkScrollEnd);
                    
                    // 设置最大等待时间（2秒），防止某些情况下无法检测到滚动结束
                    setTimeout(() => {
                        if (isScrolling) {
                            window.removeEventListener('scroll', checkScrollEnd);
                            document.removeEventListener('scroll', checkScrollEnd);
                            callback();
                        }
                    }, 2000);
                }
                
                // 移除旧的事件监听器并添加新的
                tocList.removeEventListener('click', handleTocClick);
                tocList.addEventListener('click', handleTocClick);
                
                // 生成目录项
                headers.forEach((header, index) => {
                    const level = parseInt(header.tagName.substring(1));
                    const text = header.textContent.trim();
                    
                    // 为标题添加ID（如果没有的话）
                    if (!header.id) {
                        header.id = `heading-${index}`;
                    }
                    
                    const listItem = document.createElement('li');
                    listItem.style.margin = '4px 0';
                    
                    const link = document.createElement('a');
                    link.href = `#${header.id}`;
                    link.setAttribute('data-target', header.id);
                    link.textContent = text;
                    
                    // 根据主题设置样式
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const textColor = isDarkMode ? '#c9d1d9' : '#1a1a1a';
                    
                    link.style.cssText = `
                        display: block;
                        padding: 6px 12px;
                        color: ${textColor};
                        text-decoration: none;
                        border-radius: 4px;
                        transition: background-color 0.2s ease;
                        font-size: 14px;
                        padding-left: ${12 + (level - 1) * 12}px;
                        ${level === 1 ? 'font-weight: 600;' : ''}
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                    `;
                    
                    // 使用CSS hover而不是JavaScript事件以提升性能
                    link.className = 'toc-link';
                    
                    listItem.appendChild(link);
                    tocList.appendChild(listItem);
                });
                
                // 通知原生代码目录生成完成
                console.log('✅ 目录生成完成，共生成', headers.length, '个目录项');
                notifyTOCCompletion(true, headers.length);
            }
            
            // 通知原生代码目录生成完成
            function notifyTOCCompletion(hasHeaders, count) {
                console.log('📢 通知原生代码：目录生成完成', { hasHeaders, count });
                
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tocGenerationComplete) {
                    try {
                        window.webkit.messageHandlers.tocGenerationComplete.postMessage({
                            type: 'TOC_GENERATION_COMPLETED',
                            hasHeaders: hasHeaders,
                            count: count
                        });
                        console.log('📱 已通知原生代码：目录状态', hasHeaders ? '有内容' : '无内容');
                    } catch (error) {
                        console.warn('⚠️ 通知原生代码失败:', error);
                    }
                } else {
                    console.log('🌐 非原生环境，跳过原生通知');
                }
            }
            
            // 智能目录生成调度 - 支持复杂文档结构
            function scheduleSmartTOCGeneration() {
                console.log('🧠 启动智能目录生成调度');
                nativePrint('🧠 启动智能目录生成调度');
                
                let attempts = 0;
                const maxAttempts = 3;
                const delays = [100, 300, 800]; // 递增延迟
                
                function attemptTOCGeneration() {
                    console.log(`📋 目录生成尝试 ${attempts + 1}/${maxAttempts}`);
                    nativePrint(`📋 目录生成尝试 ${attempts + 1}/${maxAttempts}`);
                    
                    // 检查内容是否已加载
                    const renderedContent = document.getElementById('rendered-content');
                    const tocList = document.getElementById('toc-list');
                    
                    if (!renderedContent || !tocList) {
                        console.warn('❌ 关键元素缺失，跳过本次尝试');
                        scheduleNextAttempt();
                        return;
                    }
                    
                    // 检查内容是否非空
                    const contentLength = renderedContent.innerHTML.length;
                    if (contentLength < 100) {
                        console.log(`⏳ 内容还在加载中（${contentLength}字符），等待下次尝试`);
                        scheduleNextAttempt();
                        return;
                    }
                    
                    // 检查是否已生成
                    if (tocList.getAttribute('data-toc-generated') === 'true') {
                        console.log('✅ 目录已生成，调度完成');
                        return;
                    }
                    
                    // 尝试生成目录
                    try {
                        generateTOC(attempts > 0); // 第二次及以后强制重新生成
                        
                        // 检查生成结果
                        setTimeout(() => {
                            const hasContent = tocList.children.length > 0 && 
                                             !tocList.innerHTML.includes('无标题');
                            
                            if (hasContent || attempts >= maxAttempts - 1) {
                                console.log(`✅ 目录生成调度完成: ${hasContent ? '成功' : '无标题'}`);
                                nativePrint(`✅ 目录生成调度完成: ${hasContent ? '成功' : '无标题'}`);
                            } else {
                                console.log(`🔄 目录生成未成功，准备下次尝试`);
                                scheduleNextAttempt();
                            }
                        }, 50);
                        
                    } catch (error) {
                        console.error('❌ 目录生成出错:', error);
                        scheduleNextAttempt();
                    }
                }
                
                function scheduleNextAttempt() {
                    attempts++;
                    
                    if (attempts < maxAttempts) {
                        const delay = delays[attempts - 1] || 800;
                        console.log(`⏰ 安排下次目录生成尝试，延迟${delay}ms`);
                        setTimeout(attemptTOCGeneration, delay);
                    } else {
                        console.warn('⚠️ 达到最大重试次数，目录生成调度结束');
                        nativePrint('⚠️ 达到最大重试次数，目录生成调度结束');
                        
                        // 最终通知（即使没有标题）
                        const tocList = document.getElementById('toc-list');
                        if (tocList) {
                            const hasContent = tocList.children.length > 0 && 
                                             !tocList.innerHTML.includes('无标题');
                            notifyTOCCompletion(hasContent, hasContent ? tocList.children.length : 0);
                        }
                    }
                }
                
                // 开始第一次尝试
                setTimeout(attemptTOCGeneration, delays[0]);
            }
            
            // 处理链接显示和交互
            function processLinks(element) {
                const links = element.querySelectorAll('a[href]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    
                    if (!href) return;
                    
                    // 为外链添加图标标识
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        // 外链图标
                        if (!link.querySelector('.external-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'external-link-icon';
                            icon.innerHTML = ' ↗';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('mailto:')) {
                        // 邮件链接图标
                        if (!link.querySelector('.email-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'email-link-icon';
                            icon.innerHTML = ' ✉';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('tel:')) {
                        // 电话链接图标
                        if (!link.querySelector('.phone-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'phone-link-icon';
                            icon.innerHTML = ' 📞';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('#')) {
                        // 锚点链接 - 添加特殊处理确保平滑滚动
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const targetId = href.substring(1);
                            const targetElement = document.getElementById(targetId);
                            if (targetElement) {
                                try {
                                    targetElement.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案
                                    targetElement.scrollIntoView();
                                }
                            }
                        });
                    }
                });
            }
            
                                // 添加图片点击放大功能
            function addImageZoomFunction(element) {
                const images = element.querySelectorAll('img');
                console.log(`🖼️ 发现 ${images.length} 张图片`);
                
                images.forEach((img, index) => {
                    // 避免重复添加事件监听器
                    if (img.dataset.zoomEnabled) {
                        return;
                    }
                    
                    // 标记已处理
                    img.dataset.zoomEnabled = 'true';
                    
                    // 添加图片加载状态日志
                    const imgSrc = img.src;
                    const imgAlt = img.alt || `图片${index + 1}`;
                    
                    console.log(`🖼️ 处理图片 ${index + 1}: ${imgAlt}`, {
                        src: imgSrc,
                        naturalWidth: img.naturalWidth,
                        naturalHeight: img.naturalHeight,
                        complete: img.complete
                    });
                    
                    // 添加加载成功事件
                    img.addEventListener('load', function() {
                        console.log(`✅ 图片加载成功: ${imgAlt}`, {
                            src: this.src,
                            naturalWidth: this.naturalWidth,
                            naturalHeight: this.naturalHeight,
                            displayWidth: this.width,
                            displayHeight: this.height
                        });
                    });
                    
                    // 添加加载失败事件
                    img.addEventListener('error', function() {
                        console.error(`❌ 图片加载失败: ${imgAlt}`, {
                            src: this.src,
                            error: '加载失败'
                        });
                        
                        // 添加错误提示
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = `
                            border: 2px dashed #ff6b6b;
                            border-radius: 8px;
                            padding: 20px;
                            margin: 10px 0;
                            background-color: #fff5f5;
                            color: #c53030;
                            text-align: center;
                            font-size: 14px;
                        `;
                        errorDiv.innerHTML = `
                            <div style="font-weight: bold;">图片加载失败</div>
                            <div style="margin-top: 8px; font-size: 12px; word-break: break-all;">${this.src}</div>
                            <div style="margin-top: 8px; font-size: 12px;">原因：网络错误或图片不存在</div>
                        `;
                        
                        // 在图片位置显示错误信息
                        this.parentNode.replaceChild(errorDiv, this);
                    });
                    
                    // 添加点击事件
                    img.addEventListener('click', function() {
                        console.log(`🖱️ 点击图片: ${imgAlt}`);
                        showImageModal(this);
                    });
                });
            }
            
            // 显示图片放大模态框
            function showImageModal(img) {
                const imgSrc = img.src;
                const imgAlt = img.alt || '图片';
                
                console.log(`🔍 显示图片模态框: ${imgAlt}`, {
                    src: imgSrc,
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight
                });
                
                // 创建模态框
                const modal = document.createElement('div');
                modal.className = 'image-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: zoom-out;
                `;
                
                // 创建放大的图片
                const modalImg = document.createElement('img');
                modalImg.src = imgSrc;
                modalImg.alt = imgAlt;
                modalImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;
                
                // 添加模态框图片加载事件
                modalImg.addEventListener('load', function() {
                    console.log(`✅ 模态框图片加载成功: ${imgAlt}`);
                });
                
                modalImg.addEventListener('error', function() {
                    console.error(`❌ 模态框图片加载失败: ${imgAlt}`);
                    
                    // 显示错误信息
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        color: white;
                        text-align: center;
                        padding: 20px;
                        background-color: rgba(255, 0, 0, 0.8);
                        border-radius: 8px;
                    `;
                    errorDiv.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold;">图片加载失败</div>
                        <div style="margin-top: 10px; font-size: 14px; word-break: break-all;">${imgSrc}</div>
                    `;
                    
                    modal.innerHTML = '';
                    modal.appendChild(errorDiv);
                });
                
                modal.appendChild(modalImg);
                
                // 添加关闭事件
                modal.addEventListener('click', function() {
                    console.log(`❌ 关闭图片模态框: ${imgAlt}`);
                    modal.remove();
                });
                
                // 添加ESC键关闭
                const handleEsc = function(e) {
                    if (e.key === 'Escape') {
                        console.log(`⌨️ ESC键关闭图片模态框: ${imgAlt}`);
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                document.body.appendChild(modal);
                console.log(`📱 图片模态框已添加到页面`);
            }
            


            

            

            // 统一的复制功能实现
            async function copyCodeToClipboard(copyButton, code, isMobile) {
                const originalContent = copyButton.innerHTML;
                const textSpan = copyButton.querySelector('.copy-text');
                
                // 获取代码内容（去除行号等额外内容）
                const codeText = code.textContent || code.innerText;
                
                try {
                    // 尝试使用现代clipboard API
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(codeText);
                        showCopySuccess(copyButton, originalContent, textSpan, isMobile);
                    } else {
                        // 降级方案：使用传统方法
                        copyUsingFallback(codeText);
                        showCopySuccess(copyButton, originalContent, textSpan, isMobile);
                    }
                        } catch (err) {
                    console.warn('Clipboard API failed, using fallback:', err);
                    try {
                        copyUsingFallback(codeText);
                        showCopySuccess(copyButton, originalContent, textSpan, isMobile);
                    } catch (fallbackErr) {
                        console.error('All copy methods failed:', fallbackErr);
                        showCopyError(copyButton, originalContent, textSpan);
                    }
                }
            }

            // 降级复制方法
            function copyUsingFallback(text) {
                            const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.cssText = `
                    position: fixed;
                    top: -1000px;
                    left: -1000px;
                    width: 2em;
                    height: 2em;
                    padding: 0;
                    border: none;
                    outline: none;
                    boxShadow: none;
                    background: transparent;
                `;
                
                            document.body.appendChild(textArea);
                textArea.focus();
                            textArea.select();
                
                // 对于iOS Safari的特殊处理
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    textArea.setSelectionRange(0, 99999);
                }
                
                const successful = document.execCommand('copy');
                            document.body.removeChild(textArea);
                
                if (!successful) {
                    throw new Error('execCommand copy failed');
                }
            }

            // 清除复制按钮的内联样式，让CSS接管，并根据主题设置正确样式
            function clearCopyButtonInlineStyles(copyButton) {
                // 检测当前主题
                const isDarkMode = document.body.classList.contains('dark-mode') || 
                                  document.documentElement.getAttribute('data-theme') === 'dark' ||
                                  (!document.body.classList.contains('light-mode') && 
                                   window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                // 清除所有可能影响按钮外观的内联样式
                copyButton.style.backgroundColor = '';
                copyButton.style.borderColor = '';
                copyButton.style.color = '';
                copyButton.style.boxShadow = '';
                copyButton.style.transform = '';
                
                // 移除状态类
                copyButton.classList.remove('success', 'error');
                
                // 根据主题设置正确的默认样式，防止回退到白色
                if (isDarkMode) {
                    // 使用与新CSS一致的深色主题色彩
                    copyButton.style.backgroundColor = '#2d3748';
                    copyButton.style.borderColor = '#4a5568';
                    copyButton.style.color = '#a0aec0';
                    copyButton.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                    console.log('🌙 深色模式：设置复制按钮为强化深色样式');
                } else {
                    // 浅色模式让CSS接管（保持原有白色样式）
                    copyButton.style.backgroundColor = '';
                    copyButton.style.borderColor = '';
                    copyButton.style.color = '';
                    copyButton.style.boxShadow = '';
                    console.log('☀️ 浅色模式：让CSS接管按钮样式');
                }
                
                console.log('🧹 清除按钮内联样式，根据主题恢复正确控制');
            }

            // 显示复制成功状态
            function showCopySuccess(copyButton, originalContent, textSpan, isMobile) {
                // 更新按钮文本和样式
                copyButton.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                    </svg>
                    <span class="copy-text" style="margin-left: 4px;">已复制</span>
                `;
                
                // 成功状态样式
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      (!document.body.classList.contains('light-mode') && 
                                       window.matchMedia('(prefers-color-scheme: dark)').matches);
                    
                copyButton.style.backgroundColor = isDarkMode ? '#38a169' : '#2da44e';  /* 更亮的绿色 */
                copyButton.style.borderColor = isDarkMode ? '#68d391' : '#2da44e';     /* 更亮的绿色边框 */
                copyButton.style.color = isDarkMode ? '#f0fff4' : '#ffffff';            /* 更亮的文字 */
                
                // 深色模式下添加发光效果
                if (isDarkMode) {
                    copyButton.style.boxShadow = '0 0 12px rgba(104, 211, 145, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3)';
                }
                
                // 触觉反馈（移动端）
                if (isMobile && 'vibrate' in navigator) {
                    navigator.vibrate(50);
                }
                
                // 恢复原状态
                setTimeout(() => {
                    copyButton.innerHTML = originalContent;
                    clearCopyButtonInlineStyles(copyButton);
                }, 2000);
            }

            // 显示复制错误状态
            function showCopyError(copyButton, originalContent, textSpan) {
                copyButton.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"/>
                    </svg>
                    <span class="copy-text" style="margin-left: 4px;">失败</span>
                `;
                
                // 获取当前主题
                const isDarkMode = document.body.classList.contains('dark-mode') || 
                                  (!document.body.classList.contains('light-mode') && 
                                   window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                copyButton.style.backgroundColor = isDarkMode ? '#e53e3e' : '#da3633';  /* 更亮的红色 */
                copyButton.style.borderColor = isDarkMode ? '#fc8181' : '#da3633';     /* 更亮的红色边框 */
                copyButton.style.color = isDarkMode ? '#fff5f5' : '#ffffff';            /* 更亮的文字 */
                
                // 深色模式下添加发光效果
                if (isDarkMode) {
                    copyButton.style.boxShadow = '0 0 12px rgba(252, 129, 129, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3)';
                }
                
                setTimeout(() => {
                    copyButton.innerHTML = originalContent;
                    clearCopyButtonInlineStyles(copyButton);
                }, 3000);
            }

            // 代码复制功能测试和调试
            function debugCopyFunctionality() {
                console.log('🔍 开始代码复制功能调试...');
                
                const isMobile = isMobileDevice();
                console.log(`📱 设备类型: ${isMobile ? '移动设备' : '桌面设备'}`);
                console.log(`🖱️ 触摸支持: ${'ontouchstart' in window}`);
                console.log(`🔢 最大触摸点: ${navigator.maxTouchPoints}`);
                console.log(`🏷️ User Agent: ${navigator.userAgent}`);
                
                const codeBlocks = document.querySelectorAll('pre code');
                console.log(`📋 发现代码块数量: ${codeBlocks.length}`);
                
                const copyButtons = document.querySelectorAll('.code-copy-button');
                console.log(`🔘 复制按钮数量: ${copyButtons.length}`);
                
                // 检查按钮样式
                copyButtons.forEach((button, index) => {
                    const styles = window.getComputedStyle(button);
                    console.log(`🔘 按钮${index + 1}样式:`, {
                        opacity: styles.opacity,
                        visibility: styles.visibility,
                        display: styles.display,
                        minWidth: styles.minWidth,
                        minHeight: styles.minHeight
                    });
                });
                
                // 检查剪贴板API支持
                console.log(`📋 Clipboard API支持: ${navigator.clipboard ? '是' : '否'}`);
                console.log(`📋 writeText方法: ${navigator.clipboard?.writeText ? '是' : '否'}`);
                
                return {
                    isMobile,
                    codeBlocksCount: codeBlocks.length,
                    copyButtonsCount: copyButtons.length,
                    clipboardSupport: !!navigator.clipboard?.writeText
                };
            }

            // 手动测试复制功能
            function testCopyFunctionality() {
                console.log('🧪 开始手动测试复制功能...');
                
                const firstCodeBlock = document.querySelector('pre code');
                if (!firstCodeBlock) {
                    console.log('❌ 未找到代码块，无法测试');
                    return false;
                }
                
                const copyButton = firstCodeBlock.parentElement.querySelector('.code-copy-button');
                if (!copyButton) {
                    console.log('❌ 未找到复制按钮，无法测试');
                    return false;
                }
                
                console.log('✅ 找到第一个代码块和复制按钮');
                console.log('📋 代码内容预览:', firstCodeBlock.textContent.substring(0, 50) + '...');
                
                // 模拟点击
                try {
                    copyButton.click();
                    console.log('✅ 成功触发复制按钮点击事件');
                    return true;
                } catch (error) {
                    console.log('❌ 复制按钮点击失败:', error);
                    return false;
                }
            }

            // 强制显示所有复制按钮（调试用）
            function forceShowAllCopyButtons() {
                console.log('🚨 强制显示所有复制按钮...');
                
                const copyButtons = document.querySelectorAll('.code-copy-button');
                console.log(`找到 ${copyButtons.length} 个复制按钮`);
                
                copyButtons.forEach((button, index) => {
                    const originalStyles = {
                        opacity: button.style.opacity,
                        visibility: button.style.visibility,
                        display: button.style.display
                    };
                    
                    // 强制显示
                    button.style.opacity = '1';
                    button.style.visibility = 'visible';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                    button.style.backgroundColor = '#ff6b35';
                    button.style.color = 'white';
                    button.style.border = '2px solid #ff6b35';
                    button.style.zIndex = '1000';
                    
                    console.log(`🔘 按钮${index + 1} 强制显示 - 原样式:`, originalStyles);
                });
                
                return `已强制显示 ${copyButtons.length} 个复制按钮（橙色高亮）`;
            }

            // 重新添加复制按钮到所有代码块
            function readdCopyButtons() {
                console.log('🔄 重新添加复制按钮到所有代码块...');
                
                const container = document.getElementById('rendered-content') || document.body;
                const codeBlocks = container.querySelectorAll('pre code');
                console.log(`发现 ${codeBlocks.length} 个代码块`);
                
                // 移除现有按钮
                const existingButtons = container.querySelectorAll('.code-copy-button');
                console.log(`移除 ${existingButtons.length} 个现有按钮`);
                existingButtons.forEach(btn => btn.remove());
                
                // 重新添加按钮
                addCodeCopyButtons(container);
                
                // 统计结果
                const newButtons = container.querySelectorAll('.code-copy-button');
                console.log(`✅ 重新添加了 ${newButtons.length} 个复制按钮`);
                
                return `重新添加了 ${newButtons.length} 个复制按钮`;
            }


            
            // ==================== 简洁优雅代码复制系统 ====================
            
            /**
             * 初始化简洁优雅的代码复制系统
             */
            function initializeMobileCopySystem(container) {
                console.log('🚀 初始化简洁优雅代码复制系统');
                console.log('📦 容器元素:', container);
                
                const codeBlocks = container.querySelectorAll('pre code');
                console.log(`📋 发现 ${codeBlocks.length} 个代码块`);
                
                codeBlocks.forEach((codeElement, index) => {
                    const preElement = codeElement.parentElement;
                    console.log(`🔍 处理第 ${index + 1} 个代码块:`, preElement);
                    
                    // 避免重复添加
                    if (preElement.querySelector('.code-copy-btn')) {
                        console.log(`⚠️ 第 ${index + 1} 个代码块已有复制按钮，跳过`);
                        return;
                    }
                    
                    // 创建复制按钮
                    const copyButton = createCopyButton(codeElement, index);
                    console.log(`🔘 为第 ${index + 1} 个代码块创建复制按钮:`, copyButton);
                    
                    preElement.appendChild(copyButton);
                    console.log(`✅ 第 ${index + 1} 个复制按钮已添加到DOM`);
                    
                    // 验证按钮是否真的在DOM中
                    const addedButton = preElement.querySelector('.code-copy-btn');
                    console.log(`🔍 验证按钮是否在DOM中:`, addedButton ? '是' : '否');
                    if (addedButton) {
                        const computedStyle = window.getComputedStyle(addedButton);
                        console.log(`🎨 按钮样式检查:`, {
                            display: computedStyle.display,
                            visibility: computedStyle.visibility,
                            opacity: computedStyle.opacity,
                            position: computedStyle.position,
                            zIndex: computedStyle.zIndex
                        });
                    }
                });
                
                const totalButtons = container.querySelectorAll('.code-copy-btn');
                console.log(`✅ 代码复制系统初始化完成，总共创建了 ${totalButtons.length} 个复制按钮`);
            }
            
            /**
             * 创建简洁优雅的复制按钮
             */
            function createCopyButton(codeElement, index) {
                const button = document.createElement('button');
                button.className = 'code-copy-btn';
                button.setAttribute('aria-label', '复制代码');
                button.setAttribute('data-index', index);
                button.setAttribute('title', '复制代码');
                
                // 简洁的复制图标
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="m5 15-2 0a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                `;
                
                // 点击事件
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 轻微振动反馈
                    if ('vibrate' in navigator) {
                        navigator.vibrate(30);
                    }
                    
                    await copyToClipboard(codeElement, button);
                });
                
                return button;
            }
            
            /**
             * 复制到剪贴板
             */
            async function copyToClipboard(codeElement, button) {
                const text = codeElement.textContent || codeElement.innerText || '';
                const originalHTML = button.innerHTML;
                
                try {
                    // 现代浏览器
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        // 兼容方案
                        fallbackCopy(text);
                    }
                    
                    // 成功反馈
                    showSuccess(button, originalHTML, text.length);
                    
                } catch (error) {
                    console.warn('主要复制方法失败，尝试兼容方案:', error);
                    try {
                        fallbackCopy(text);
                        showSuccess(button, originalHTML, text.length);
                    } catch (fallbackError) {
                        console.error('所有复制方法失败:', fallbackError);
                        showError(button, originalHTML);
                    }
                }
            }
            
            /**
             * 兼容性复制方案
             */
            function fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: -9999px;
                    opacity: 0;
                `;
                
                document.body.appendChild(textarea);
                textarea.select();
                textarea.setSelectionRange(0, 99999); // 移动端兼容
                
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (!success) {
                    throw new Error('execCommand copy failed');
                }
            }
            
            /**
             * 显示成功状态
             */
            function showSuccess(button, originalHTML, textLength) {
                // 更新按钮
                button.classList.add('success');
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                `;
                
                // Toast通知
                showNotification(`已复制`);
                
                // 成功振动
                if ('vibrate' in navigator) {
                    navigator.vibrate([40, 40, 40]);
                }
                
                // 恢复状态
                            setTimeout(() => {
                    button.classList.remove('success');
                    button.innerHTML = originalHTML;
                }, 1800);
            }
            
            /**
             * 显示错误状态
             */
            function showError(button, originalHTML) {
                button.style.background = '#ef4444';
                button.style.borderColor = '#dc2626';
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="m15 9-6 6m0-6 6 6"/>
                    </svg>
                `;
                
                showNotification('复制失败', true);
                
                if ('vibrate' in navigator) {
                    navigator.vibrate([80, 40, 80]);
                }
                
                            setTimeout(() => {
                    // 使用改进的清除函数，避免回退到白色背景
                    clearCopyButtonInlineStyles(button);
                    button.innerHTML = originalHTML;
                }, 2500);
            }
            
            /**
             * 显示通知
             */
            function showNotification(message, isError = false) {
                // 清除旧通知
                const existing = document.querySelector('.copy-notification');
                if (existing) existing.remove();
                
                // 创建通知
                const notification = document.createElement('div');
                notification.className = 'copy-notification';
                notification.textContent = message;
                
                if (isError) {
                    notification.style.background = 'rgba(239, 68, 68, 0.9)';
                    notification.style.color = 'white';
                }
                
                document.body.appendChild(notification);
                
                // 显示动画
                setTimeout(() => notification.classList.add('show'), 10);
                
                // 自动隐藏
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                            }, 2000);
                        }
            
            /**
             * 测试函数
             */
            function testCopySystem() {
                console.log('🧪 开始全面测试复制系统...');
                
                const codeBlocks = document.querySelectorAll('pre code');
                const buttons = document.querySelectorAll('.code-copy-btn');
                const preElements = document.querySelectorAll('pre');
                
                console.log(`📊 系统状态详情:
                - 代码块 (pre code): ${codeBlocks.length} 个
                - pre 元素: ${preElements.length} 个  
                - 复制按钮: ${buttons.length} 个
                - Clipboard API: ${navigator.clipboard ? '支持' : '不支持'}`);
                
                // 检查每个pre元素的样式
                preElements.forEach((pre, index) => {
                    const style = window.getComputedStyle(pre);
                    console.log(`🔍 pre元素${index + 1}样式:`, {
                        background: style.background,
                        border: style.border,
                        borderRadius: style.borderRadius,
                        padding: style.padding,
                        margin: style.margin,
                        position: style.position
                    });
                    
                    const existingButton = pre.querySelector('.code-copy-btn');
                    console.log(`🔘 pre元素${index + 1}的复制按钮:`, existingButton ? '存在' : '不存在');
                    if (existingButton) {
                        const btnStyle = window.getComputedStyle(existingButton);
                        console.log(`🎨 按钮${index + 1}样式:`, {
                            display: btnStyle.display,
                            visibility: btnStyle.visibility,
                            opacity: btnStyle.opacity,
                            position: btnStyle.position,
                            top: btnStyle.top,
                            right: btnStyle.right,
                            zIndex: btnStyle.zIndex,
                            width: btnStyle.width,
                            height: btnStyle.height
                        });
                    }
                });
                
                if (buttons.length > 0) {
                    console.log('🧪 测试第一个按钮点击...');
                    buttons[0].click();
                    return true;
                } else {
                    console.warn('❌ 未找到任何复制按钮');
                    
                    // 尝试手动重新初始化
                    console.log('🔧 尝试手动重新初始化...');
                    const container = document.getElementById('rendered-content') || document.body;
                    initializeMobileCopySystem(container);
                    
                    return false;
                }
            }
            
            // 强制重新初始化（清理并重新创建所有复制按钮）
            function forceReinitializeCopySystem() {
                console.log('🔧 强制重新初始化复制系统...');
                
                // 移除所有现有的复制按钮
                const existingButtons = document.querySelectorAll('.code-copy-btn');
                console.log(`🗑️ 移除 ${existingButtons.length} 个现有按钮`);
                existingButtons.forEach(btn => btn.remove());
                
                // 重新初始化
                const container = document.getElementById('rendered-content') || document.body;
                initializeMobileCopySystem(container);
                
                // 验证结果
                const newButtons = document.querySelectorAll('.code-copy-btn');
                console.log(`✨ 重新创建了 ${newButtons.length} 个复制按钮`);
                
                return newButtons.length;
            }
            
            // 全局调试
            if (typeof window !== 'undefined') {
                window.testCopySystem = testCopySystem;
                window.initializeMobileCopySystem = initializeMobileCopySystem;
                window.forceReinitializeCopySystem = forceReinitializeCopySystem;
                
                console.log(`🔧 复制系统调试函数已就绪:
                - testCopySystem() - 全面测试系统
                - forceReinitializeCopySystem() - 强制重新初始化  
                - initializeMobileCopySystem(container) - 手动初始化`);
            }
            
            // 优化任务列表样式
            function enhanceTaskLists(element) {
                const taskItems = element.querySelectorAll('li');
                taskItems.forEach(item => {
                    const text = item.innerHTML;
                    // 检查是否为任务列表项
                    if (text.includes('☐') || text.includes('☑') || text.includes('✓') || 
                        text.includes('[ ]') || text.includes('[x]') || text.includes('[X]')) {
                        
                        // 替换任务列表标记
                        let newText = text
                            .replace(/☐|☑|✓|\[[ ]\]|\[x\]|\[X\]/g, (match) => {
                                const isChecked = match === '☑' || match === '✓' || match === '[x]' || match === '[X]';
                                return `<input type="checkbox" ${isChecked ? 'checked' : ''} disabled style="margin-right: 8px;">`;
                            });
                        
                        item.innerHTML = newText;
                        item.style.listStyle = 'none';
                        item.style.marginLeft = '-20px';
                        
                        // 如果已完成，添加删除线样式
                        if (text.includes('☑') || text.includes('✓') || text.includes('[x]') || text.includes('[X]')) {
                            item.style.textDecoration = 'line-through';
                            item.style.opacity = '0.7';
                        }
                    }
                });
            }
            
            // Mermaid渲染失败备用方案
            function tryFallbackRender(diagramId, originalCode, processedCode, container, error, index) {
                console.log(`🔄 尝试Mermaid图表 ${index + 1} 的备用渲染方案`);
                
                // 方案1: 尝试使用原始代码渲染（如果修复后的代码失败）
                if (processedCode !== originalCode.trim()) {
                    console.log('🔄 尝试使用原始代码渲染');
                    mermaid.render(`${diagramId}-fallback-1`, originalCode.trim()).then(result => {
                        container.innerHTML = result.svg;
                        console.log(`✅ 使用原始代码渲染成功`);
                        
                        // 应用移动端优化
                        applyMobileOptimization(container.querySelector('svg'), originalCode.trim());
                        
                    }).catch(fallbackError => {
                        console.warn('❌ 原始代码渲染也失败:', fallbackError);
                        
                        // 方案2: 尝试简化版本
                        trySimplifiedFallback(diagramId, originalCode, container, error, index);
                    });
                } else {
                    // 直接尝试简化版本
                    trySimplifiedFallback(diagramId, originalCode, container, error, index);
                }
            }
            
            // 简化版本备用方案
            function trySimplifiedFallback(diagramId, originalCode, container, error, index) {
                console.log(`🔄 尝试简化版本备用方案`);
                
                let simplifiedCode = originalCode.trim();
                
                // 实体关系图简化
                if (simplifiedCode.startsWith('erDiagram')) {
                    simplifiedCode = `
erDiagram
    ENTITY_A {
        string id
        string name
    }
    
    ENTITY_B {
        string id
        string data
    }
    
    ENTITY_A ||--o{ ENTITY_B : contains
                    `.trim();
                    
                    console.log('🔄 使用简化的实体关系图');
                    
                // 甘特图简化  
                } else if (simplifiedCode.startsWith('gantt')) {
                    simplifiedCode = `
gantt
    title 简化时间线
    dateFormat YYYY-MM-DD
    
    section 阶段
    任务A : done, 2024-01-01, 30d
    任务B : active, 2024-02-01, 30d
                    `.trim();
                    
                    console.log('🔄 使用简化的甘特图');
                    
                // 其他图表类型的简化处理
                } else {
                    console.log('🔄 图表类型不支持简化，显示错误信息');
                    showErrorMessage(container, error, originalCode, index);
                    return;
                }
                
                // 尝试渲染简化版本
                mermaid.render(`${diagramId}-simplified`, simplifiedCode).then(result => {
                    container.innerHTML = `
                        <div style="margin-bottom: 12px; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px; color: #856404;">
                            ⚠️ 原始图表渲染失败，显示简化版本
                        </div>
                        ${result.svg}
                    `;
                    
                    console.log(`✅ 简化版本渲染成功`);
                    
                    // 应用移动端优化
                    applyMobileOptimization(container.querySelector('svg'), simplifiedCode);
                    
                }).catch(simplifiedError => {
                    console.error('❌ 简化版本渲染也失败:', simplifiedError);
                    showErrorMessage(container, error, originalCode, index);
                });
            }
            
            // 应用移动端优化到SVG
            function applyMobileOptimization(svg, code) {
                if (!svg) return;
                
                svg.style.maxWidth = '100%';
                svg.style.height = 'auto';
                svg.style.touchAction = 'pan-x pan-y';
                
                const isGantt = code.trim().startsWith('gantt');
                const isER = code.trim().startsWith('erDiagram');
                
                if (isGantt) {
                    svg.setAttribute('data-chart-type', 'gantt');
                } else if (isER) {
                    svg.setAttribute('data-chart-type', 'er');
                }
            }
            
            // 显示错误信息
            function showErrorMessage(container, error, originalCode, index) {
                const isDarkMode = document.body.classList.contains('dark-mode');
                
                container.innerHTML = `
                    <div style="
                        color: #d73a49; 
                        background-color: ${isDarkMode ? '#2d1b1f' : '#ffeef0'}; 
                        border: 1px solid ${isDarkMode ? '#8b5862' : '#fdaeb7'}; 
                        border-radius: 6px; 
                        padding: 16px; 
                        font-family: inherit;
                        font-size: 14px;
                        margin: 20px 0;
                    ">
                        <strong>📊 Mermaid图表渲染失败</strong><br>
                        <div style="margin: 8px 0; font-size: 13px; color: ${isDarkMode ? '#ff7979' : '#d73a49'};">
                            错误: ${error.message || '未知语法错误'}
                        </div>
                        
                        <div style="margin: 12px 0; padding: 8px; background: ${isDarkMode ? '#1a1a1a' : '#f8f9fa'}; border-radius: 4px; font-size: 12px; color: ${isDarkMode ? '#e1e4e8' : '#586069'};">
                            💡 <strong>可能的解决方案:</strong><br>
                            • 检查实体关系图的属性定义语法<br>
                            • 使用 <code>string field_name</code> 格式定义字段<br>
                            • 避免使用 PK、FK 等关键字<br>
                            • 确保关系语法正确: <code>ENTITY_A ||--o{ ENTITY_B : relationship</code>
                        </div>
                        
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; color: ${isDarkMode ? '#58a6ff' : '#0366d6'}; font-weight: 500;">
                                📝 查看原始代码
                            </summary>
                            <pre style="
                                margin-top: 8px; 
                                background: ${isDarkMode ? '#161b22' : '#f6f8fa'}; 
                                color: ${isDarkMode ? '#e1e4e8' : '#24292e'};
                                padding: 12px; 
                                border-radius: 4px; 
                                overflow-x: auto;
                                font-size: 12px;
                                border: 1px solid ${isDarkMode ? '#30363d' : '#d1d5da'};
                            ">${originalCode}</pre>
                        </details>
                        
                        <div style="margin-top: 12px; font-size: 12px; color: ${isDarkMode ? '#8b949e' : '#6a737d'};">
                            🔧 系统已尝试自动修复语法，但仍然失败。请检查图表语法是否正确。
                        </div>
                    </div>
                `;
            }
            
            // Mermaid语法兼容性修复函数
            function fixMermaidCompatibility(code) {
                let fixedCode = code.trim();
                
                try {
                    // 检测实体关系图并修复常见问题
                    if (fixedCode.startsWith('erDiagram')) {
                        console.log('🔧 检测到实体关系图，应用兼容性修复');
                        
                        // 修复属性定义中的PK/FK问题
                        fixedCode = fixedCode.replace(/(\w+)\s+PK\s*$/gm, 'string $1')
                                           .replace(/(\w+)\s+FK\s*$/gm, 'string $1')
                                           .replace(/(\w+)\s+PK\s+/gm, 'string $1 ')
                                           .replace(/(\w+)\s+FK\s+/gm, 'string $1 ');
                        
                        // 修复没有类型声明的属性
                        const lines = fixedCode.split('\n');
                        let inEntity = false;
                        let fixedLines = [];
                        
                        for (let line of lines) {
                            const trimmedLine = line.trim();
                            
                            if (trimmedLine.includes('{')) {
                                inEntity = true;
                                fixedLines.push(line);
                            } else if (trimmedLine.includes('}')) {
                                inEntity = false;
                                fixedLines.push(line);
                            } else if (inEntity && trimmedLine && !trimmedLine.includes('--') && !trimmedLine.includes(':')) {
                                // 这是一个属性行，检查是否需要添加类型
                                if (!trimmedLine.includes('string ') && !trimmedLine.includes('int ') && !trimmedLine.includes('boolean ')) {
                                    fixedLines.push(`        string ${trimmedLine}`);
                                } else {
                                    fixedLines.push(line);
                                }
                            } else {
                                fixedLines.push(line);
                            }
                        }
                        
                        fixedCode = fixedLines.join('\n');
                        
                        // 修复关系语法兼容性
                        fixedCode = fixedCode.replace(/(\w+)\s*\}o--\|\|\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*\|\|--o\}\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*--\>\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*\<--\s*(\w+)\s*:\s*(.+)/g, '$2 ||--o{ $1 : $3');
                        
                        // 修复中文关系标签和特殊字符
                        fixedCode = fixedCode.replace(/:\s*["']([^"']*["'][^"']*["'][^"']*)["']/g, ': contains')
                                           .replace(/:\s*["']?属于["']?/g, ': belongs_to')
                                           .replace(/:\s*["']?包含["']?/g, ': contains')
                                           .replace(/:\s*["']?拥有["']?/g, ': has')
                                           .replace(/:\s*["']?关联["']?/g, ': relates_to')
                                           .replace(/:\s*["']?引用["']?/g, ': references');
                        
                        console.log('✅ 实体关系图语法修复完成');
                    }
                    
                    // 检测甘特图并修复常见问题
                    if (fixedCode.startsWith('gantt')) {
                        console.log('🔧 检测到甘特图，应用兼容性修复');
                        
                        // 确保正确的日期格式
                        if (!fixedCode.includes('dateFormat')) {
                            fixedCode = fixedCode.replace('gantt', 'gantt\n    dateFormat YYYY-MM-DD');
                        }
                        
                        // 修复轴格式
                        fixedCode = fixedCode.replace(/axisFormat\s+['"]?%m\/%d['"]?/g, 'axisFormat %m月');
                        
                        console.log('✅ 甘特图语法修复完成');
                    }
                    
                    // 通用修复：移除不支持的classDef
                    fixedCode = fixedCode.replace(/classDef\s+\w+\s+[^;]+;?\s*/g, '');
                    
                    // 通用修复：移除不支持的class应用
                    fixedCode = fixedCode.replace(/class\s+[\w,\s]+\s+\w+\s*/g, '');
                    
                    if (fixedCode !== code.trim()) {
                        console.log('🔧 Mermaid代码已修复');
                        console.log('📝 原始代码:', code.substring(0, 100) + (code.length > 100 ? '...' : ''));
                        console.log('🔧 修复后:', fixedCode.substring(0, 100) + (fixedCode.length > 100 ? '...' : ''));
                        console.log('📊 长度变化:', code.length, '->', fixedCode.length);
                    }
                    
                } catch (error) {
                    console.warn('⚠️ Mermaid语法修复过程中出现错误:', error);
                    return code.trim(); // 返回原始代码
                }
                
                return fixedCode;
            }
            
            // 处理Mermaid图表
            function renderMermaidDiagrams(element) {
                if (typeof mermaid === 'undefined') {
                    console.warn('⚠️ Mermaid未加载，跳过图表渲染');
                    return;
                }
                
                const mermaidBlocks = element.querySelectorAll('pre code.language-mermaid');
                console.log(`🎨 发现 ${mermaidBlocks.length} 个Mermaid图表`);
                
                mermaidBlocks.forEach((code, index) => {
                    // 避免重复处理
                    if (code.dataset.mermaidProcessed) {
                        return;
                    }
                    
                    const pre = code.parentElement;
                    const mermaidCode = code.textContent.trim();
                    
                    if (!mermaidCode) {
                        console.warn(`⚠️ Mermaid图表 ${index + 1} 内容为空`);
                        return;
                    }
                    
                    console.log(`🎨 渲染Mermaid图表 ${index + 1}:`, mermaidCode.substring(0, 50) + '...');
                    
                    // 预处理Mermaid代码，修复兼容性问题
                    let processedCode = fixMermaidCompatibility(mermaidCode);
                    
                    // 创建Mermaid容器
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid-diagram';
                    mermaidDiv.style.cssText = `
                        margin: 20px 0;
                        text-align: center;
                        background-color: transparent;
                        border-radius: 8px;
                        padding: 20px;
                        overflow-x: auto;
                        border: 1px solid #e1e4e8;
                    `;
                    
                    // 为移动端优化
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    if (isDarkMode) {
                        mermaidDiv.style.borderColor = '#30363d';
                        mermaidDiv.style.backgroundColor = 'rgba(22, 27, 34, 0.5)';
                    }
                    
                    // 生成唯一ID
                    const diagramId = `mermaid-diagram-${Date.now()}-${index}`;
                    
                    try {
                        // 使用mermaid.render渲染图表
                        mermaid.render(diagramId, processedCode).then(result => {
                            mermaidDiv.innerHTML = result.svg;
                            
                            // 优化SVG样式
                            const svg = mermaidDiv.querySelector('svg');
                            if (svg) {
                                svg.style.maxWidth = '100%';
                                svg.style.height = 'auto';
                                
                                // 移动端触摸优化
                                svg.style.touchAction = 'pan-x pan-y';
                                
                                // 检测图表类型并应用特定优化
                                const isGantt = processedCode.trim().startsWith('gantt');
                                const isER = processedCode.trim().startsWith('erDiagram');
                                
                                if (isGantt) {
                                    console.log(`🗓️ 应用甘特图移动端优化`);
                                    // 甘特图特殊优化
                                    svg.setAttribute('data-chart-type', 'gantt');
                                    
                                    // 移动端屏幕宽度检测
                                    if (window.innerWidth <= 768) {
                                        // 调整甘特图在移动端的显示
                                        const tasks = svg.querySelectorAll('.taskText, .sectionTitle');
                                        tasks.forEach(task => {
                                            task.style.fontSize = window.innerWidth <= 480 ? '11px' : '12px';
                                        });
                                        
                                        // 调整时间轴标签
                                        const axisLabels = svg.querySelectorAll('.grid .tick text');
                                        axisLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                        });
                                    }
                                    
                                    // 设置甘特图容器的特殊样式
                                    mermaidDiv.style.overflowX = 'auto';
                                    mermaidDiv.style.WebkitOverflowScrolling = 'touch';
                                    
                                } else if (isER) {
                                    console.log(`🗃️ 应用实体关系图移动端优化`);
                                    // 实体关系图特殊优化
                                    svg.setAttribute('data-chart-type', 'er');
                                    
                                    // 移动端优化
                                    if (window.innerWidth <= 768) {
                                        // 调整实体标签字体
                                        const entityLabels = svg.querySelectorAll('.entityLabel');
                                        entityLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '12px' : '13px';
                                        });
                                        
                                        // 调整属性文本
                                        const attributeTexts = svg.querySelectorAll('.attributeBoxOdd text, .attributeBoxEven text');
                                        attributeTexts.forEach(text => {
                                            text.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                        });
                                        
                                        // 调整关系标签
                                        const relationLabels = svg.querySelectorAll('.relationshipLabel');
                                        relationLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '9px' : '10px';
                                        });
                                    }
                                    
                                    // 优化实体关系图的垂直布局
                                    mermaidDiv.style.minHeight = 'auto';
                                }
                                
                                // 通用移动端优化
                                if (window.innerWidth <= 768) {
                                    // 添加缩放提示（仅在超宽图表时）
                                    const svgWidth = svg.getBBox ? svg.getBBox().width : svg.viewBox.baseVal.width;
                                    if (svgWidth > window.innerWidth - 40) {
                                        const zoomHint = document.createElement('div');
                                        zoomHint.style.cssText = `
                                            font-size: 12px;
                                            color: #6b7280;
                                            text-align: center;
                                            margin-top: 8px;
                                            padding: 4px 8px;
                                            background: rgba(107, 114, 128, 0.1);
                                            border-radius: 4px;
                                        `;
                                        
                                    }
                                }
                                
                                console.log(`✅ Mermaid图表 ${index + 1} 渲染成功`);
                            }
                            
                            // 标记为已处理
                            code.dataset.mermaidProcessed = 'true';
                            
                        }).catch(error => {
                            console.error(`❌ Mermaid图表 ${index + 1} 渲染失败:`, error);
                            
                            // 尝试备用渲染方案
                            tryFallbackRender(diagramId, mermaidCode, processedCode, mermaidDiv, error, index);
                        });
                        
                    } catch (error) {
                        console.error(`❌ Mermaid图表 ${index + 1} 处理异常:`, error);
                        showErrorMessage(mermaidDiv, error, mermaidCode, index);
                    }
                    
                    // 替换原始代码块
                    pre.parentNode.replaceChild(mermaidDiv, pre);
                });
            }
            
            // 简化HTML处理，专注于基本移动端适配
            function enhanceHTMLElements(element) {
                // 保护LaTeX元素，避免被处理干扰
                const mathElements = element.querySelectorAll('script[type="math/tex"], .MathJax, .MathJax_Display');
                mathElements.forEach(el => {
                    el.setAttribute('data-latex-protected', 'true');
                });
                
                // 基本移动端适配
                const htmlElements = element.querySelectorAll('div, span, section, article, aside, header, footer, nav');
                htmlElements.forEach(el => {
                    // 跳过LaTeX保护的元素
                    if (el.getAttribute('data-latex-protected') || 
                        el.closest('[data-latex-protected]') ||
                        el.classList.contains('MathJax') ||
                        el.classList.contains('MathJax_Display')) {
                        return;
                    }
                    
                    // 基本移动端适配
                    if (!el.style.maxWidth) {
                        el.style.maxWidth = '100%';
                    }
                });
                
                console.log('🏷️ 基本HTML适配完成');
            }
            
            // 渲染函数
            function renderMarkdown(markdownText) {
                try {
                    // 启动性能监控
                    if (window.startRenderingTimer) {
                        window.startRenderingTimer();
                    }
                    
                    nativePrint('🚀 renderMarkdown函数开始执行');
                    nativePrint(`📝 输入内容长度: ${markdownText.length}`);
                    
                    // 确保输入是字符串类型
                    if (typeof markdownText !== 'string') {
                        console.error('❌ 输入的markdown文本不是字符串类型:', typeof markdownText);
                        return;
                    }
                    
                    // 首先执行LaTeX预处理
                    nativePrint('🔧 开始执行LaTeX预处理');
                    let processedText = markdownText;
                    
                    // 检查预处理函数是否存在
                    if (typeof window.preprocessLatexInMarkdown === 'function') {
                        nativePrint('✅ 找到预处理函数，开始处理');
                        processedText = window.preprocessLatexInMarkdown(markdownText);
                        nativePrint(`🔧 预处理完成，原始长度: ${markdownText.length}, 处理后长度: ${processedText.length}`);
                    } else {
                        nativePrint('❌ 预处理函数不存在！');
                    }
                    
                    // 检测iOS WebView环境
                    const isIOSWebView = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    
                    if (isIOSWebView && processedText) {
                        console.log('🍎 检测到iOS WebView环境');
                        // 简化处理，专注于核心渲染功能
                    }
                    
                    // 根据内容大小选择渲染策略
                    const contentSize = processedText.length;
                    console.log('📄 内容大小:', contentSize, '字符');
                    
                    if (contentSize > 50000) {
                        // 大文件使用分块渲染
                        console.log('📄 大文件使用分块渲染');
                        renderOptimizedContent(processedText);
                    } else {
                        // 小文件直接渲染
                        console.log('📄 小文件直接渲染');
                        nativePrint('🔧 开始调用renderDirectly函数');
                        renderDirectly(processedText);
                        nativePrint('🔧 renderDirectly函数调用完成');
                    }
                    
                    // iOS WebView基本处理
                    if (isIOSWebView) {
                        console.log('🍎 iOS WebView环境已优化');
                    }
                    
                    // 智能目录生成调用（支持多种文档结构）
                    scheduleSmartTOCGeneration();
                    
                } catch (error) {
                    console.error('Markdown渲染错误:', error);
                    const contentElement = document.getElementById('rendered-content');
                    if (contentElement) {
                        const isDarkMode = document.body.classList.contains('dark-mode');
                        const bgColor = isDarkMode ? '#161b22' : '#fff5f5';
                        const textColor = isDarkMode ? '#f85149' : '#d73a49';
                        const borderColor = isDarkMode ? '#f85149' : '#d73a49';
                        
                        contentElement.innerHTML = `
                            <div style="
                                background-color: ${bgColor};
                                color: ${textColor};
                                border: 1px solid ${borderColor};
                                border-radius: 8px;
                                padding: 20px;
                                margin: 20px;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                            ">
                                <h3 style="margin-top: 0; font-size: 18px;">📄 Markdown渲染失败</h3>
                                <p style="margin-bottom: 16px;">
                                    渲染过程中遇到问题，这可能是由于：
                                </p>
                                <ul style="margin-bottom: 16px; padding-left: 20px;">
                                    <li>网络连接问题导致解析库加载失败</li>
                                    <li>文档格式不兼容</li>
                                    <li>内容包含不支持的语法</li>
                                </ul>
                                <p style="margin-bottom: 16px; font-size: 14px; opacity: 0.8;">
                                    <strong>技术详情：</strong> ${error.message}
                                </p>
                                <details style="margin-top: 16px;">
                                    <summary style="cursor: pointer; color: ${textColor};">显示原始内容</summary>
                                    <pre style="
                                        margin-top: 10px;
                                        padding: 16px;
                                        background-color: ${isDarkMode ? '#0d1117' : '#f6f8fa'};
                                        border-radius: 6px;
                                        overflow-x: auto;
                                        font-size: 13px;
                                        line-height: 1.4;
                                        white-space: pre-wrap;
                                        word-wrap: break-word;
                                    ">${text || '内容为空'}</pre>
                                </details>
                            </div>
                        `;
                    }
                }
            }
            
            // 新增：直接渲染函数（用于小文件）
            function renderDirectly(processedText) {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) {
                    console.error('未找到内容容器元素');
                    return;
                }
                
                // 清空容器
                contentElement.innerHTML = '';
                
                try {
                    // 使用安全的markdown解析
                    nativePrint('🔧 开始markdown解析');
                    const html = safeMarkdownParse(processedText);
                    nativePrint('🔧 markdown解析完成');
                    
                    contentElement.innerHTML = html;
                    nativePrint('🔧 HTML内容已插入');
                    
                    // 处理增强功能
                    nativePrint('🔧 开始调用processEnhancements');
                    processEnhancements(contentElement);
                    nativePrint('🔧 processEnhancements调用完成');
                    
                    // 结束性能监控
                    if (window.endRenderingTimer) {
                        window.endRenderingTimer('直接渲染');
                    }
                    
                    console.log('✅ 直接渲染完成');
                    nativePrint('✅ 直接渲染完成');
                } catch (error) {
                    console.error('❌ 直接渲染失败:', error);
                    
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const bgColor = isDarkMode ? '#161b22' : '#fff5f5';
                    const textColor = isDarkMode ? '#f85149' : '#d73a49';
                    const borderColor = isDarkMode ? '#f85149' : '#d73a49';
                    
                    contentElement.innerHTML = `
                        <div style="
                            background-color: ${bgColor};
                            color: ${textColor};
                            border: 1px solid ${borderColor};
                            border-radius: 8px;
                            padding: 20px;
                            margin: 20px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                        ">
                            <h3 style="margin-top: 0; font-size: 18px;">🔧 渲染引擎故障</h3>
                            <p style="margin-bottom: 12px;">直接渲染模式失败，可能的原因：</p>
                            <ul style="margin-bottom: 16px; padding-left: 20px;">
                                <li>Markdown解析库未正确加载</li>
                                <li>网络连接中断</li>
                                <li>文档内容格式问题</li>
                            </ul>
                            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 16px;">
                                <strong>错误信息：</strong> ${error.message}
                            </p>
                            <div style="
                                background-color: ${isDarkMode ? '#0d1117' : '#f0f8ff'};
                                padding: 12px;
                                border-radius: 6px;
                                font-size: 13px;
                                margin-top: 12px;
                            ">
                                💡 <strong>建议：</strong>请检查网络连接，或尝试刷新页面重新加载
                            </div>
                        </div>
                    `;
                }
            }
            
            // 在markdown解析之前预处理LaTeX公式（简化版本）- 移到全局作用域
            window.preprocessLatexInMarkdown = function(markdownText) {
                console.log('🔧 开始预处理LaTeX公式');
                let processedText = markdownText;
                
                // 简化的LaTeX公式处理函数
                function processLatexFormula(formula) {
                    let processed = formula;
                    
                    // 1. 处理\mathrm{中文}转换为\text{中文}
                        processed = processed.replace(/\\mathrm\{([^}]*[原反补码][^}]*)\}/g, (match, content) => {
                            return `\\text{${content}}`;
                        });
                    
                    // 2. 处理裸中文下标：_{中文}
                        processed = processed.replace(/_{([^}]*[原反补码][^}]*)}/g, (match, content) => {
                            if (content.includes('\\text{') || content.includes('\\mathrm{')) {
                                return match;
                            }
                            const wrapped = content.replace(/([原反补码])/g, '\\text{$1}');
                            return `_{${wrapped}}`;
                        });
                    
                    // 3. 处理简单中文下标：_中文
                        processed = processed.replace(/_([原反补码])/g, (match, char) => {
                            return `_{\\text{${char}}}`;
                        });
                    
                    // 4. 处理英文下标宏
                    const macros = ['orig', 'inv', 'comp', 'code', 'binary', 'decimal', 'hex', 'octal'];
                    macros.forEach(macro => {
                        processed = processed.replace(new RegExp(`_{(${macro})}`, 'g'), `_{\\${macro}}`);
                        processed = processed.replace(new RegExp(`_${macro}\\b`, 'g'), `_{\\${macro}}`);
                    });
                    
                    return processed;
                }
                
                // 处理所有LaTeX公式 - 使用改进的匹配方式
                let modified = false;
                
                // 处理行内公式：$...$
                function processInlineLatex(text) {
                    let result = text;
                    const matches = [];
                    let index = 0;
                    
                    while (index < result.length) {
                        const startIndex = result.indexOf('$', index);
                        if (startIndex === -1) break;
                        
                        const endIndex = result.indexOf('$', startIndex + 1);
                        if (endIndex === -1) break;
                        
                        const formula = result.substring(startIndex + 1, endIndex);
                        
                        // 确保这不是$$...$$格式的一部分
                        if (startIndex > 0 && result[startIndex - 1] === '$') {
                            index = startIndex + 1;
                            continue;
                        }
                        if (endIndex < result.length - 1 && result[endIndex + 1] === '$') {
                            index = endIndex + 1;
                            continue;
                        }
                        
                        matches.push({
                            full: result.substring(startIndex, endIndex + 1),
                            formula: formula,
                            start: startIndex,
                            end: endIndex + 1
                        });
                        
                        index = endIndex + 1;
                    }
                    
                    // 从后向前处理，避免索引偏移
                    for (let i = matches.length - 1; i >= 0; i--) {
                        const match = matches[i];
                        const processed = processLatexFormula(match.formula);
                        if (processed !== match.formula) {
                            modified = true;
                        }
                        
                        const newFormula = `$${processed}$`;
                        result = result.substring(0, match.start) + newFormula + result.substring(match.end);
                    }
                    
                    return result;
                }
                
                processedText = processInlineLatex(processedText);
                
                // 处理块级公式：$$...$$
                processedText = processedText.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `$$${processed}$$`;
                });
                
                // 处理\(...\)格式
                processedText = processedText.replace(/\\\(([^)]+)\\\)/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `\\(${processed}\\)`;
                });
                
                // 处理\[...\]格式
                processedText = processedText.replace(/\\\[([^\]]+)\\\]/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `\\[${processed}\\]`;
                });
                
                if (modified) {
                    console.log('✅ LaTeX预处理完成');
                }
                
                return processedText;
            };
            
            // 预处理LaTeX公式中的中文下标（简化版本）
            function preprocessChineseSubscripts(container) {
                console.log('🔧 预处理LaTeX中文下标');
                
                function processSubscriptsInText(text) {
                    let content = text;
                    let modified = false;
                    
                    // 简化的LaTeX公式处理函数
                    function processSubscriptsInFormula(formula) {
                        let processedFormula = formula;
                        
                        // 1. 处理\mathrm{中文}转换为\text{中文}
                        if (processedFormula.includes('\\mathrm{')) {
                            processedFormula = processedFormula.replace(/\\mathrm\{([^}]*[原反补码][^}]*)\}/g, (match, subscript) => {
                                return `\\text{${subscript}}`;
                            });
                        }
                        
                        // 2. 处理中文下标
                        processedFormula = processedFormula.replace(/_{([^}]*[原反补码][^}]*)}/g, (match, subscript) => {
                            if (subscript.includes('\\text{') || subscript.includes('\\mathrm{')) {
                                return match;
                            }
                            const wrappedSubscript = subscript.replace(/([原反补码])/g, '\\text{$1}');
                            return `_{${wrappedSubscript}}`;
                        });
                        
                        processedFormula = processedFormula.replace(/_([原反补码])/g, (match, subscript) => {
                            return `_{\\text{${subscript}}}`;
                        });
                        
                        // 3. 处理英文下标宏
                        const englishMacros = ['orig', 'inv', 'comp', 'code', 'binary', 'decimal', 'hex', 'octal'];
                        englishMacros.forEach(macro => {
                            processedFormula = processedFormula.replace(new RegExp(`_{(${macro})}`, 'g'), `_{\\${macro}}`);
                            processedFormula = processedFormula.replace(new RegExp(`_${macro}\\b`, 'g'), `_{\\${macro}}`);
                        });
                        
                        return processedFormula;
                    }
                    
                    // 处理各种LaTeX公式格式
                    content = content.replace(/\$([^$]+)\$/g, (match, formula) => {
                        const processed = processSubscriptsInFormula(formula);
                        if (processed !== formula) modified = true;
                        return `$${processed}$`;
                    });
                    
                    content = content.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
                        const processed = processSubscriptsInFormula(formula);
                        if (processed !== formula) modified = true;
                        return `$$${processed}$$`;
                    });
                    
                    content = content.replace(/\\\(([^)]+)\\\)/g, (match, formula) => {
                        const processed = processSubscriptsInFormula(formula);
                        if (processed !== formula) modified = true;
                        return `\\(${processed}\\)`;
                    });
                    
                    content = content.replace(/\\\[([^\]]+)\\\]/g, (match, formula) => {
                        const processed = processSubscriptsInFormula(formula);
                        if (processed !== formula) modified = true;
                        return `\\[${processed}\\]`;
                    });
                    
                    return { content, modified };
                }
                
                // 处理容器内的所有文本节点
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.includes('$') || 
                        node.textContent.includes('\\') || 
                        node.textContent.includes('mathrm') ||
                        /[原反补码]/.test(node.textContent)) {
                        textNodes.push(node);
                    }
                }
                
                // 处理所有包含数学公式的文本节点
                textNodes.forEach(textNode => {
                    const result = processSubscriptsInText(textNode.textContent);
                    if (result.modified) {
                        textNode.textContent = result.content;
                    }
                });
                
                console.log('🔧 LaTeX中文下标预处理完成');
            }
            
            // 检测网络连接状态
            function checkNetworkStatus() {
                if ('onLine' in navigator) {
                    console.log(`🌐 网络状态: ${navigator.onLine ? '在线' : '离线'}`);
                }
                
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    console.log('📶 网络连接信息:', {
                        effectiveType: connection.effectiveType,
                        downlink: connection.downlink,
                        rtt: connection.rtt
                    });
                }
                
                // 测试网络连接
                const testImage = new Image();
                testImage.onload = () => {
                    console.log('✅ 网络连接测试: 成功');
                };
                testImage.onerror = () => {
                    console.error('❌ 网络连接测试: 失败');
                };
                testImage.src = 'https://httpbin.org/image/png?_=' + Date.now();
            }
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    console.log('📱 页面加载完成，开始初始化');
                    
                    // 立即应用深色模式保护 - 防止代码块白色闪动
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      document.documentElement.getAttribute('data-theme') === 'dark';
                    
                    if (isDarkMode) {
                        console.log('🌙 检测到深色模式，应用紧急样式保护');
                        // 立即为所有现有元素应用深色样式
                        const codeBlocks = document.querySelectorAll('pre, code');
                        const copyButtons = document.querySelectorAll('.code-copy-btn');
                        
                        codeBlocks.forEach(block => {
                            if (block.tagName === 'PRE') {
                                block.style.background = '#1a1f2e';
                                block.style.color = '#e2e8f0';
                                block.style.borderColor = '#2d3748';
                            } else if (block.tagName === 'CODE') {
                                block.style.background = 'transparent';
                                block.style.color = '#e2e8f0';
                            }
                        });
                        
                        copyButtons.forEach(button => {
                            button.style.backgroundColor = '#2d3748';
                            button.style.borderColor = '#4a5568';
                            button.style.color = '#a0aec0';
                        });
                        
                        // 同时优化所有文字对比度
                        const allTextElements = document.querySelectorAll('p, li, td, th, span, div:not(.code-copy-btn)');
                        allTextElements.forEach(element => {
                            if (element.style.color && element.style.color.includes('rgb')) {
                                // 提升现有颜色的亮度
                                element.style.color = '#e2e8f0';
                            }
                        });
                    }
                    
                    // 检测网络状态
                    checkNetworkStatus();
                    
                    // 配置marked.js（如果可用）
                    configureMarked();
                    
                    // 初始化目录功能
                    initTOC();
                    
                    // 初始化Mermaid
                    initMermaid();
                    
                    // 检查viewport设置（移动端优化提醒）
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (!viewport || !viewport.content.includes('width=device-width')) {
                        console.warn('⚠️ 建议添加viewport meta标签以优化移动端显示');
                    }
                    
                    // 监听网络状态变化
                    window.addEventListener('online', () => {
                        console.log('🌐 网络已连接');
                    });
                    
                    window.addEventListener('offline', () => {
                        console.warn('🚫 网络已断开');
                    });
                    
                    console.log('✅ 页面初始化完成');
                } catch (error) {
                    console.error('❌ 初始化错误:', error);
                }
            });
            
            // 优化移动端表格显示
            function optimizeTablesForMobile(element) {
                const tables = element.querySelectorAll('table');
                tables.forEach(table => {
                    // 检查表格是否已经被包装过
                    if (table.parentElement.classList.contains('table-container')) {
                        return;
                    }
                    
                    // 创建包装容器
                    const container = document.createElement('div');
                    container.className = 'table-container';
                    
                    // 插入容器并移动表格
                    table.parentNode.insertBefore(container, table);
                    container.appendChild(table);
                    
                    // 添加移动端优化标识
                    table.setAttribute('data-mobile-optimized', 'true');
                    
                    console.log('📱 已优化表格:', table);
                });
            }
            
            // 核心功能调试
            function debugRendering() {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) return;
                
                console.log('🔍 渲染调试信息:');
                console.log('📱 环境:', /iPad|iPhone|iPod/.test(navigator.userAgent) ? 'iOS WebView' : '其他');
                console.log('🧮 MathJax:', typeof MathJax !== 'undefined' ? '已加载' : '未加载');
                console.log('🎨 Mermaid:', typeof mermaid !== 'undefined' ? '已加载' : '未加载');
                
                const mathElements = contentElement.querySelectorAll('.MathJax, .MathJax_Display');
                const mermaidElements = contentElement.querySelectorAll('.mermaid-diagram');
                
                console.log(`🧮 LaTeX元素: ${mathElements.length}`);
                console.log(`🎨 Mermaid图表: ${mermaidElements.length}`);
                
                return {
                    environment: /iPad|iPhone|iPod/.test(navigator.userAgent) ? 'iOS WebView' : '其他',
                    mathJaxLoaded: typeof MathJax !== 'undefined',
                    mermaidLoaded: typeof mermaid !== 'undefined',
                    mathElements: mathElements.length,
                    mermaidElements: mermaidElements.length
                };
            }
            
            // LaTeX调试函数 - 帮助诊断LaTeX渲染问题
            function debugLaTeXRendering() {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) return;
                
                console.log('🧮 LaTeX渲染调试信息:');
                console.log('📱 MathJax版本:', typeof MathJax !== 'undefined' ? MathJax.version : '未加载');
                console.log('🔧 MathJax配置:', typeof MathJax !== 'undefined' ? MathJax.config : '未配置');
                
                // 检查LaTeX公式元素
                const mathElements = contentElement.querySelectorAll('.MathJax, .MathJax_Display, script[type="math/tex"]');
                console.log(`🧮 发现 ${mathElements.length} 个LaTeX元素:`);
                
                mathElements.forEach((el, index) => {
                    console.log(`LaTeX元素 ${index + 1}:`, {
                        tagName: el.tagName,
                        className: el.className,
                        type: el.getAttribute('type'),
                        innerHTML: el.innerHTML.substring(0, 100) + '...',
                        isProtected: el.getAttribute('data-latex-protected')
                    });
                });
                
                // 检查原始文本中的LaTeX语法
                const allText = contentElement.textContent;
                const dollarMatches = (allText.match(/\$/g) || []).length;
                const backslashMatches = (allText.match(/\\\(/g) || []).length + (allText.match(/\\\[/g) || []).length;
                
                console.log('📝 LaTeX语法统计:', {
                    dollarSigns: dollarMatches,
                    backslashNotation: backslashMatches,
                    possibleFormulas: Math.floor(dollarMatches / 2) + backslashMatches
                });
                
                return {
                    mathElementsCount: mathElements.length,
                    mathJaxLoaded: typeof MathJax !== 'undefined',
                    possibleFormulas: Math.floor(dollarMatches / 2) + backslashMatches
                };
            }
            
            // 分片渲染支持
            window.isChunkRenderingActive = false;
            
            // 初始化分块渲染
            window.initChunkRendering = function() {
                console.log('🧩 初始化分块渲染模式');
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) {
                    throw new Error('找不到内容容器元素');
                }
                
                // 清空容器
                contentElement.innerHTML = '';
                window.isChunkRenderingActive = true;
                
                // 创建分块容器
                const chunkContainer = document.createElement('div');
                chunkContainer.id = 'chunk-container';
                chunkContainer.style.cssText = 'opacity: 0; transition: opacity 0.3s ease;';
                contentElement.appendChild(chunkContainer);
                
                console.log('✅ 分块渲染初始化完成');
                return 'chunk_rendering_initialized';
            };
            
            // 追加markdown块
            window.appendMarkdownChunk = function(chunkContent) {
                if (!window.isChunkRenderingActive) {
                    throw new Error('分块渲染未初始化');
                }
                
                console.log('🧩 处理新的内容块，长度:', chunkContent.length);
                
                const chunkContainer = document.getElementById('chunk-container');
                if (!chunkContainer) {
                    throw new Error('找不到分块容器');
                }
                
                try {
                    // 解析markdown块
                    const html = safeMarkdownParse(chunkContent);
                    
                    // 创建块元素
                    const chunkDiv = document.createElement('div');
                    chunkDiv.className = 'content-chunk';
                    chunkDiv.innerHTML = html;
                    chunkDiv.style.cssText = 'opacity: 0; transition: opacity 0.3s ease;';
                    
                    chunkContainer.appendChild(chunkDiv);
                    
                    // 淡入效果
                    setTimeout(() => {
                        chunkDiv.style.opacity = '1';
                        chunkContainer.style.opacity = '1';
                    }, 50);
                    
                    console.log('✅ 内容块添加完成');
                    return 'chunk_appended';
                } catch (error) {
                    console.error('❌ 内容块处理失败:', error);
                    throw error;
                }
            };
            
            // 完成分块渲染
            window.finishChunkRendering = function() {
                if (!window.isChunkRenderingActive) {
                    return 'not_active';
                }
                
                console.log('🧩 完成分块渲染，开始后处理...');
                
                const chunkContainer = document.getElementById('chunk-container');
                if (chunkContainer) {
                    // 应用增强功能到所有块（processEnhancements内部会调用generateTOC）
                    processEnhancements(chunkContainer);
                    
                    console.log('✅ 分块渲染完成');
                }
                
                window.isChunkRenderingActive = false;
                return 'chunk_rendering_finished';
            };
            
            // 暴露给客户端调用
            window.renderMarkdown = renderMarkdown;
            window.debugRendering = debugRendering;
            window.debugLaTeXRendering = debugLaTeXRendering;
            
                                     // 统一分块渲染 - 修复版本，确保LaTeX预处理被正确调用
            function renderOptimizedContent(content) {
                console.log('🚀 开始统一分块渲染');
                nativePrint('🚀 renderOptimizedContent开始执行');
                nativePrint(`📝 输入内容长度: ${content.length}`);
                
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) {
                    console.error('未找到内容容器元素');
                    return;
                }
                
                // 清空容器
                contentElement.innerHTML = '';
                
                // 在分块渲染前先执行LaTeX预处理
                nativePrint('🔧 在分块渲染前执行LaTeX预处理');
                let processedContent = content;
                
                // 检查预处理函数是否存在
                if (typeof window.preprocessLatexInMarkdown === 'function') {
                    nativePrint('✅ 找到预处理函数，开始处理');
                    processedContent = window.preprocessLatexInMarkdown(content);
                    nativePrint(`🔧 预处理完成，原始长度: ${content.length}, 处理后长度: ${processedContent.length}`);
                } else {
                    nativePrint('❌ 预处理函数不存在！');
                }
                
                // 创建加载提示
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'text-align: center; padding: 20px; color: #666;';
                loadingDiv.textContent = '正在渲染大文件，请稍候...';
                contentElement.appendChild(loadingDiv);
                
                // 延迟渲染以避免阻塞UI
                setTimeout(() => {
                    try {
                        // 移除加载提示
                        contentElement.removeChild(loadingDiv);
                        
                        // 使用已预处理的内容进行分步渲染
                        nativePrint('🔧 开始分步渲染已预处理的内容');
                        renderContentInSteps(processedContent, contentElement);
                        
                    } catch (error) {
                        console.error('❌ 分块渲染失败:', error);
                        nativePrint(`❌ 分块渲染失败: ${error.message}`);
                        contentElement.innerHTML = '<div style="color: red; padding: 20px;">渲染失败: ' + error.message + '</div>';
                    }
                }, 100);
            }
            
                                     // 分步渲染内容 - 简化版本，专注于正确的LaTeX处理
            function renderContentInSteps(content, container) {
                nativePrint('🚀 开始分步渲染内容');
                nativePrint(`📝 内容长度: ${content.length}`);
                
                // 注意：内容已经在renderOptimizedContent中预处理过了
                // 这里不再需要调用预处理函数，避免重复处理
                
                // 根据内容大小智能调整分块策略
                const contentSize = content.length;
                const strategy = getOptimalChunkStrategy(contentSize);
                
                // 将内容按策略分块
                const chunks = chunkContentByStrategy(content, strategy);
                const totalChunks = chunks.length;
                let currentChunk = 0;
                
                console.log(`📄 智能分块渲染: ${totalChunks} 个块, 策略: ${strategy.name}, 内容大小: ${contentSize}`);
                nativePrint(`📄 智能分块渲染开始: ${totalChunks} 个块, 策略: ${strategy.name}, 内容大小: ${contentSize}`);
                
                function renderNextChunk() {
                    nativePrint(`🔧 renderNextChunk调用: currentChunk=${currentChunk}, totalChunks=${totalChunks}`);
                    
                    if (currentChunk >= totalChunks) {
                        nativePrint('✅ 分步渲染完成 - 已达到最大块数');
                        console.log('✅ 分步渲染完成');
                        
                        // 渲染完成后处理
                        setTimeout(() => {
                            processEnhancements(container);
                            
                            // 结束性能监控
                            if (window.endRenderingTimer) {
                                window.endRenderingTimer('分块渲染');
                            }
                        }, 100);
                        
                        return;
                    }
                    
                    const chunk = chunks[currentChunk];
                    nativePrint(`🔧 获取块${currentChunk}: 长度=${chunk.length}, 内容前100字符="${chunk.substring(0, 100)}"`);
                    
                    if (chunk.trim()) {
                        nativePrint(`🔧 块内容非空，开始处理`);
                        
                        try {
                            // 使用安全的markdown解析已预处理的内容
                            nativePrint(`🔧 使用安全解析器解析第${currentChunk}块`);
                            const chunkHtml = safeMarkdownParse(chunk);
                            
                            // 创建块容器
                            const chunkDiv = document.createElement('div');
                            chunkDiv.className = 'content-chunk';
                            chunkDiv.innerHTML = chunkHtml;
                            chunkDiv.style.cssText = 'opacity: 0; transition: opacity 0.3s ease;';
                            
                            container.appendChild(chunkDiv);
                            
                            // 淡入效果
                            setTimeout(() => {
                                chunkDiv.style.opacity = '1';
                            }, 50);
                            
                            nativePrint(`✅ 第${currentChunk}块渲染完成`);
                        } catch (error) {
                            nativePrint(`❌ 第${currentChunk}块渲染失败: ${error.message}`);
                            console.error('块渲染错误:', error);
                        }
                    } else {
                        nativePrint(`🔧 块${currentChunk}内容为空，跳过处理`);
                    }
                    
                    currentChunk++;
                    nativePrint(`🔧 准备渲染下一个块: ${currentChunk}`);
                    
                    // 使用策略中的延迟时间
                    requestAnimationFrame(() => {
                        setTimeout(renderNextChunk, strategy.delay);
                    });
                }
                
                // 添加错误处理确保renderNextChunk能够被调用
                nativePrint(`🔧 准备开始调用renderNextChunk函数`);
                try {
                    renderNextChunk();
                    nativePrint(`🔧 renderNextChunk初始调用成功`);
                } catch (error) {
                    nativePrint(`❌ renderNextChunk初始调用失败: ${error.message}`);
                    console.error('❌ renderNextChunk初始调用失败:', error);
                }
            }
            
            // 处理增强功能
            function processEnhancements(container) {
                console.log('🚀 processEnhancements函数开始执行');
                nativePrint('🚀 processEnhancements函数开始执行');
                
                if (!container) {
                    console.error('❌ processEnhancements: container参数为空');
                    nativePrint('❌ processEnhancements: container参数为空');
                    return;
                }
                
                console.log('🔗 处理链接功能');
                processLinks(container);
                
                console.log('🖼️ 处理图片功能');
                addImageZoomFunction(container);
                
                console.log('📋 处理移动端优先代码复制功能');
                initializeMobileCopySystem(container);
                
                console.log('☑️ 处理任务列表功能');
                enhanceTaskLists(container);
                
                console.log('🎨 处理Mermaid图表');
                renderMermaidDiagrams(container);
                
                console.log('📱 优化移动端表格');
                optimizeTablesForMobile(container);
                
                console.log('🏷️ 优化HTML元素');
                enhanceHTMLElements(container);
                
                console.log('📑 生成目录');
                generateTOC();
                
                console.log('✅ 所有增强功能处理完成');
                
                // 最后渲染数学公式
                setTimeout(() => {
                    console.log('🧮 开始渲染LaTeX公式');
                    
                    // 预处理LaTeX公式中的中文下标（双重保护：markdown预处理 + HTML预处理）
                    preprocessChineseSubscripts(container);
                    
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        // 使用异步方式渲染，避免阻塞
                        MathJax.typesetPromise([container])
                        .then(() => {
                            console.log('✅ LaTeX渲染完成');
                        })
                        .catch((err) => {
                            console.error('❌ LaTeX渲染错误:', err);
                            // 如果Promise模式失败，尝试传统模式
                            if (MathJax.typeset) {
                                try {
                                    MathJax.typeset([container]);
                                    console.log('✅ LaTeX渲染完成 (降级模式)');
                                } catch (fallbackErr) {
                                    console.error('❌ LaTeX降级渲染也失败:', fallbackErr);
                                }
                            }
                        });
                    } else if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                        // 使用传统的typeset方法
                        try {
                            MathJax.typeset([container]);
                            console.log('✅ LaTeX渲染完成 (传统模式)');
                        } catch (err) {
                            console.error('❌ LaTeX传统渲染失败:', err);
                        }
                    } else {
                        console.warn('⚠️ MathJax未加载或不支持渲染方法');
                    }
                }, 200);
            }
            
            // 获取最佳分块策略
            function getOptimalChunkStrategy(contentSize) {
                if (contentSize < 10000) { // 小于10KB
                    return {
                        name: "快速渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 8, // 每块最多8个段落
                        delay: 30 // 30ms间隔
                    };
                } else if (contentSize < 50000) { // 10KB - 50KB
                    return {
                        name: "优化渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 5, // 每块最多5个段落
                        delay: 50 // 50ms间隔
                    };
                } else if (contentSize < 100000) { // 50KB - 100KB
                    return {
                        name: "分块渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 3, // 每块最多3个段落
                        delay: 80 // 80ms间隔
                    };
                } else { // 大于100KB
                    return {
                        name: "深度优化渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 2, // 每块最多2个段落
                        delay: 100 // 100ms间隔
                    };
                }
            }
            
            // 根据策略分块内容
            function chunkContentByStrategy(content, strategy) {
                // 按段落分割
                const paragraphs = content.split('\n\n').filter(p => p.trim().length > 0);
                const chunks = [];
                
                if (strategy.chunkType === "paragraph") {
                    // 按段落数量分块
                    for (let i = 0; i < paragraphs.length; i += strategy.maxChunkSize) {
                        const chunkParagraphs = paragraphs.slice(i, i + strategy.maxChunkSize);
                        chunks.push(chunkParagraphs.join('\n\n'));
                    }
                }
                
                // 确保至少有一个块
                if (chunks.length === 0) {
                    chunks.push(content);
                }
                
                return chunks;
            }
            

        </script>
        
    </body>
</html>
