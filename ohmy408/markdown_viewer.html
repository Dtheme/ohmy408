<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Markdown + LaTeX 阅读器</title>
                <!-- 引入 Marked.js -->
                <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
                <!-- 引入 MathJax 配置 -->
                <script>
                    window.MathJax = {
                        tex: {
                            inlineMath: [['$', '$'], ['\\(', '\\)']],     // 行内公式分隔符
                            displayMath: [['$$', '$$'], ['\\[', '\\]']], // 块级公式分隔符
                            processEscapes: true,                        // 支持反斜杠转义
                            processEnvironments: true,                   // 支持环境
                            packages: {
                                '[+]': ['base', 'ams', 'amssymb', 'boldsymbol', 'physics', 'mhchem', 'newcommand', 'configmacros']
                            },
                            tags: 'ams',                                 // 公式编号
                            tagSide: 'right',                           // 编号位置
                            tagIndent: '0.8em'                          // 编号缩进
                        },
                        chtml: {
                            scale: 1.1,                                 // 公式缩放
                            minScale: 0.5,                              // 最小缩放
                            matchFontHeight: false,                     // 匹配字体高度
                            displayAlign: 'center',                     // 居中对齐
                            displayIndent: '0em'                        // 显示缩进
                        },
                        startup: {
                            typeset: false                              // 禁止自动初始化，手动控制渲染
                        },
                        loader: {
                            load: ['[tex]/mhchem', '[tex]/physics', '[tex]/configmacros']
                        }
                    };
                </script>
                <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        max-width: 100%;
                        margin: 0;
                        padding: 20px;
                        box-sizing: border-box;
                    }
                    
                    #rendered-content {
                        max-width: 100%;
                        margin: 0 auto;
                    }
                    
                    /* 标题样式 */
                    h1, h2, h3, h4, h5, h6 {
                        margin-top: 1.5em;
                        margin-bottom: 0.5em;
                        font-weight: 600;
                        line-height: 1.25;
                    }
                    
                    h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
                    h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
                    h3 { font-size: 1.25em; }
                    h4 { font-size: 1em; }
                    h5 { font-size: 0.875em; }
                    h6 { font-size: 0.85em; color: #666; }
                    
                    /* 段落样式 */
                    p {
                        margin-bottom: 1em;
                    }
                    
                    /* 代码样式 */
                    code {
                        background-color: #f6f8fa;
                        border-radius: 3px;
                        font-size: 85%;
                        margin: 0;
                        padding: 2px 4px;
                        font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', Consolas, 'Courier New', monospace;
                    }
                    
                    pre {
                        background-color: #f6f8fa;
                        border-radius: 6px;
                        font-size: 85%;
                        line-height: 1.45;
                        overflow: auto;
                        padding: 16px;
                        margin: 1em 0;
                    }
                    
                    pre code {
                        background-color: transparent;
                        border: 0;
                        display: inline;
                        line-height: inherit;
                        margin: 0;
                        overflow: visible;
                        padding: 0;
                        word-wrap: normal;
                    }
                    
                    /* 引用样式 */
                    blockquote {
                        border-left: 4px solid #dfe2e5;
                        margin: 1em 0;
                        padding: 0 1em;
                        color: #6a737d;
                    }
                    
                    /* 列表样式 */
                    ul, ol {
                        margin-bottom: 1em;
                        padding-left: 2em;
                    }
                    
                    li {
                        margin-bottom: 0.25em;
                    }
                    
                    /* 表格样式 */
                    table {
                        border-collapse: collapse;
                        border-spacing: 0;
                        width: 100%;
                        margin: 1em 0;
                        overflow: auto;
                        display: block;
                        white-space: nowrap;
                    }
                    
                    table thead tr {
                        background-color: #f6f8fa;
                    }
                    
                    table th, table td {
                        border: 1px solid #dfe2e5;
                        padding: 6px 13px;
                        text-align: left;
                    }
                    
                    table th {
                        font-weight: 600;
                    }
                    
                    table tr:nth-child(2n) {
                        background-color: #f6f8fa;
                    }
                    
                    /* 链接样式 */
                    a {
                        color: #0366d6;
                        text-decoration: none;
                    }
                    
                    a:hover {
                        text-decoration: underline;
                    }
                    
                    /* 分割线样式 */
                    hr {
                        border: 0;
                        border-top: 1px solid #eee;
                        margin: 2em 0;
                    }
                    
                    /* 图片样式 */
                    img {
                        max-width: 100%;
                        height: auto;
                        border-radius: 4px;
                        margin: 0.5em 0;
                        cursor: zoom-in;
                        transition: transform 0.2s ease;
                    }
                    
                    img:hover {
                        transform: scale(1.02);
                    }
                    
                    /* MathJax 公式样式 */
                    .MathJax {
                        font-size: 1.1em !important;
                    }
                    
                    .MathJax_Display {
                        margin: 1em 0 !important;
                    }
                    
                    /* 响应式设计 */
                    @media (max-width: 768px) {
                        body {
                            padding: 10px;
                            font-size: 14px;
                        }
                        
                        table {
                            font-size: 12px;
                        }
                    }
                    
                    /* 暗色模式支持 */
                    @media (prefers-color-scheme: dark) {
                        body:not(.light-mode) {
                            background-color: #0d1117;
                            color: #c9d1d9;
                        }
                        
                        body:not(.light-mode) h1, body:not(.light-mode) h2 {
                            border-bottom-color: #21262d;
                        }
                        
                        body:not(.light-mode) h6 {
                            color: #8b949e;
                        }
                        
                        body:not(.light-mode) code {
                            background-color: #161b22;
                            color: #e6edf3;
                        }
                        
                        body:not(.light-mode) pre {
                            background-color: #161b22;
                        }
                        
                        body:not(.light-mode) blockquote {
                            border-left-color: #3c434b;
                            color: #8b949e;
                        }
                        
                        body:not(.light-mode) table th, body:not(.light-mode) table td {
                            border-color: #30363d;
                        }
                        
                        body:not(.light-mode) table thead tr, body:not(.light-mode) table tr:nth-child(2n) {
                            background-color: #161b22;
                        }
                        
                        body:not(.light-mode) a {
                            color: #58a6ff;
                        }
                        
                        body:not(.light-mode) hr {
                            border-top-color: #21262d;
                        }
                        
                        /* 代码复制按钮自动暗色模式样式 */
                        body:not(.light-mode) .code-copy-button {
                            background-color: #21262d !important;
                            color: #c9d1d9 !important;
                            border-color: #30363d !important;
                        }
                        
                        body:not(.light-mode) .code-copy-button:hover {
                            background-color: #30363d !important;
                        }
                        
                        body:not(.light-mode) #theme-toggle {
                            background-color: #21262d;
                            color: #c9d1d9;
                            border-color: #30363d;
                        }
                        
                        body:not(.light-mode) #theme-toggle:hover {
                            background-color: #30363d;
                        }
                    }
                    
                    /* 手动深色模式 */
                    body.dark-mode {
                        background-color: #0d1117;
                        color: #c9d1d9;
                    }
                    
                    body.dark-mode h1, body.dark-mode h2 {
                        border-bottom-color: #21262d;
                    }
                    
                    body.dark-mode h6 {
                        color: #8b949e;
                    }
                    
                    body.dark-mode code {
                        background-color: #161b22;
                        color: #e6edf3;
                    }
                    
                    body.dark-mode pre {
                        background-color: #161b22;
                    }
                    
                    body.dark-mode blockquote {
                        border-left-color: #3c434b;
                        color: #8b949e;
                    }
                    
                    body.dark-mode table th, body.dark-mode table td {
                        border-color: #30363d;
                    }
                    
                    body.dark-mode table thead tr, body.dark-mode table tr:nth-child(2n) {
                        background-color: #161b22;
                    }
                    
                    body.dark-mode a {
                        color: #58a6ff;
                    }
                    
                    body.dark-mode hr {
                        border-top-color: #21262d;
                    }
                    
                    body.dark-mode #theme-toggle {
                        background-color: #21262d;
                        color: #c9d1d9;
                        border-color: #30363d;
                    }
                    
                    body.dark-mode #theme-toggle:hover {
                        background-color: #30363d;
                    }
                    
                    /* 暗色模式下的目录样式 */
                    body.dark-mode #toc-panel {
                        background-color: #161b22 !important;
                        border-right-color: #30363d !important;
                        color: #c9d1d9 !important;
                    }
                    
                    body.dark-mode #toc-toggle {
                        background-color: #21262d !important;
                        border-color: #30363d !important;
                        color: #c9d1d9 !important;
                    }
                    
                    body.dark-mode #toc-toggle:hover {
                        background-color: #30363d !important;
                    }
                    
                    /* 目录链接样式优化 */
                    .toc-link:hover {
                        background-color: #f3f4f6 !important;
                        color: #0969da !important;
                    }
                    
                    body.dark-mode .toc-link:hover {
                        background-color: #30363d !important;
                        color: #58a6ff !important;
                    }
                    
                    /* 代码复制按钮暗色模式样式 */
                    body.dark-mode .code-copy-button {
                        background-color: #21262d !important;
                        color: #c9d1d9 !important;
                        border-color: #30363d !important;
                    }
                    
                    body.dark-mode .code-copy-button:hover {
                        background-color: #30363d !important;
                    }
                    
                    /* 目录面板打开状态 */
                    #toc-panel.open {
                        left: 0 !important;
                    }
                    
                    /* 响应式设计 - 移动端优化 */
                    @media (max-width: 480px) {
                        /* 小屏幕：目录面板全屏 */
                        #toc-panel {
                            width: 100vw !important;
                            left: -100vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                    }
                    
                    @media (min-width: 481px) and (max-width: 768px) {
                        /* 中等屏幕：目录面板70% */
                        #toc-panel {
                            width: 70vw !important;
                            left: -70vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        /* 移动端按钮调整 */
                        div[style*="left: 20px"] {
                            top: 10px !important;
                            left: 10px !important;
                        }
                        
                        div[style*="right: 20px"] {
                            top: 10px !important;
                            right: 10px !important;
                        }
                        
                        #toc-toggle, #theme-toggle {
                            padding: 6px 10px !important;
                            font-size: 12px !important;
                            -webkit-tap-highlight-color: transparent;
                            touch-action: manipulation;
                        }
                        
                        /* 优化目录面板头部 */
                        #toc-panel > div:first-child {
                            padding-top: 50px !important;
                        }
                    }
                    
                    /* 主题切换按钮样式 */
                    #theme-toggle {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background-color: #f6f8fa;
                        border: 1px solid #d0d7de;
                        border-radius: 6px;
                        padding: 8px 12px;
                        cursor: pointer;
                        font-size: 14px;
                        font-family: inherit;
                        transition: all 0.2s ease;
                        z-index: 1000;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    }
                    
                    #theme-toggle:hover {
                        background-color: #f3f4f6;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
                    }
                    
                    #theme-toggle:active {
                        transform: translateY(0);
                    }
                    
                    /* 响应式设计 - 移动端调整按钮位置 */
                    @media (max-width: 768px) {
                        #theme-toggle {
                            top: 10px;
                            right: 10px;
                            padding: 6px 10px;
                            font-size: 12px;
                        }
                    }
                </style>
            </head>
    <body>
        <!-- 左侧目录按钮 -->
        <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
            <button id="toc-toggle" style="background-color: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);" title="切换目录">
                目录
            </button>
        </div>
        
        <!-- 右侧主题切换按钮 -->
        <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
            <button id="theme-toggle" style="background-color: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);" title="切换深色/浅色模式">深色</button>
        </div>
        
        <!-- 目录面板 -->
        <div id="toc-panel" style="width: 280px; background-color: #f6f8fa; border-right: 1px solid #d0d7de; position: fixed; top: 0; left: -280px; height: 100vh; height: 100dvh; overflow-y: auto; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 998; box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1); will-change: transform;">
            <div style="padding: 20px; padding-top: 60px; border-bottom: 1px solid #d0d7de;">
                <h3 style="font-size: 16px; font-weight: 600; margin: 0;">目录</h3>
            </div>
            <div style="padding: 20px;">
                <ul id="toc-list" style="list-style: none; padding: 0; margin: 0;">
                    <!-- 目录将自动生成 -->
                </ul>
            </div>
        </div>
        
        <div id="rendered-content"></div>
        
        <script>
            
            // 配置 Marked.js
            marked.setOptions({
                breaks: true,        // 支持换行
                tables: true,        // 支持表格
                gfm: true,          // 支持GitHub Flavored Markdown
                headerIds: true,     // 生成标题ID
                smartLists: true,    // 智能列表
                smartypants: true,   // 智能标点
                xhtml: true,         // XHTML兼容
                mangle: false,       // 禁用邮箱混淆
                sanitize: false      // 禁用HTML清理
            });
            
            var text = "";
            
            // 主题管理
            class ThemeManager {
                constructor() {
                    this.init();
                }
                
                init() {
                    // 从本地存储获取主题设置
                    const savedTheme = localStorage.getItem('theme');
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    
                    // 确定初始主题
                    if (savedTheme) {
                        this.setTheme(savedTheme);
                    } else if (systemPrefersDark) {
                        this.setTheme('dark');
                    } else {
                        this.setTheme('light');
                    }
                    
                    // 绑定切换按钮事件
                    const toggleButton = document.getElementById('theme-toggle');
                    toggleButton.addEventListener('click', () => this.toggleTheme());
                    
                    // 监听系统主题变化
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                }
                
                setTheme(theme) {
                    const body = document.body;
                    const toggleButton = document.getElementById('theme-toggle');
                    
                    // 移除所有主题类
                    body.classList.remove('dark-mode', 'light-mode');
                    
                    if (theme === 'dark') {
                        body.classList.add('dark-mode');
                        toggleButton.textContent = '浅色';
                        toggleButton.title = '切换到浅色模式';
                    } else {
                        body.classList.add('light-mode');
                        toggleButton.textContent = '深色';
                        toggleButton.title = '切换到深色模式';
                    }
                    
                    // 保存到本地存储
                    localStorage.setItem('theme', theme);
                    this.currentTheme = theme;
                }
                
                toggleTheme() {
                    const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                    this.setTheme(newTheme);
                }
                
                getCurrentTheme() {
                    return this.currentTheme;
                }
            }
            
            // 初始化主题管理器
            const themeManager = new ThemeManager();
            
            // 目录管理
            let tocOpen = false;
            
            // 初始化目录功能
            function initTOC() {
                const toggleButton = document.getElementById('toc-toggle');
                const tocPanel = document.getElementById('toc-panel');
                
                // 切换目录显示
                function toggleTOC() {
                    tocOpen = !tocOpen;
                    if (tocOpen) {
                        tocPanel.classList.add('open');
                    } else {
                        tocPanel.classList.remove('open');
                    }
                }
                
                // 关闭目录
                function closeTOC() {
                    if (tocOpen) {
                        tocOpen = false;
                        tocPanel.classList.remove('open');
                    }
                }
                
                // 绑定切换按钮事件（支持触摸）
                toggleButton.addEventListener('click', toggleTOC);
                toggleButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    toggleTOC();
                });
                
                // 点击面板外区域关闭目录（支持触摸）
                function handleOutsideClick(e) {
                    if (tocOpen && !e.target.closest('#toc-panel') && !e.target.closest('#toc-toggle')) {
                        closeTOC();
                    }
                }
                
                document.addEventListener('click', handleOutsideClick);
                document.addEventListener('touchend', handleOutsideClick);
                
                // 暴露关闭函数供目录链接使用
                window.closeTOC = closeTOC;
            }
            
            // 生成目录
            function generateTOC() {
                const headers = document.querySelectorAll('#rendered-content h1, #rendered-content h2, #rendered-content h3, #rendered-content h4, #rendered-content h5, #rendered-content h6');
                const tocList = document.getElementById('toc-list');
                
                if (headers.length === 0) {
                    tocList.innerHTML = '<li style="color: #666; padding: 12px; text-align: center;">无标题</li>';
                    return;
                }
                
                // 清空目录并移除之前的事件监听器
                tocList.innerHTML = '';
                
                // 使用事件委托而不是为每个链接添加监听器
                const handleTocClick = (e) => {
                    const link = e.target.closest('a[data-target]');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.getAttribute('data-target');
                        const element = document.getElementById(targetId);
                        if (element) {
                            // 使用requestAnimationFrame确保平滑滚动
                            const scrollToElement = () => {
                                try {
                                    element.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案：直接滚动
                                    element.scrollIntoView();
                                }
                            };
                            
                            requestAnimationFrame(scrollToElement);
                            
                            // 在移动端点击后关闭目录
                            if (window.innerWidth <= 768) {
                                setTimeout(() => {
                                    if (window.closeTOC) window.closeTOC();
                                }, 300);
                            }
                        }
                    }
                };
                
                // 移除旧的事件监听器并添加新的
                tocList.removeEventListener('click', handleTocClick);
                tocList.addEventListener('click', handleTocClick);
                
                // 生成目录项
                headers.forEach((header, index) => {
                    const level = parseInt(header.tagName.substring(1));
                    const text = header.textContent.trim();
                    
                    // 为标题添加ID（如果没有的话）
                    if (!header.id) {
                        header.id = `heading-${index}`;
                    }
                    
                    const listItem = document.createElement('li');
                    listItem.style.margin = '4px 0';
                    
                    const link = document.createElement('a');
                    link.href = `#${header.id}`;
                    link.setAttribute('data-target', header.id);
                    link.textContent = text;
                    
                    // 根据主题设置样式
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const textColor = isDarkMode ? '#c9d1d9' : '#24292f';
                    
                    link.style.cssText = `
                        display: block;
                        padding: 6px 12px;
                        color: ${textColor};
                        text-decoration: none;
                        border-radius: 4px;
                        transition: background-color 0.2s ease;
                        font-size: 14px;
                        padding-left: ${12 + (level - 1) * 12}px;
                        ${level === 1 ? 'font-weight: 600;' : ''}
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                    `;
                    
                    // 使用CSS hover而不是JavaScript事件以提升性能
                    link.className = 'toc-link';
                    
                    listItem.appendChild(link);
                    tocList.appendChild(listItem);
                });
            }
            
            // 处理链接显示和交互
            function processLinks(element) {
                const links = element.querySelectorAll('a[href]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    
                    if (!href) return;
                    
                    // 为外链添加图标标识
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        // 外链图标
                        if (!link.querySelector('.external-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'external-link-icon';
                            icon.innerHTML = ' ↗';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('mailto:')) {
                        // 邮件链接图标
                        if (!link.querySelector('.email-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'email-link-icon';
                            icon.innerHTML = ' ✉';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('tel:')) {
                        // 电话链接图标
                        if (!link.querySelector('.phone-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'phone-link-icon';
                            icon.innerHTML = ' 📞';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('#')) {
                        // 锚点链接 - 添加特殊处理确保平滑滚动
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const targetId = href.substring(1);
                            const targetElement = document.getElementById(targetId);
                            if (targetElement) {
                                try {
                                    targetElement.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案
                                    targetElement.scrollIntoView();
                                }
                            }
                        });
                    }
                });
            }
            
                                // 添加图片点击放大功能
            function addImageZoomFunction(element) {
                const images = element.querySelectorAll('img');
                images.forEach(img => {
                    // 避免重复添加事件监听器
                    if (img.dataset.zoomEnabled) {
                        return;
                    }
                    
                    // 标记已处理
                    img.dataset.zoomEnabled = 'true';
                    
                    // 添加点击事件
                    img.addEventListener('click', function() {
                        showImageModal(this);
                    });
                });
            }
            
            // 显示图片放大模态框
            function showImageModal(img) {
                // 创建模态框
                const modal = document.createElement('div');
                modal.className = 'image-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: zoom-out;
                `;
                
                // 创建放大的图片
                const modalImg = document.createElement('img');
                modalImg.src = img.src;
                modalImg.alt = img.alt;
                modalImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;
                
                modal.appendChild(modalImg);
                
                // 添加关闭事件
                modal.addEventListener('click', function() {
                    modal.remove();
                });
                
                // 添加ESC键关闭
                const handleEsc = function(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                document.body.appendChild(modal);
            }
            
                                // 添加代码复制功能
            function addCodeCopyButtons(element) {
                const preElements = element.querySelectorAll('pre code');
                preElements.forEach(code => {
                    const pre = code.parentElement;
                    
                    // 避免重复添加按钮
                    if (pre.querySelector('.code-copy-button')) {
                        return;
                    }
                    
                    // 创建复制按钮
                    const copyButton = document.createElement('button');
                    copyButton.className = 'code-copy-button';
                    copyButton.textContent = '复制';
                    copyButton.style.cssText = `
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background-color: #f6f8fa;
                        border: 1px solid #d0d7de;
                        border-radius: 4px;
                        padding: 4px 8px;
                        font-size: 12px;
                        cursor: pointer;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        z-index: 1;
                        font-family: inherit;
                    `;
                    
                    // 设置pre元素为相对定位
                    pre.style.position = 'relative';
                    
                    // 检查当前主题并应用相应样式
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      (!document.body.classList.contains('light-mode') && 
                                       window.matchMedia('(prefers-color-scheme: dark)').matches);
                    
                    if (isDarkMode) {
                        copyButton.style.backgroundColor = '#21262d';
                        copyButton.style.color = '#c9d1d9';
                        copyButton.style.borderColor = '#30363d';
                    }
                    
                    // 鼠标悬停显示按钮
                    pre.addEventListener('mouseenter', () => {
                        copyButton.style.opacity = '1';
                    });
                    
                    pre.addEventListener('mouseleave', () => {
                        copyButton.style.opacity = '0';
                    });
                    
                    // 点击复制
                    copyButton.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(code.textContent);
                            copyButton.textContent = '已复制';
                            setTimeout(() => {
                                copyButton.textContent = '复制';
                            }, 2000);
                        } catch (err) {
                            // 降级方案
                            const textArea = document.createElement('textarea');
                            textArea.value = code.textContent;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            copyButton.textContent = '已复制';
                            setTimeout(() => {
                                copyButton.textContent = '复制';
                            }, 2000);
                        }
                    });
                    
                    pre.appendChild(copyButton);
                });
            }
            
            // 优化任务列表样式
            function enhanceTaskLists(element) {
                const taskItems = element.querySelectorAll('li');
                taskItems.forEach(item => {
                    const text = item.innerHTML;
                    // 检查是否为任务列表项
                    if (text.includes('☐') || text.includes('☑') || text.includes('✓') || 
                        text.includes('[ ]') || text.includes('[x]') || text.includes('[X]')) {
                        
                        // 替换任务列表标记
                        let newText = text
                            .replace(/☐|☑|✓|\[[ ]\]|\[x\]|\[X\]/g, (match) => {
                                const isChecked = match === '☑' || match === '✓' || match === '[x]' || match === '[X]';
                                return `<input type="checkbox" ${isChecked ? 'checked' : ''} disabled style="margin-right: 8px;">`;
                            });
                        
                        item.innerHTML = newText;
                        item.style.listStyle = 'none';
                        item.style.marginLeft = '-20px';
                        
                        // 如果已完成，添加删除线样式
                        if (text.includes('☑') || text.includes('✓') || text.includes('[x]') || text.includes('[X]')) {
                            item.style.textDecoration = 'line-through';
                            item.style.opacity = '0.7';
                        }
                    }
                });
            }
            
            // 渲染函数
            function renderMarkdown(markdownText) {
                try {
                    // 直接渲染完整的Markdown内容
                    text = markdownText;
                    const html = marked.parse(text);
                    const contentElement = document.getElementById('rendered-content');
                    
                    if (!contentElement) {
                        console.error('未找到内容容器元素');
                        return;
                    }
                    
                    contentElement.innerHTML = html;
                    
                    // 使用requestAnimationFrame确保DOM更新后再处理增强功能
                    requestAnimationFrame(() => {
                        try {
                            // 处理链接显示和交互
                            processLinks(contentElement);
                            
                            // 添加图片点击放大功能
                            addImageZoomFunction(contentElement);
                            
                            // 添加代码复制功能
                            addCodeCopyButtons(contentElement);
                            
                            // 优化任务列表样式
                            enhanceTaskLists(contentElement);
                            
                            // 生成目录
                            generateTOC();
                        } catch (error) {
                            console.error('增强功能处理错误:', error);
                        }
                    });
                    
                    // 渲染数学公式
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([contentElement])
                            .then(() => {
                                console.log('MathJax渲染完成');
                            })
                            .catch((err) => {
                                console.error('MathJax渲染错误:', err);
                            });
                    }
                        
                } catch (error) {
                    console.error('Markdown渲染错误:', error);
                    const contentElement = document.getElementById('rendered-content');
                    if (contentElement) {
                        contentElement.innerHTML = 
                            '<div style="color: red; padding: 20px;">渲染错误: ' + error.message + '</div>';
                    }
                }
            }
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    initTOC();
                    
                    // 检查viewport设置（移动端优化提醒）
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (!viewport || !viewport.content.includes('width=device-width')) {
                        console.warn('建议添加viewport meta标签以优化移动端显示');
                    }
                } catch (error) {
                    console.error('初始化错误:', error);
                }
            });
            
            // 暴露给客户端调用
            window.renderMarkdown = renderMarkdown;
        </script>
        
    </body>
</html>
