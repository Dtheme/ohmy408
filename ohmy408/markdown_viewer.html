<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Markdown + LaTeX 阅读器</title>
                <!-- 引入 Marked.js -->
                <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onload="window.markedLoaded=true;" onerror="window.markedLoadError=true;"></script>
                <!-- 备用CDN链接 -->
                <script>
                    // 早期加载检测
                    window.markedReady = false;
                    window.markedLoaded = false;
                    window.markedLoadError = false;
                    
                    // 监听主脚本加载状态
                    window.addEventListener('load', function() {
                        setTimeout(function() {
                            if (typeof marked !== 'undefined' && window.markedLoaded) {
                                console.log('✅ Marked.js主CDN加载成功');
                                window.markedReady = true;
                            } else if (window.markedLoadError || typeof marked === 'undefined') {
                                console.warn('⚠️ 主CDN加载失败，尝试备用CDN');
                                var fallbackScript = document.createElement('script');
                                fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js';
                                fallbackScript.onload = function() {
                                    console.log('✅ 备用CDN加载成功');
                                    window.markedReady = true;
                                };
                                fallbackScript.onerror = function() {
                                    console.error('❌ 备用CDN也加载失败，使用简单markdown解析器');
                                    window.markedReady = false;
                                    // 确保简单解析器被初始化
                                    if (typeof initSimpleMarkdownParser === 'function') {
                                        initSimpleMarkdownParser();
                                    }
                                };
                                document.head.appendChild(fallbackScript);
                            }
                        }, 100); // 给主脚本100ms加载时间
                    });
                </script>
                <!-- 引入 MathJax 配置 -->
                <script>
                    window.MathJax = {
                        tex: {
                            inlineMath: [['$', '$'], ['\\(', '\\)']],     // 行内公式分隔符
                            displayMath: [['$$', '$$'], ['\\[', '\\]']], // 块级公式分隔符
                            processEscapes: true,                        // 支持反斜杠转义
                            processEnvironments: true,                   // 支持环境
                            packages: {
                                '[+]': ['base', 'ams', 'amssymb', 'boldsymbol', 'physics', 'mhchem', 'newcommand', 'configmacros', 'color', 'textmacros']
                            },
                            macros: {
                                // 中文数制表示宏定义
                                '原': '\\text{原}',
                                '反': '\\text{反}',
                                '补': '\\text{补}',
                                '码': '\\text{码}',
                                // 英文数制表示宏定义
                                'orig': '\\text{orig}',
                                'inv': '\\text{inv}',
                                'comp': '\\text{comp}',
                                'code': '\\text{code}',
                                // 其他常用宏
                                'binary': '\\text{binary}',
                                'decimal': '\\text{decimal}',
                                'hex': '\\text{hex}',
                                'octal': '\\text{octal}'
                            },
                            tags: 'ams',                                 // 公式编号
                            tagSide: 'right',                           // 编号位置
                            tagIndent: '0.8em'                          // 编号缩进
                        },
                        chtml: {
                            scale: 1.1,                                 // 公式缩放
                            minScale: 0.5,                              // 最小缩放
                            matchFontHeight: false,                     // 匹配字体高度
                            displayAlign: 'center',                     // 居中对齐
                            displayIndent: '0em',                       // 显示缩进
                            fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'  // 字体支持
                        },
                        startup: {
                            typeset: false                              // 禁止自动初始化，手动控制渲染
                        },
                        loader: {
                            load: ['[tex]/mhchem', '[tex]/physics', '[tex]/configmacros', '[tex]/color', '[tex]/textmacros']
                        }
                    };
                </script>
                <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
                <!-- 引入 Mermaid.js -->
                <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        max-width: 100%;
                        margin: 0;
                        padding: 20px;
                        box-sizing: border-box;
                    }
                    
                    #rendered-content {
                        max-width: 100%;
                        margin: 0 auto;
                    }
                    
                    /* 标题样式 */
                    h1, h2, h3, h4, h5, h6 {
                        margin-top: 1.5em;
                        margin-bottom: 0.5em;
                        font-weight: 600;
                        line-height: 1.25;
                    }
                    
                    h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
                    h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
                    h3 { font-size: 1.25em; }
                    h4 { font-size: 1em; }
                    h5 { font-size: 0.875em; }
                    h6 { font-size: 0.85em; color: #666; }
                    
                    /* 段落样式 */
                    p {
                        margin-bottom: 1em;
                    }
                    
                    /* 代码样式 */
                    code {
                        background-color: #f6f8fa;
                        border-radius: 3px;
                        font-size: 85%;
                        margin: 0;
                        padding: 2px 4px;
                        font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', Consolas, 'Courier New', monospace;
                    }
                    
                    pre {
                        background-color: #f6f8fa;
                        border-radius: 6px;
                        font-size: 85%;
                        line-height: 1.45;
                        overflow: auto;
                        padding: 16px;
                        margin: 1em 0;
                    }
                    
                    pre code {
                        background-color: transparent;
                        border: 0;
                        display: inline;
                        line-height: inherit;
                        margin: 0;
                        overflow: visible;
                        padding: 0;
                        word-wrap: normal;
                    }
                    
                    /* 引用样式 */
                    blockquote {
                        border-left: 4px solid #dfe2e5;
                        margin: 1em 0;
                        padding: 0 1em;
                        color: #6a737d;
                    }
                    
                    /* 列表样式 */
                    ul, ol {
                        margin-bottom: 1em;
                        padding-left: 2em;
                    }
                    
                    li {
                        margin-bottom: 0.25em;
                    }
                    
                    /* 表格样式优化 */
                    table {
                        border-collapse: collapse;
                        border-spacing: 0;
                        width: 100%;
                        margin: 1em 0;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        background-color: #ffffff;
                        display: table;
                    }
                    
                    table thead tr {
                        background: linear-gradient(135deg, #f6f8fa 0%, #e1e7eb 100%);
                    }
                    
                    table th, table td {
                        border: 1px solid #dfe2e5;
                        padding: 12px 16px;
                        text-align: left;
                        word-wrap: break-word;
                        vertical-align: top;
                    }
                    
                    table th {
                        font-weight: 600;
                        color: #24292f;
                        font-size: 14px;
                        letter-spacing: 0.5px;
                    }
                    
                    table tr:nth-child(2n) {
                        background-color: #f8f9fa;
                    }
                    
                    table tr:hover {
                        background-color: #f1f3f4;
                        transition: background-color 0.2s ease;
                    }
                    
                    /* 表格响应式优化 */
                    @media (max-width: 768px) {
                        table {
                            font-size: 13px;
                            margin: 0.5em 0;
                        }
                        
                        table th, table td {
                            padding: 8px 12px;
                        }
                        
                        /* 小屏幕表格滚动 */
                        .table-container {
                            overflow-x: auto;
                            margin: 1em 0;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        }
                    }
                    
                    /* 链接样式 */
                    a {
                        color: #0366d6;
                        text-decoration: none;
                    }
                    
                    a:hover {
                        text-decoration: underline;
                    }
                    
                    /* 分割线样式 */
                    hr {
                        border: 0;
                        border-top: 1px solid #eee;
                        margin: 2em 0;
                    }
                    
                    /* 图片样式 */
                    img {
                        max-width: 100%;
                        height: auto;
                        border-radius: 4px;
                        margin: 0.5em 0;
                        cursor: zoom-in;
                        transition: transform 0.2s ease;
                    }
                    
                    img:hover {
                        transform: scale(1.02);
                    }
                    
                    /* MathJax 公式样式 */
                    .MathJax {
                        font-size: 1.1em !important;
                    }
                    
                    .MathJax_Display {
                        margin: 1em 0 !important;
                    }
                    
                    /* 响应式设计 */
                    @media (max-width: 768px) {
                        body {
                            padding: 10px;
                            font-size: 14px;
                        }
                        
                        table {
                            font-size: 12px;
                        }
                    }
                    
                    /* 暗色模式支持 */
                    /* 深色模式 - 系统自动检测 */
                    @media (prefers-color-scheme: dark) {
                        body:not(.light-mode) {
                            background-color: #0d1117;
                            color: #e6edf3;
                            transition: all 0.3s ease;
                        }
                        
                        /* 标题深度优化 */
                        body:not(.light-mode) h1, body:not(.light-mode) h2 {
                            border-bottom: 1px solid transparent;
                            color: #f0f6fc;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
                        }
                        
                        body:not(.light-mode) h3, body:not(.light-mode) h4, body:not(.light-mode) h5 {
                            color: #e6edf3;
                        }
                        
                        body:not(.light-mode) h6 {
                            color: #8b949e;
                        }
                        
                        /* 代码块深度优化 */
                        body:not(.light-mode) code {
                            background-color: #161b22;
                            color: #e6edf3;
                        }
                        
                        body:not(.light-mode) pre {
                            background-color: #161b22;
                        }
                        
                        /* 引用块深度优化 */
                        body:not(.light-mode) blockquote {
                            border-left: 4px solid #58a6ff;
                            color: #8b949e;
                            background-color: #161b22;
                            border-radius: 6px;
                            padding: 16px;
                            margin: 16px 0;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                        }
                        
                        /* 表格深度优化 */
                        body:not(.light-mode) table {
                            border: 1px solid #30363d;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                            background-color: #0d1117;
                        }
                        
                        body:not(.light-mode) table th, body:not(.light-mode) table td {
                            border: 1px solid #30363d;
                            background-color: #0d1117;
                            color: #e6edf3;
                        }
                        
                        body:not(.light-mode) table thead tr {
                            background: linear-gradient(135deg, #21262d 0%, #30363d 100%);
                        }
                        
                        body:not(.light-mode) table th {
                            color: #f0f6fc;
                            font-weight: 600;
                        }
                        
                        body:not(.light-mode) table tr:nth-child(2n) {
                            background-color: #161b22;
                        }
                        
                        body:not(.light-mode) table tr:hover {
                            background-color: #21262d;
                            transition: background-color 0.2s ease;
                        }
                        
                        body:not(.light-mode) table th {
                            color: #f0f6fc;
                            font-weight: 600;
                        }
                        
                        /* 链接深度优化 */
                        body:not(.light-mode) a {
                            color: #58a6ff;
                            transition: all 0.2s ease;
                            text-decoration: none;
                        }
                        
                        body:not(.light-mode) a:hover {
                            color: #79c0ff;
                            text-shadow: 0 0 8px rgba(88, 166, 255, 0.3);
                        }
                        
                        /* 分割线深度优化 */
                        body:not(.light-mode) hr {
                            border-top: 1px solid #30363d;
                            background: linear-gradient(90deg, transparent, #30363d, transparent);
                            opacity: 0.8;
                        }
                        
                        /* 代码复制按钮深度优化 */
                        body:not(.light-mode) .code-copy-button {
                            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
                            color: #e6edf3 !important;
                            border: 1px solid #30363d !important;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                            transition: all 0.3s ease !important;
                        }
                        
                        body:not(.light-mode) .code-copy-button:hover {
                            background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
                            color: #f0f6fc !important;
                            transform: translateY(-2px) !important;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
                        }
                        

                        
                        /* 目录按钮磨砂玻璃风格 */
                        body:not(.light-mode) #toc-toggle {
                            background: rgba(255, 255, 255, 0.1) !important;
                            color: #e6edf3 !important;
                            border: 1px solid rgba(255, 255, 255, 0.2) !important;
                            backdrop-filter: blur(10px) !important;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                            transition: all 0.3s ease !important;
                        }
                        
                        body:not(.light-mode) #toc-toggle:hover {
                            background: rgba(255, 255, 255, 0.2) !important;
                            color: #f0f6fc !important;
                            transform: translateY(-2px) !important;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
                        }
                    }
                    
                    /* 手动深色模式 - 深度优化 */
                    body.dark-mode {
                        background-color: #0d1117;
                        color: #e6edf3;
                        transition: all 0.3s ease;
                    }
                    
                    /* 标题深度优化 */
                    body.dark-mode h1, body.dark-mode h2 {
                        border-bottom: 1px solid transparent;
                        color: #f0f6fc;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
                    }
                    
                    body.dark-mode h3, body.dark-mode h4, body.dark-mode h5 {
                        color: #e6edf3;
                    }
                    
                    body.dark-mode h6 {
                        color: #8b949e;
                    }
                    
                    /* 代码块深度优化 */
                    body.dark-mode code {
                        background-color: #161b22;
                        color: #e6edf3;
                    }
                    
                    body.dark-mode pre {
                        background-color: #161b22;
                    }
                    
                    /* 引用块深度优化 */
                    body.dark-mode blockquote {
                        border-left: 4px solid #58a6ff;
                        color: #8b949e;
                        background-color: #161b22;
                        border-radius: 6px;
                        padding: 16px;
                        margin: 16px 0;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    }
                    
                    /* 表格深度优化 */
                    body.dark-mode table {
                        border: 1px solid #30363d;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                        background-color: #0d1117;
                    }
                    
                    body.dark-mode table th, body.dark-mode table td {
                        border: 1px solid #30363d;
                        background-color: #0d1117;
                        color: #e6edf3;
                    }
                    
                    body.dark-mode table thead tr {
                        background: linear-gradient(135deg, #21262d 0%, #30363d 100%);
                    }
                    
                    body.dark-mode table th {
                        color: #f0f6fc;
                        font-weight: 600;
                    }
                    
                    body.dark-mode table tr:nth-child(2n) {
                        background-color: #161b22;
                    }
                    
                    body.dark-mode table tr:hover {
                        background-color: #21262d;
                        transition: background-color 0.2s ease;
                    }
                    
                    /* 链接深度优化 */
                    body.dark-mode a {
                        color: #58a6ff;
                        transition: all 0.2s ease;
                        text-decoration: none;
                    }
                    
                    body.dark-mode a:hover {
                        color: #79c0ff;
                        text-shadow: 0 0 8px rgba(88, 166, 255, 0.3);
                    }
                    
                    /* 分割线深度优化 */
                    body.dark-mode hr {
                        border-top: 1px solid #30363d;
                        background: linear-gradient(90deg, transparent, #30363d, transparent);
                        opacity: 0.8;
                    }
                    

                    
                    /* 目录按钮磨砂玻璃风格 */
                    body.dark-mode #toc-toggle {
                        background: rgba(255, 255, 255, 0.1) !important;
                        color: #e6edf3 !important;
                        border: 1px solid rgba(255, 255, 255, 0.2) !important;
                        backdrop-filter: blur(10px) !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    body.dark-mode #toc-toggle:hover {
                        background: rgba(255, 255, 255, 0.2) !important;
                        color: #f0f6fc !important;
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
                    }
                    
                    /* 强调文本深度优化 */
                    body.dark-mode strong {
                        color: #f0f6fc;
                        font-weight: 600;
                    }
                    
                    body.dark-mode em {
                        color: #e6edf3;
                        font-style: italic;
                    }
                    
                    body.dark-mode mark {
                        background-color: #9e6a03;
                        color: #f0f6fc;
                        padding: 2px 4px;
                        border-radius: 3px;
                    }
                    
                    body.dark-mode del {
                        color: #8b949e;
                        text-decoration: line-through;
                    }
                    
                    /* 列表深度优化 */
                    body.dark-mode ul, body.dark-mode ol {
                        color: #e6edf3;
                    }
                    
                    body.dark-mode li {
                        margin-bottom: 0.5em;
                    }
                    
                    /* 任务列表深度优化 */
                    body.dark-mode .task-list-item {
                        color: #e6edf3;
                    }
                    
                    body.dark-mode .task-list-item input[type="checkbox"] {
                        accent-color: #58a6ff;
                    }
                    
                    /* 图片深度优化 */
                    body.dark-mode img {
                        border: 1px solid #30363d;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                    }
                    
                    body.dark-mode img:hover {
                        border-color: #58a6ff;
                        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
                    }
                    
                    /* 目录面板深度优化 */
                    body.dark-mode #toc-panel {
                        background: linear-gradient(180deg, #161b22 0%, #0d1117 100%) !important;
                        border-right: 1px solid #30363d !important;
                        color: #e6edf3 !important;
                        backdrop-filter: blur(10px) !important;
                        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5) !important;
                    }
                    
                    body.dark-mode #toc-toggle {
                        background: rgba(255, 255, 255, 0.1) !important;
                        border: 1px solid rgba(255, 255, 255, 0.2) !important;
                        color: #e6edf3 !important;
                        backdrop-filter: blur(10px) !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    body.dark-mode #toc-toggle:hover {
                        background: rgba(255, 255, 255, 0.2) !important;
                        color: #f0f6fc !important;
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
                    }
                    
                    /* 目录链接深度优化 */
                    .toc-link {
                        color: #1a1a1a !important;
                        transition: all 0.2s ease !important;
                    }
                    
                    .toc-link:hover {
                        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
                        color: #0969da !important;
                        border-radius: 4px !important;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                    }
                    
                    body.dark-mode .toc-link {
                        color: #e6edf3 !important;
                        transition: all 0.2s ease !important;
                    }
                    
                    body.dark-mode .toc-link:hover {
                        background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
                        color: #58a6ff !important;
                        border-radius: 4px !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
                        transform: translateX(4px) !important;
                    }
                    
                    /* 代码复制按钮深度优化 */
                    body.dark-mode .code-copy-button {
                        background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
                        color: #e6edf3 !important;
                        border: 1px solid #30363d !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    body.dark-mode .code-copy-button:hover {
                        background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
                        color: #f0f6fc !important;
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
                    }
                    
                    /* 目录面板打开状态 */
                    #toc-panel.open {
                        left: 0 !important;
                    }
                    
                    /* 目录遮罩层样式 */
                    #toc-overlay.open {
                        opacity: 1 !important;
                        visibility: visible !important;
                    }
                    
                    /* 遮罩层深度优化 */
                    body.dark-mode #toc-overlay {
                        background: radial-gradient(circle, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%) !important;
                        backdrop-filter: blur(2px) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    /* Mermaid图表深色模式优化 */
                    body.dark-mode .mermaid-diagram {
                        background: linear-gradient(145deg, #161b22 0%, #0d1117 100%) !important;
                        border: 1px solid #30363d !important;
                        border-radius: 8px !important;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4) !important;
                        padding: 16px !important;
                    }
                    
                    /* MathJax公式深色模式优化 */
                    body.dark-mode .MathJax {
                        color: #e6edf3 !important;
                        background-color: transparent !important;
                    }
                    
                    body.dark-mode .MathJax_Display {
                        background: linear-gradient(145deg, #161b22 0%, #0d1117 100%) !important;
                        border: 1px solid #30363d !important;
                        border-radius: 6px !important;
                        padding: 16px !important;
                        margin: 16px 0 !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    /* 滚动条深度优化 */
                    body.dark-mode::-webkit-scrollbar {
                        width: 8px;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-track {
                        background: #0d1117;
                        border-radius: 4px;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-thumb {
                        background: linear-gradient(180deg, #30363d 0%, #21262d 100%);
                        border-radius: 4px;
                        border: 1px solid #21262d;
                    }
                    
                    body.dark-mode::-webkit-scrollbar-thumb:hover {
                        background: linear-gradient(180deg, #484f58 0%, #30363d 100%);
                    }
                    
                    /* 选择文本深色模式优化 */
                    body.dark-mode ::selection {
                        background-color: #264f78;
                        color: #ffffff;
                    }
                    
                    body.dark-mode ::-moz-selection {
                        background-color: #264f78;
                        color: #ffffff;
                    }
                    
                    /* 焦点状态深度优化 */
                    body.dark-mode button:focus,
                    body.dark-mode a:focus {
                        outline: 2px solid #58a6ff;
                        outline-offset: 2px;
                        border-radius: 4px;
                    }
                    
                    /* 页面加载动画优化 */
                    body.dark-mode #rendered-content {
                        animation: fadeInUp 0.6s ease-out;
                    }
                    
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                        transform: translateY(0);
                        }
                    }
                    
                    /* 浅色模式按钮磨砂玻璃风格 */
                    body.light-mode #toc-toggle,
                    body:not(.dark-mode) #toc-toggle {
                        background: rgba(255, 255, 255, 0.7) !important;
                        color: #24292f !important;
                        border: 1px solid rgba(0, 0, 0, 0.1) !important;
                        backdrop-filter: blur(10px) !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                        transition: all 0.3s ease !important;
                    }
                    
                    body.light-mode #toc-toggle:hover,
                    body:not(.dark-mode) #toc-toggle:hover {
                        background: rgba(255, 255, 255, 0.9) !important;
                        color: #24292f !important;
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
                    }
                    

                    
                    /* 按钮活跃状态优化 */
                    #toc-toggle:active {
                        transform: translateY(0) !important;
                        transition: all 0.1s ease !important;
                    }
                    
                    /* iOS Safari兼容性增强 */
                    @supports (-webkit-backdrop-filter: blur(10px)) {
                        #toc-toggle {
                            -webkit-backdrop-filter: blur(10px) !important;
                        }
                    }
                    
                    /* 响应式设计 - 移动端优化 */
                    @media (max-width: 480px) {
                        /* 小屏幕：目录面板75% */
                        #toc-panel {
                            width: 75vw !important;
                            max-width: 320px !important;
                            left: -75vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                        
                        /* 小屏幕下显示遮罩层 */
                        #toc-overlay.open {
                            display: block !important;
                        }
                    }
                    
                    @media (min-width: 481px) and (max-width: 768px) {
                        /* 中等屏幕：目录面板60% */
                        #toc-panel {
                            width: 60vw !important;
                            max-width: 350px !important;
                            left: -60vw !important;
                        }
                        
                        #toc-panel.open {
                            left: 0 !important;
                        }
                        
                        /* 中等屏幕下显示遮罩层 */
                        #toc-overlay.open {
                            display: block !important;
                        }
                    }
                    
                    @media (min-width: 769px) {
                        /* 大屏幕：隐藏遮罩层 */
                        #toc-overlay {
                            display: none !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        /* 移动端按钮调整 */
                        div[style*="left: 20px"] {
                            top: 10px !important;
                            left: 10px !important;
                        }
                        
                        #toc-toggle {
                            padding: 6px 10px !important;
                            font-size: 12px !important;
                            -webkit-tap-highlight-color: transparent;
                            touch-action: manipulation;
                        }
                        
                        /* 优化目录面板头部 */
                        #toc-panel > div:first-child {
                            padding-top: 50px !important;
                        }
                    }
                    

                    
                    /* Mermaid图表样式 */
                    .mermaid-diagram {
                        transition: all 0.3s ease;
                        max-width: 100%;
                        overflow-x: auto;
                    }
                    
                    .mermaid-diagram svg {
                        max-width: 100%;
                        height: auto;
                        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
                    }
                    
                    /* 深色模式下的Mermaid图表 */
                    body.dark-mode .mermaid-diagram {
                        border-color: #30363d !important;
                        background-color: rgba(22, 27, 34, 0.8) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg {
                        filter: drop-shadow(0 2px 8px rgba(255, 255, 255, 0.1));
                    }
                    
                    /* 增强Mermaid图表文本对比度 */
                    .mermaid-diagram svg text {
                        font-weight: 700 !important;
                        stroke: none !important;
                        fill: #000000 !important;
                        font-size: 14px !important;
                        font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .nodeLabel,
                    .mermaid-diagram svg .edgeLabel text,
                    .mermaid-diagram svg .messageText,
                    .mermaid-diagram svg .labelText,
                    .mermaid-diagram svg .loopText,
                    .mermaid-diagram svg .noteText {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 13px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .actor {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                        fill: #ffffff !important;
                    }
                    
                    .mermaid-diagram svg .actor-line {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .messageLine0,
                    .mermaid-diagram svg .messageLine1 {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg text {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .nodeLabel,
                    body.dark-mode .mermaid-diagram svg .edgeLabel text,
                    body.dark-mode .mermaid-diagram svg .messageText,
                    body.dark-mode .mermaid-diagram svg .labelText,
                    body.dark-mode .mermaid-diagram svg .loopText,
                    body.dark-mode .mermaid-diagram svg .noteText {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .actor {
                        stroke: #e5e7eb !important;
                        fill: #374151 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .actor-line {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .messageLine0,
                    body.dark-mode .mermaid-diagram svg .messageLine1 {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 优化Mermaid图表背景和边框 */
                    .mermaid-diagram svg rect,
                    .mermaid-diagram svg polygon,
                    .mermaid-diagram svg circle,
                    .mermaid-diagram svg ellipse {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .edgePath .path {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg rect,
                    body.dark-mode .mermaid-diagram svg polygon,
                    body.dark-mode .mermaid-diagram svg circle,
                    body.dark-mode .mermaid-diagram svg ellipse {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .edgePath .path {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 时间线图样式 */
                    .mermaid-diagram svg .section0,
                    .mermaid-diagram svg .section1,
                    .mermaid-diagram svg .section2 {
                        fill: #333333 !important;
                        stroke: #333333 !important;
                    }
                    
                    .mermaid-diagram svg .cScale0,
                    .mermaid-diagram svg .cScale1,
                    .mermaid-diagram svg .cScale2 {
                        fill: #000000 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .section0,
                    body.dark-mode .mermaid-diagram svg .section1,
                    body.dark-mode .mermaid-diagram svg .section2 {
                        fill: #ffffff !important;
                        stroke: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .cScale0,
                    body.dark-mode .mermaid-diagram svg .cScale1,
                    body.dark-mode .mermaid-diagram svg .cScale2 {
                        fill: #ffffff !important;
                    }
                    
                    /* Git图样式 */
                    .mermaid-diagram svg .commit-id,
                    .mermaid-diagram svg .commit-msg {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 12px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .branch-label {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .commit-id,
                    body.dark-mode .mermaid-diagram svg .commit-msg,
                    body.dark-mode .mermaid-diagram svg .branch-label {
                        fill: #ffffff !important;
                    }
                    
                    /* 饼图样式 */
                    .mermaid-diagram svg .pieTitleText {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 16px !important;
                    }
                    
                    .mermaid-diagram svg .slice {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .legend text {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .pieTitleText,
                    body.dark-mode .mermaid-diagram svg .legend text {
                        fill: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .slice {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 象限图样式 */
                    .mermaid-diagram svg .quadrant-text-0,
                    .mermaid-diagram svg .quadrant-text-1,
                    .mermaid-diagram svg .quadrant-text-2,
                    .mermaid-diagram svg .quadrant-text-3 {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .xAxisLabel,
                    .mermaid-diagram svg .yAxisLabel {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .quadrant-text-0,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-1,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-2,
                    body.dark-mode .mermaid-diagram svg .quadrant-text-3,
                    body.dark-mode .mermaid-diagram svg .xAxisLabel,
                    body.dark-mode .mermaid-diagram svg .yAxisLabel {
                        fill: #ffffff !important;
                    }
                    
                    /* 旅程图样式 */
                    .mermaid-diagram svg .journey-section-text {
                        fill: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 14px !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .task-text {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .task-score-text {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .journey-section-text,
                    body.dark-mode .mermaid-diagram svg .task-text,
                    body.dark-mode .mermaid-diagram svg .task-score-text {
                        fill: #ffffff !important;
                    }
                    
                    /* 需求图样式 */
                    .mermaid-diagram svg .requirement,
                    .mermaid-diagram svg .requirementText {
                        fill: #000000 !important;
                        font-weight: 500 !important;
                        font-size: 12px !important;
                    }
                    
                    .mermaid-diagram svg .element {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .requirement,
                    body.dark-mode .mermaid-diagram svg .requirementText {
                        fill: #ffffff !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .element {
                        stroke: #e5e7eb !important;
                    }
                    
                    /* 思维导图样式 */
                    .mermaid-diagram svg .mindmap-node {
                        stroke: #333333 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .mindmap-label {
                        fill: #000000 !important;
                        font-weight: 600 !important;
                        font-size: 13px !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .mindmap-node {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .mindmap-label {
                        fill: #ffffff !important;
                    }
                    
                    /* 全局增强所有Mermaid图表的文本对比度 */
                    .mermaid-diagram svg * {
                        font-weight: 700 !important;
                    }
                    
                    .mermaid-diagram svg tspan {
                        font-weight: 700 !important;
                        fill: #000000 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg tspan {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    /* 甘特图移动端优化 */
                    .mermaid-diagram svg .taskText {
                        font-size: 13px !important;
                        font-weight: 600 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    .mermaid-diagram svg .sectionTitle {
                        font-size: 15px !important;
                        font-weight: 700 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.3) !important;
                    }
                    
                    .mermaid-diagram svg .today {
                        fill: #ef4444 !important;
                        stroke: #dc2626 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .done0,
                    .mermaid-diagram svg .done1,
                    .mermaid-diagram svg .done2,
                    .mermaid-diagram svg .done3 {
                        fill: #10b981 !important;
                        stroke: #059669 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .active0,
                    .mermaid-diagram svg .active1,
                    .mermaid-diagram svg .active2,
                    .mermaid-diagram svg .active3 {
                        fill: #f59e0b !important;
                        stroke: #d97706 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .crit0,
                    .mermaid-diagram svg .crit1,
                    .mermaid-diagram svg .crit2,
                    .mermaid-diagram svg .crit3 {
                        fill: #ef4444 !important;
                        stroke: #dc2626 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .task {
                        fill: #6b7280 !important;
                        stroke: #4b5563 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .taskTextOutside {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #374151 !important;
                    }
                    
                    .mermaid-diagram svg .grid .tick text {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #4b5563 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .taskText,
                    body.dark-mode .mermaid-diagram svg .sectionTitle {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .taskTextOutside,
                    body.dark-mode .mermaid-diagram svg .grid .tick text {
                        fill: #e5e7eb !important;
                    }
                    
                    /* 实体关系图移动端优化 */
                    .mermaid-diagram svg .entity {
                        fill: #f8f9fa !important;
                        stroke: #374151 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .entityLabel {
                        font-size: 14px !important;
                        font-weight: 700 !important;
                        fill: #1f2937 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    .mermaid-diagram svg .attributeBoxOdd,
                    .mermaid-diagram svg .attributeBoxEven {
                        fill: #ffffff !important;
                        stroke: #d1d5db !important;
                        stroke-width: 1px !important;
                    }
                    
                    .mermaid-diagram svg .attributeBoxOdd text,
                    .mermaid-diagram svg .attributeBoxEven text {
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        fill: #374151 !important;
                    }
                    
                    .mermaid-diagram svg .relationshipLine {
                        stroke: #374151 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .relationshipLabel {
                        font-size: 11px !important;
                        font-weight: 600 !important;
                        fill: #6b7280 !important;
                        text-shadow: 0 0 1px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .entity {
                        fill: #374151 !important;
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .entityLabel {
                        fill: #ffffff !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .attributeBoxOdd,
                    body.dark-mode .mermaid-diagram svg .attributeBoxEven {
                        fill: #4b5563 !important;
                        stroke: #6b7280 !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .attributeBoxOdd text,
                    body.dark-mode .mermaid-diagram svg .attributeBoxEven text {
                        fill: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .relationshipLine {
                        stroke: #e5e7eb !important;
                    }
                    
                    body.dark-mode .mermaid-diagram svg .relationshipLabel {
                        fill: #d1d5db !important;
                        text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
                    }
                    
                    /* 移动端响应式优化 */
                    @media (max-width: 768px) {
                        .mermaid-diagram svg {
                            max-width: 100% !important;
                            height: auto !important;
                            transform-origin: top left !important;
                        }
                        
                        /* 甘特图移动端缩放 */
                        .mermaid-diagram svg[viewBox*="gantt"] {
                            transform: scale(0.8) !important;
                            transform-origin: top left !important;
                        }
                        
                        /* 实体关系图移动端缩放 */
                        .mermaid-diagram svg[viewBox*="er"] {
                            transform: scale(0.9) !important;
                            transform-origin: top left !important;
                        }
                        
                        .mermaid-diagram svg .taskText {
                            font-size: 12px !important;
                        }
                        
                        .mermaid-diagram svg .sectionTitle {
                            font-size: 14px !important;
                        }
                        
                        .mermaid-diagram svg .entityLabel {
                            font-size: 13px !important;
                        }
                        
                        .mermaid-diagram svg .attributeBoxOdd text,
                        .mermaid-diagram svg .attributeBoxEven text {
                            font-size: 11px !important;
                        }
                        
                        .mermaid-diagram svg .relationshipLabel {
                            font-size: 10px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        /* 超小屏幕进一步缩放 */
                        .mermaid-diagram svg[viewBox*="gantt"] {
                            transform: scale(0.7) !important;
                        }
                        
                        .mermaid-diagram svg[viewBox*="er"] {
                            transform: scale(0.8) !important;
                        }
                        
                        .mermaid-diagram svg .taskText {
                            font-size: 11px !important;
                        }
                        
                        .mermaid-diagram svg .sectionTitle {
                            font-size: 13px !important;
                        }
                        
                        .mermaid-diagram svg .entityLabel {
                            font-size: 12px !important;
                        }
                        
                        .mermaid-diagram svg .attributeBoxOdd text,
                        .mermaid-diagram svg .attributeBoxEven text {
                            font-size: 10px !important;
                        }
                        
                        .mermaid-diagram svg .relationshipLabel {
                            font-size: 9px !important;
                        }
                    }
                    
                    /* 自定义classDef样式支持 */
                    /* 系统架构流程图样式 */
                    .mermaid-diagram svg .startEnd {
                        fill: #e1f5fe !important;
                        stroke: #01579b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .process {
                        fill: #f3e5f5 !important;
                        stroke: #4a148c !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .engine {
                        fill: #fff3e0 !important;
                        stroke: #e65100 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .feature {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 应用状态转换图样式 */
                    .mermaid-diagram svg .activeState {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .errorState {
                        fill: #ffebee !important;
                        stroke: #c62828 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .processState {
                        fill: #fff3e0 !important;
                        stroke: #ef6c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .interactState {
                        fill: #e3f2fd !important;
                        stroke: #1565c0 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 功能优先级分布图样式 */
                    .mermaid-diagram svg .coreFeatures {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .importantFeatures {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .supportFeatures {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .optionalFeatures {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 类图样式 */
                    .mermaid-diagram svg .renderer {
                        fill: #e1f5fe !important;
                        stroke: #01579b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .manager {
                        fill: #f3e5f5 !important;
                        stroke: #4a148c !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .handler {
                        fill: #fff3e0 !important;
                        stroke: #e65100 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 开发时间线图样式 */
                    .mermaid-diagram svg .milestone {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 3px !important;
                    }
                    
                    .mermaid-diagram svg .optimization {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .release {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 系统需求关系图样式 */
                    .mermaid-diagram svg .requirement {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .lowRisk {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .mediumRisk {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .highRisk {
                        fill: #fce4ec !important;
                        stroke: #c2185b !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .component {
                        fill: #f3e5f5 !important;
                        stroke: #7b1fa2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 系统架构图样式 */
                    .mermaid-diagram svg .root {
                        fill: #e8f5e8 !important;
                        stroke: #2e7d32 !important;
                        stroke-width: 3px !important;
                    }
                    
                    .mermaid-diagram svg .category {
                        fill: #e1f5fe !important;
                        stroke: #1976d2 !important;
                        stroke-width: 2px !important;
                    }
                    
                    .mermaid-diagram svg .module {
                        fill: #fff3e0 !important;
                        stroke: #f57c00 !important;
                        stroke-width: 2px !important;
                    }
                    
                    /* 深色模式下的自定义classDef样式 */
                    body.dark-mode .mermaid-diagram svg .startEnd,
                    body.dark-mode .mermaid-diagram svg .process,
                    body.dark-mode .mermaid-diagram svg .engine,
                    body.dark-mode .mermaid-diagram svg .feature,
                    body.dark-mode .mermaid-diagram svg .activeState,
                    body.dark-mode .mermaid-diagram svg .errorState,
                    body.dark-mode .mermaid-diagram svg .processState,
                    body.dark-mode .mermaid-diagram svg .interactState,
                    body.dark-mode .mermaid-diagram svg .coreFeatures,
                    body.dark-mode .mermaid-diagram svg .importantFeatures,
                    body.dark-mode .mermaid-diagram svg .supportFeatures,
                    body.dark-mode .mermaid-diagram svg .optionalFeatures,
                    body.dark-mode .mermaid-diagram svg .renderer,
                    body.dark-mode .mermaid-diagram svg .manager,
                    body.dark-mode .mermaid-diagram svg .handler,
                    body.dark-mode .mermaid-diagram svg .milestone,
                    body.dark-mode .mermaid-diagram svg .optimization,
                    body.dark-mode .mermaid-diagram svg .release,
                    body.dark-mode .mermaid-diagram svg .requirement,
                    body.dark-mode .mermaid-diagram svg .lowRisk,
                    body.dark-mode .mermaid-diagram svg .mediumRisk,
                    body.dark-mode .mermaid-diagram svg .highRisk,
                    body.dark-mode .mermaid-diagram svg .component,
                    body.dark-mode .mermaid-diagram svg .root,
                    body.dark-mode .mermaid-diagram svg .category,
                    body.dark-mode .mermaid-diagram svg .module {
                        opacity: 0.8;
                        filter: brightness(1.2);
                    }

                    /* 移动端Mermaid图表优化 */
                    @media (max-width: 768px) {
                        .mermaid-diagram {
                            padding: 10px !important;
                            margin: 10px 0 !important;
                        }
                        
                        .mermaid-diagram svg {
                            touch-action: pan-x pan-y;
                        }
                    }
                </style>
            </head>
    <body>
        <!-- 左侧目录按钮 -->
        <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
            <button id="toc-toggle" style="background: rgba(255, 255, 255, 0.7); color: #24292f; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);" title="切换目录">
                目录
            </button>
        </div>
        

        
        <!-- 目录面板背景遮罩 -->
        <div id="toc-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.3); z-index: 997; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;"></div>
        
        <!-- 目录面板 -->
        <div id="toc-panel" style="width: 280px; background-color: #f6f8fa; border-right: 1px solid #d0d7de; position: fixed; top: 0; left: -280px; height: 100vh; height: 100dvh; overflow-y: auto; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 998; box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1); will-change: transform;">
            <div style="padding: 20px; padding-top: 60px; border-bottom: 1px solid #d0d7de;">
                <h3 style="font-size: 16px; font-weight: 600; margin: 0;">目录</h3>
            </div>
            <div style="padding: 20px;">
                <ul id="toc-list" style="list-style: none; padding: 0; margin: 0;">
                    <!-- 目录将自动生成 -->
                </ul>
            </div>
        </div>
        
        <div id="rendered-content"></div>
        
        <script>
            
            // GPU优化和性能监控
            function initPerformanceOptimizations() {
                console.log('🚀 初始化性能优化...');
                
                // 检测GPU加速支持
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (gl) {
                    console.log('✅ GPU加速支持已启用');
                    const renderer = gl.getParameter(gl.RENDERER);
                    const vendor = gl.getParameter(gl.VENDOR);
                    console.log(`📱 GPU信息: ${vendor} ${renderer}`);
                } else {
                    console.warn('⚠️ GPU加速不可用，使用CPU渲染');
                }
                
                // 监控内存使用
                if (performance.memory) {
                    console.log('💾 内存使用情况:', {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + 'MB'
                    });
                }
                
                // 设置性能监控
                setupPerformanceMonitoring();
            }
            
            // 性能监控
            function setupPerformanceMonitoring() {
                let renderingStartTime = 0;
                let lastMemoryCheck = 0;
                
                // 监控渲染性能
                window.startRenderingTimer = function() {
                    renderingStartTime = performance.now();
                };
                
                window.endRenderingTimer = function(operation) {
                    const duration = performance.now() - renderingStartTime;
                    console.log(`⏱️ ${operation} 耗时: ${duration.toFixed(2)}ms`);
                    
                    if (duration > 100) {
                        console.warn(`⚠️ ${operation} 渲染较慢，建议优化`);
                    }
                };
                
                // 定期检查内存使用
                setInterval(function() {
                    if (performance.memory) {
                        const currentMemory = performance.memory.usedJSHeapSize;
                        const memoryIncrease = currentMemory - lastMemoryCheck;
                        
                        if (memoryIncrease > 10 * 1024 * 1024) { // 大于10MB增长
                            console.log('📈 内存使用增长:', Math.round(memoryIncrease / 1024 / 1024) + 'MB');
                            
                            // 触发垃圾回收
                            if (window.gc) {
                                window.gc();
                                console.log('🗑️ 手动垃圾回收已触发');
                            }
                        }
                        
                        lastMemoryCheck = currentMemory;
                    }
                }, 5000); // 每5秒检查一次
            }
            
            // 优化DOM操作
            function optimizeDOMOperations() {
                // 批量DOM操作
                window.batchDOMUpdates = function(updates) {
                    const fragment = document.createDocumentFragment();
                    
                    updates.forEach(update => {
                        const element = update.element;
                        const parent = update.parent;
                        
                        if (parent) {
                            fragment.appendChild(element);
                        }
                    });
                    
                    return fragment;
                };
                
                // 虚拟滚动支持
                window.createVirtualScrollContainer = function(itemHeight, totalItems) {
                    const container = document.createElement('div');
                    container.className = 'virtual-scroll-container';
                    container.style.cssText = `
                        height: ${itemHeight * totalItems}px;
                        overflow-y: auto;
                        position: relative;
                    `;
                    
                    return container;
                };
            }
            
            // 分块渲染优化
            function optimizeChunkRendering() {
                // 延迟渲染队列
                window.deferredRenderQueue = [];
                window.isProcessingQueue = false;
                
                window.addToDeferredQueue = function(renderFunction) {
                    window.deferredRenderQueue.push(renderFunction);
                    processQueue();
                };
                
                function processQueue() {
                    if (window.isProcessingQueue || window.deferredRenderQueue.length === 0) {
                        return;
                    }
                    
                    window.isProcessingQueue = true;
                    
                    const renderFunction = window.deferredRenderQueue.shift();
                    
                    // 使用 requestAnimationFrame 确保在浏览器准备好时渲染
                    requestAnimationFrame(() => {
                        try {
                            renderFunction();
                        } catch (error) {
                            console.error('❌ 延迟渲染错误:', error);
                        }
                        
                        window.isProcessingQueue = false;
                        
                        // 处理下一个队列项
                        setTimeout(processQueue, 16); // 约60fps的间隔
                    });
                }
            }
            
            // 内存清理优化
            function setupMemoryCleanup() {
                window.cleanupMemory = function() {
                    console.log('🧹 开始内存清理...');
                    
                    // 清理未使用的图片
                    const images = document.querySelectorAll('img');
                    images.forEach(img => {
                        if (img.complete && !img.src.startsWith('data:')) {
                            // 对于已加载的外部图片，可以考虑清理
                            const rect = img.getBoundingClientRect();
                            if (rect.top > window.innerHeight * 2 || rect.bottom < -window.innerHeight) {
                                // 图片在视口外较远，可以考虑延迟加载
                                img.style.opacity = '0.5';
                            }
                        }
                    });
                    
                    // 清理DOM缓存
                    const elements = document.querySelectorAll('[data-cached]');
                    elements.forEach(el => {
                        if (el.dataset.cached === 'true') {
                            delete el.dataset.cached;
                        }
                    });
                    
                    // 手动触发垃圾回收（如果支持）
                    if (window.gc) {
                        window.gc();
                    }
                    
                    console.log('✅ 内存清理完成');
                };
                
                // 页面隐藏时清理内存
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        setTimeout(window.cleanupMemory, 1000);
                    }
                });
            }
            
            // 初始化所有优化
            window.addEventListener('load', () => {
                initPerformanceOptimizations();
                optimizeDOMOperations();
                optimizeChunkRendering();
                setupMemoryCleanup();
            });
            
            // 简单的Markdown解析器（降级方案）
            function initSimpleMarkdownParser() {
                window.simpleMarkdown = {
                    parse: function(text) {
                        if (!text) return '';
                        
                        // 基础HTML转义
                        function escapeHtml(unsafe) {
                            return unsafe
                                .replace(/&/g, "&amp;")
                                .replace(/</g, "&lt;")
                                .replace(/>/g, "&gt;")
                                .replace(/"/g, "&quot;")
                                .replace(/'/g, "&#039;");
                        }
                        
                        // 处理标题
                        text = text.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
                        text = text.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
                        text = text.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
                        
                        // 处理粗体和斜体
                        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        
                        // 处理代码块
                        text = text.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');
                        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                        
                        // 处理链接
                        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                        
                        // 处理列表
                        text = text.replace(/^- (.*?)$/gm, '<li>$1</li>');
                        text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                        
                        // 处理段落
                        text = text.replace(/\n\n/g, '</p><p>');
                        text = '<p>' + text + '</p>';
                        
                        // 清理空段落
                        text = text.replace(/<p><\/p>/g, '');
                        
                        return text;
                    }
                };
                console.log('✅ 简单Markdown解析器已初始化');
            }
            
            // 配置 Marked.js - 兼容现代版本和iOS WebView
            function configureMarked() {
                if (typeof marked === 'undefined') {
                    console.warn('⚠️ marked.js未加载，跳过配置');
                    return;
                }
                
                try {
                    marked.setOptions({
                        breaks: true,        // 支持换行
                        tables: true,        // 支持表格
                        gfm: true,          // 支持GitHub Flavored Markdown
                        headerIds: true,     // 生成标题ID
                        smartLists: true,    // 智能列表
                        smartypants: true,   // 智能标点
                        xhtml: true,         // XHTML兼容
                        mangle: false,       // 禁用邮箱混淆
                        // 移除sanitize选项，使用renderer自定义HTML处理
                    });
                    
                    // 自定义HTML渲染器 - 确保HTML内容被正确解析
                    const renderer = new marked.Renderer();
                    
                    // 保留原始HTML渲染方法
                    const originalHtml = renderer.html;
                    renderer.html = function(html) {
                        // 确保html是字符串类型
                        if (typeof html !== 'string') {
                            return originalHtml ? originalHtml.call(this, html) : '';
                        }
                        // 直接返回HTML内容，不进行转义
                        return html;
                    };
                    
                    // 简化渲染器，专注于LaTeX和基本HTML标签
                    const originalParagraph = renderer.paragraph;
                    renderer.paragraph = function(text) {
                        // 确保text是字符串类型
                        if (typeof text !== 'string') {
                            return originalParagraph.call(this, text);
                        }
                        
                        // 检查是否包含LaTeX公式，如果有则保持原始渲染
                        if (text.includes('$') || text.includes('\\(') || text.includes('\\[') || text.includes('\\begin{')) {
                            // 包含LaTeX公式，使用默认段落渲染以确保MathJax正常处理
                            return originalParagraph.call(this, text);
                        }
                        
                        // 否则使用默认的段落渲染
                        return originalParagraph.call(this, text);
                    };
                    
                    // 应用自定义渲染器
                    marked.setOptions({
                        renderer: renderer
                    });
                    
                    console.log('✅ Marked.js配置完成');
                } catch (error) {
                    console.error('❌ Marked.js配置失败:', error);
                }
            }
            
            var text = "";
            
            // 安全的Markdown解析函数
            function safeMarkdownParse(content) {
                if (!content) return '';
                
                // 检查marked.js是否可用
                if (typeof marked !== 'undefined' && marked.parse) {
                    try {
                        return marked.parse(content);
                    } catch (error) {
                        console.error('❌ marked.parse()失败:', error);
                        console.log('🔄 使用简单解析器降级');
                        return fallbackMarkdownParse(content);
                    }
                } else {
                    console.warn('⚠️ marked.js不可用，使用简单解析器');
                    return fallbackMarkdownParse(content);
                }
            }
            
            // 降级Markdown解析函数
            function fallbackMarkdownParse(content) {
                if (window.simpleMarkdown && window.simpleMarkdown.parse) {
                    return window.simpleMarkdown.parse(content);
                } else {
                    // 最基础的降级方案
                    console.warn('⚠️ 简单解析器也不可用，使用最基础方案');
                    return '<pre style="white-space: pre-wrap; font-family: inherit;">' + 
                           content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                           '</pre>';
                }
            }
            
            // 初始化 Mermaid
            function initMermaid() {
                if (typeof mermaid !== 'undefined') {
                    console.log('🎨 初始化Mermaid图表渲染器');
                    
                    // 检查当前主题
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      (!document.body.classList.contains('light-mode') && 
                                       window.matchMedia('(prefers-color-scheme: dark)').matches);
                    
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: isDarkMode ? 'dark' : 'base',
                        securityLevel: 'loose',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        fontSize: 16,
                        flowchart: {
                            htmlLabels: true,
                            curve: 'basis',
                            padding: 15
                        },
                        sequence: {
                            diagramMarginX: 30,
                            diagramMarginY: 30,
                            actorMargin: 50,
                            width: 150,
                            height: 65,
                            boxMargin: 10,
                            boxTextMargin: 8,
                            noteMargin: 15,
                            messageMargin: 40
                        },
                        gantt: {
                            leftPadding: 60,
                            gridLineStartPadding: 30,
                            fontSize: 12,
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            sectionFontSize: 14,
                            axisFormat: '%m月',
                            barHeight: 20,
                            rightPadding: 20,
                            topPadding: 50,
                            bottomPadding: 50,
                            numberSectionStyles: 3,
                            useWidth: 800
                        },
                        class: {
                            titleTopMargin: 25
                        },
                        state: {
                            titleTopMargin: 25
                        },
                        er: {
                            diagramPadding: 15,
                            layoutDirection: 'TB',
                            minEntityWidth: 120,
                            minEntityHeight: 80,
                            entityPadding: 12,
                            stroke: '#333333',
                            fill: '#f8f9fa',
                            fontSize: 13,
                            useMaxWidth: true,
                            alignment: 'center'
                        }
                    });
                    
                    console.log('✅ Mermaid初始化完成，主题:', isDarkMode ? 'dark' : 'default');
                } else {
                    console.warn('⚠️ Mermaid未加载');
                }
            }
            
            // 原生应用通信桥梁
            class NativeBridge {
                constructor() {
                    this.isNativeEnvironment = this.detectNativeEnvironment();
                    this.setupMessageHandlers();
                    this.setupNativePrint();
                }
                
                detectNativeEnvironment() {
                    // 检测是否在原生WebView环境中
                    return window.webkit && window.webkit.messageHandlers;
                }
                
                setupNativePrint() {
                    // 设置原生打印函数
                    if (this.isNativeEnvironment && window.webkit.messageHandlers.nativePrint) {
                        window.nativePrint = function(message) {
                            try {
                                // 如果消息是对象，将其转换为字符串
                                let logMessage = message;
                                if (typeof message === 'object' && message !== null) {
                                    logMessage = JSON.stringify(message, null, 2);
                                } else if (typeof message === 'undefined') {
                                    logMessage = 'undefined';
                                } else if (message === null) {
                                    logMessage = 'null';
                                } else {
                                    logMessage = String(message);
                                }
                                
                                // 发送到原生代码
                                window.webkit.messageHandlers.nativePrint.postMessage(logMessage);
                            } catch (error) {
                                console.error('原生打印失败:', error);
                            }
                        };
                        
                        // 也可以直接覆盖console.log（可选）
                        const originalConsoleLog = console.log;
                        console.log = function(...args) {
                            // 保持原有的console.log功能
                            originalConsoleLog.apply(console, args);
                            
                            // 同时发送到原生代码
                            const message = args.map(arg => {
                                if (typeof arg === 'object' && arg !== null) {
                                    return JSON.stringify(arg, null, 2);
                                }
                                return String(arg);
                            }).join(' ');
                            
                            window.nativePrint(message);
                        };
                        
                        console.log('✅ 原生打印功能已启用');
                        
                        // 测试原生打印功能
                        setTimeout(() => {
                            window.nativePrint('🔧 原生打印功能测试 - 这条消息应该出现在Xcode控制台');
                            window.nativePrint({
                                test: '对象测试',
                                timestamp: new Date().toISOString(),
                                type: 'native_print_test'
                            });
                        }, 1000);
                    } else {
                        // 如果不在原生环境中，nativePrint回退到console.log
                        window.nativePrint = function(message) {
                            console.log(message);
                        };
                    }
                }
                
                setupMessageHandlers() {
                    // 监听来自原生应用的消息
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'themeChanged') {
                            this.handleNativeThemeChange(event.data.theme);
                        }
                    });
                    
                    // 暴露给原生调用的全局函数
                    window.handleNativeThemeChange = (theme) => {
                        this.handleNativeThemeChange(theme);
                    };
                }
                
                handleNativeThemeChange(theme) {
                    console.log('🔄 原生应用主题变化:', theme);
                    if (window.themeManager) {
                        // 在原生环境中，强制设置主题（即使是首次初始化）
                        const isFirstTimeSetup = window.themeManager.currentTheme === null;
                        window.themeManager.setTheme(theme, false); // 不通知原生，避免循环
                        if (isFirstTimeSetup) {
                            console.log('🎨 WebView首次主题初始化完成:', theme);
                        }
                    }
                }
                
                notifyNativeThemeChange(theme) {
                    if (!this.isNativeEnvironment) return;
                    
                    try {
                        // iOS WebKit消息传递
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.themeHandler) {
                            window.webkit.messageHandlers.themeHandler.postMessage({
                                type: 'themeChanged',
                                theme: theme
                            });
                        }
                        
                        // Android WebView JavascriptInterface
                        if (window.AndroidInterface && window.AndroidInterface.onThemeChanged) {
                            window.AndroidInterface.onThemeChanged(theme);
                        }
                        
                        console.log('📱 已通知原生应用主题变化:', theme);
                    } catch (error) {
                        console.log('⚠️ 通知原生应用失败:', error);
                    }
                }
            }
            
            // 主题管理 - 增强版
            class ThemeManager {
                constructor() {
                    this.nativeBridge = new NativeBridge();
                    this.init();
                }
                
                init() {
                    // 在原生环境中，不要立即设置主题，等待原生应用同步主题
                    if (this.nativeBridge && this.nativeBridge.isNativeEnvironment) {
                        console.log('🎨 原生环境中，等待主题同步...');
                        // 原生环境中不设置默认主题，完全等待原生同步
                        this.currentTheme = null; // 标记为未初始化状态
                    } else {
                        // 非原生环境，使用本地存储或系统主题
                    const savedTheme = localStorage.getItem('theme');
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    
                    if (savedTheme) {
                            this.setTheme(savedTheme, false);
                    } else if (systemPrefersDark) {
                            this.setTheme('dark', false);
                    } else {
                            this.setTheme('light', false);
                        }
                    }
                    
                    // 主题切换按钮已移除，只保留原生应用控制
                    
                    // 监听系统主题变化
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        if (!localStorage.getItem('theme')) {
                            this.setTheme(e.matches ? 'dark' : 'light', true);
                        }
                    });
                }
                
                setInitialTheme() {
                    // 设置一个临时的默认主题，不保存到localStorage
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const defaultTheme = systemPrefersDark ? 'dark' : 'light';
                    
                    const body = document.body;
                    
                    // 移除所有主题类
                    body.classList.remove('dark-mode', 'light-mode');
                    
                    if (defaultTheme === 'dark') {
                        body.classList.add('dark-mode');
                    } else {
                        body.classList.add('light-mode');
                    }
                    
                    this.currentTheme = defaultTheme;
                    console.log('🎨 临时主题设置:', defaultTheme);
                }
                
                setTheme(theme, notifyNative = true) {
                    const body = document.body;
                    
                    // 移除所有主题类
                    body.classList.remove('dark-mode', 'light-mode');
                    
                    if (theme === 'dark') {
                        body.classList.add('dark-mode');
                    } else {
                        body.classList.add('light-mode');
                    }
                    
                    // 只在非原生环境中保存到本地存储
                    if (!this.nativeBridge || !this.nativeBridge.isNativeEnvironment) {
                    localStorage.setItem('theme', theme);
                    }
                    
                    this.currentTheme = theme;
                    
                    // 通知原生应用主题变化
                    if (notifyNative && this.nativeBridge) {
                        this.nativeBridge.notifyNativeThemeChange(theme);
                    }
                    
                    console.log('🎨 主题已切换到:', theme, notifyNative ? '(已通知原生)' : '(未通知原生)');
                }
                
                toggleTheme() {
                    const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                    this.setTheme(newTheme, true); // 用户手动切换时通知原生
                    
                    // 重新初始化Mermaid以应用新主题
                    initMermaid();
                    
                    // 重新渲染所有Mermaid图表
                    renderMermaidDiagrams(document.getElementById('rendered-content'));
                }
                
                getCurrentTheme() {
                    return this.currentTheme;
                }
            }
            
            // 初始化主题管理器
            const themeManager = new ThemeManager();
            
            // 暴露给全局作用域，方便原生调用
            window.themeManager = themeManager;
            
            // 移动端Mermaid图表响应式优化
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const mermaidDiagrams = document.querySelectorAll('.mermaid-diagram svg');
                    mermaidDiagrams.forEach(svg => {
                        const chartType = svg.getAttribute('data-chart-type');
                        
                        if (chartType === 'gantt') {
                            // 重新优化甘特图
                            if (window.innerWidth <= 768) {
                                const tasks = svg.querySelectorAll('.taskText, .sectionTitle');
                                tasks.forEach(task => {
                                    task.style.fontSize = window.innerWidth <= 480 ? '11px' : '12px';
                                });
                                
                                const axisLabels = svg.querySelectorAll('.grid .tick text');
                                axisLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                });
                            }
                        } else if (chartType === 'er') {
                            // 重新优化实体关系图
                            if (window.innerWidth <= 768) {
                                const entityLabels = svg.querySelectorAll('.entityLabel');
                                entityLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '12px' : '13px';
                                });
                                
                                const attributeTexts = svg.querySelectorAll('.attributeBoxOdd text, .attributeBoxEven text');
                                attributeTexts.forEach(text => {
                                    text.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                });
                                
                                const relationLabels = svg.querySelectorAll('.relationshipLabel');
                                relationLabels.forEach(label => {
                                    label.style.fontSize = window.innerWidth <= 480 ? '9px' : '10px';
                                });
                            }
                        }
                    });
                    
                    console.log('📱 移动端Mermaid图表响应式优化完成');
                }, 300);
            });
            
            // 目录管理
            let tocOpen = false;
            
            // 初始化目录功能
            function initTOC() {
                const toggleButton = document.getElementById('toc-toggle');
                const tocPanel = document.getElementById('toc-panel');
                const tocOverlay = document.getElementById('toc-overlay');
                
                // 切换目录显示
                function toggleTOC() {
                    tocOpen = !tocOpen;
                    if (tocOpen) {
                        tocPanel.classList.add('open');
                        tocOverlay.classList.add('open');
                    } else {
                        tocPanel.classList.remove('open');
                        tocOverlay.classList.remove('open');
                    }
                }
                
                // 关闭目录
                function closeTOC() {
                    if (tocOpen) {
                        tocOpen = false;
                        tocPanel.classList.remove('open');
                        tocOverlay.classList.remove('open');
                    }
                }
                
                // 绑定切换按钮事件（支持触摸）
                toggleButton.addEventListener('click', toggleTOC);
                toggleButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    toggleTOC();
                });
                
                // 点击遮罩层关闭目录
                tocOverlay.addEventListener('click', closeTOC);
                tocOverlay.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    closeTOC();
                });
                
                // 点击面板外区域关闭目录（支持触摸）
                function handleOutsideClick(e) {
                    if (tocOpen && !e.target.closest('#toc-panel') && !e.target.closest('#toc-toggle') && !e.target.closest('#toc-overlay')) {
                        closeTOC();
                    }
                }
                
                document.addEventListener('click', handleOutsideClick);
                document.addEventListener('touchend', handleOutsideClick);
                
                // 暴露关闭函数供目录链接使用
                window.closeTOC = closeTOC;
            }
            
            // 生成目录
            function generateTOC() {
                const headers = document.querySelectorAll('#rendered-content h1, #rendered-content h2, #rendered-content h3, #rendered-content h4, #rendered-content h5, #rendered-content h6');
                const tocList = document.getElementById('toc-list');
                
                if (headers.length === 0) {
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const noTitleColor = isDarkMode ? '#666' : '#1a1a1a';
                    tocList.innerHTML = `<li style="color: ${noTitleColor}; padding: 12px; text-align: center;">无标题</li>`;
                    return;
                }
                
                // 清空目录并移除之前的事件监听器
                tocList.innerHTML = '';
                
                // 使用事件委托而不是为每个链接添加监听器
                const handleTocClick = (e) => {
                    const link = e.target.closest('a[data-target]');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.getAttribute('data-target');
                        const element = document.getElementById(targetId);
                        if (element) {
                            // 使用requestAnimationFrame确保平滑滚动
                            const scrollToElement = () => {
                                try {
                                    element.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案：直接滚动
                                    element.scrollIntoView();
                                }
                            };
                            
                            requestAnimationFrame(scrollToElement);
                            
                            // 在移动端点击后关闭目录
                            if (window.innerWidth <= 768) {
                                setTimeout(() => {
                                    if (window.closeTOC) window.closeTOC();
                                }, 300);
                            }
                        }
                    }
                };
                
                // 移除旧的事件监听器并添加新的
                tocList.removeEventListener('click', handleTocClick);
                tocList.addEventListener('click', handleTocClick);
                
                // 生成目录项
                headers.forEach((header, index) => {
                    const level = parseInt(header.tagName.substring(1));
                    const text = header.textContent.trim();
                    
                    // 为标题添加ID（如果没有的话）
                    if (!header.id) {
                        header.id = `heading-${index}`;
                    }
                    
                    const listItem = document.createElement('li');
                    listItem.style.margin = '4px 0';
                    
                    const link = document.createElement('a');
                    link.href = `#${header.id}`;
                    link.setAttribute('data-target', header.id);
                    link.textContent = text;
                    
                    // 根据主题设置样式
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const textColor = isDarkMode ? '#c9d1d9' : '#1a1a1a';
                    
                    link.style.cssText = `
                        display: block;
                        padding: 6px 12px;
                        color: ${textColor};
                        text-decoration: none;
                        border-radius: 4px;
                        transition: background-color 0.2s ease;
                        font-size: 14px;
                        padding-left: ${12 + (level - 1) * 12}px;
                        ${level === 1 ? 'font-weight: 600;' : ''}
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                    `;
                    
                    // 使用CSS hover而不是JavaScript事件以提升性能
                    link.className = 'toc-link';
                    
                    listItem.appendChild(link);
                    tocList.appendChild(listItem);
                });
            }
            
            // 处理链接显示和交互
            function processLinks(element) {
                const links = element.querySelectorAll('a[href]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    
                    if (!href) return;
                    
                    // 为外链添加图标标识
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        // 外链图标
                        if (!link.querySelector('.external-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'external-link-icon';
                            icon.innerHTML = ' ↗';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('mailto:')) {
                        // 邮件链接图标
                        if (!link.querySelector('.email-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'email-link-icon';
                            icon.innerHTML = ' ✉';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('tel:')) {
                        // 电话链接图标
                        if (!link.querySelector('.phone-link-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'phone-link-icon';
                            icon.innerHTML = ' 📞';
                            icon.style.cssText = 'font-size: 0.8em; opacity: 0.7; margin-left: 2px;';
                            link.appendChild(icon);
                        }
                    } else if (href.startsWith('#')) {
                        // 锚点链接 - 添加特殊处理确保平滑滚动
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const targetId = href.substring(1);
                            const targetElement = document.getElementById(targetId);
                            if (targetElement) {
                                try {
                                    targetElement.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start' 
                                    });
                                } catch (err) {
                                    // 降级方案
                                    targetElement.scrollIntoView();
                                }
                            }
                        });
                    }
                });
            }
            
                                // 添加图片点击放大功能
            function addImageZoomFunction(element) {
                const images = element.querySelectorAll('img');
                console.log(`🖼️ 发现 ${images.length} 张图片`);
                
                images.forEach((img, index) => {
                    // 避免重复添加事件监听器
                    if (img.dataset.zoomEnabled) {
                        return;
                    }
                    
                    // 标记已处理
                    img.dataset.zoomEnabled = 'true';
                    
                    // 添加图片加载状态日志
                    const imgSrc = img.src;
                    const imgAlt = img.alt || `图片${index + 1}`;
                    
                    console.log(`🖼️ 处理图片 ${index + 1}: ${imgAlt}`, {
                        src: imgSrc,
                        naturalWidth: img.naturalWidth,
                        naturalHeight: img.naturalHeight,
                        complete: img.complete
                    });
                    
                    // 添加加载成功事件
                    img.addEventListener('load', function() {
                        console.log(`✅ 图片加载成功: ${imgAlt}`, {
                            src: this.src,
                            naturalWidth: this.naturalWidth,
                            naturalHeight: this.naturalHeight,
                            displayWidth: this.width,
                            displayHeight: this.height
                        });
                    });
                    
                    // 添加加载失败事件
                    img.addEventListener('error', function() {
                        console.error(`❌ 图片加载失败: ${imgAlt}`, {
                            src: this.src,
                            error: '加载失败'
                        });
                        
                        // 添加错误提示
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = `
                            border: 2px dashed #ff6b6b;
                            border-radius: 8px;
                            padding: 20px;
                            margin: 10px 0;
                            background-color: #fff5f5;
                            color: #c53030;
                            text-align: center;
                            font-size: 14px;
                        `;
                        errorDiv.innerHTML = `
                            <div style="font-weight: bold;">图片加载失败</div>
                            <div style="margin-top: 8px; font-size: 12px; word-break: break-all;">${this.src}</div>
                            <div style="margin-top: 8px; font-size: 12px;">原因：网络错误或图片不存在</div>
                        `;
                        
                        // 在图片位置显示错误信息
                        this.parentNode.replaceChild(errorDiv, this);
                    });
                    
                    // 添加点击事件
                    img.addEventListener('click', function() {
                        console.log(`🖱️ 点击图片: ${imgAlt}`);
                        showImageModal(this);
                    });
                });
            }
            
            // 显示图片放大模态框
            function showImageModal(img) {
                const imgSrc = img.src;
                const imgAlt = img.alt || '图片';
                
                console.log(`🔍 显示图片模态框: ${imgAlt}`, {
                    src: imgSrc,
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight
                });
                
                // 创建模态框
                const modal = document.createElement('div');
                modal.className = 'image-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: zoom-out;
                `;
                
                // 创建放大的图片
                const modalImg = document.createElement('img');
                modalImg.src = imgSrc;
                modalImg.alt = imgAlt;
                modalImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;
                
                // 添加模态框图片加载事件
                modalImg.addEventListener('load', function() {
                    console.log(`✅ 模态框图片加载成功: ${imgAlt}`);
                });
                
                modalImg.addEventListener('error', function() {
                    console.error(`❌ 模态框图片加载失败: ${imgAlt}`);
                    
                    // 显示错误信息
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        color: white;
                        text-align: center;
                        padding: 20px;
                        background-color: rgba(255, 0, 0, 0.8);
                        border-radius: 8px;
                    `;
                    errorDiv.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold;">图片加载失败</div>
                        <div style="margin-top: 10px; font-size: 14px; word-break: break-all;">${imgSrc}</div>
                    `;
                    
                    modal.innerHTML = '';
                    modal.appendChild(errorDiv);
                });
                
                modal.appendChild(modalImg);
                
                // 添加关闭事件
                modal.addEventListener('click', function() {
                    console.log(`❌ 关闭图片模态框: ${imgAlt}`);
                    modal.remove();
                });
                
                // 添加ESC键关闭
                const handleEsc = function(e) {
                    if (e.key === 'Escape') {
                        console.log(`⌨️ ESC键关闭图片模态框: ${imgAlt}`);
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                document.body.appendChild(modal);
                console.log(`📱 图片模态框已添加到页面`);
            }
            
                                // 添加代码复制功能
            function addCodeCopyButtons(element) {
                const preElements = element.querySelectorAll('pre code');
                preElements.forEach(code => {
                    const pre = code.parentElement;
                    
                    // 避免重复添加按钮
                    if (pre.querySelector('.code-copy-button')) {
                        return;
                    }
                    
                    // 创建复制按钮
                    const copyButton = document.createElement('button');
                    copyButton.className = 'code-copy-button';
                    copyButton.textContent = '复制';
                    copyButton.style.cssText = `
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background-color: #f6f8fa;
                        border: 1px solid #d0d7de;
                        border-radius: 4px;
                        padding: 4px 8px;
                        font-size: 12px;
                        cursor: pointer;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        z-index: 1;
                        font-family: inherit;
                    `;
                    
                    // 设置pre元素为相对定位
                    pre.style.position = 'relative';
                    
                    // 检查当前主题并应用相应样式
                    const isDarkMode = document.body.classList.contains('dark-mode') || 
                                      (!document.body.classList.contains('light-mode') && 
                                       window.matchMedia('(prefers-color-scheme: dark)').matches);
                    
                    if (isDarkMode) {
                        copyButton.style.backgroundColor = '#21262d';
                        copyButton.style.color = '#c9d1d9';
                        copyButton.style.borderColor = '#30363d';
                    }
                    
                    // 鼠标悬停显示按钮
                    pre.addEventListener('mouseenter', () => {
                        copyButton.style.opacity = '1';
                    });
                    
                    pre.addEventListener('mouseleave', () => {
                        copyButton.style.opacity = '0';
                    });
                    
                    // 点击复制
                    copyButton.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(code.textContent);
                            copyButton.textContent = '已复制';
                            setTimeout(() => {
                                copyButton.textContent = '复制';
                            }, 2000);
                        } catch (err) {
                            // 降级方案
                            const textArea = document.createElement('textarea');
                            textArea.value = code.textContent;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            copyButton.textContent = '已复制';
                            setTimeout(() => {
                                copyButton.textContent = '复制';
                            }, 2000);
                        }
                    });
                    
                    pre.appendChild(copyButton);
                });
            }
            
            // 优化任务列表样式
            function enhanceTaskLists(element) {
                const taskItems = element.querySelectorAll('li');
                taskItems.forEach(item => {
                    const text = item.innerHTML;
                    // 检查是否为任务列表项
                    if (text.includes('☐') || text.includes('☑') || text.includes('✓') || 
                        text.includes('[ ]') || text.includes('[x]') || text.includes('[X]')) {
                        
                        // 替换任务列表标记
                        let newText = text
                            .replace(/☐|☑|✓|\[[ ]\]|\[x\]|\[X\]/g, (match) => {
                                const isChecked = match === '☑' || match === '✓' || match === '[x]' || match === '[X]';
                                return `<input type="checkbox" ${isChecked ? 'checked' : ''} disabled style="margin-right: 8px;">`;
                            });
                        
                        item.innerHTML = newText;
                        item.style.listStyle = 'none';
                        item.style.marginLeft = '-20px';
                        
                        // 如果已完成，添加删除线样式
                        if (text.includes('☑') || text.includes('✓') || text.includes('[x]') || text.includes('[X]')) {
                            item.style.textDecoration = 'line-through';
                            item.style.opacity = '0.7';
                        }
                    }
                });
            }
            
            // Mermaid渲染失败备用方案
            function tryFallbackRender(diagramId, originalCode, processedCode, container, error, index) {
                console.log(`🔄 尝试Mermaid图表 ${index + 1} 的备用渲染方案`);
                
                // 方案1: 尝试使用原始代码渲染（如果修复后的代码失败）
                if (processedCode !== originalCode.trim()) {
                    console.log('🔄 尝试使用原始代码渲染');
                    mermaid.render(`${diagramId}-fallback-1`, originalCode.trim()).then(result => {
                        container.innerHTML = result.svg;
                        console.log(`✅ 使用原始代码渲染成功`);
                        
                        // 应用移动端优化
                        applyMobileOptimization(container.querySelector('svg'), originalCode.trim());
                        
                    }).catch(fallbackError => {
                        console.warn('❌ 原始代码渲染也失败:', fallbackError);
                        
                        // 方案2: 尝试简化版本
                        trySimplifiedFallback(diagramId, originalCode, container, error, index);
                    });
                } else {
                    // 直接尝试简化版本
                    trySimplifiedFallback(diagramId, originalCode, container, error, index);
                }
            }
            
            // 简化版本备用方案
            function trySimplifiedFallback(diagramId, originalCode, container, error, index) {
                console.log(`🔄 尝试简化版本备用方案`);
                
                let simplifiedCode = originalCode.trim();
                
                // 实体关系图简化
                if (simplifiedCode.startsWith('erDiagram')) {
                    simplifiedCode = `
erDiagram
    ENTITY_A {
        string id
        string name
    }
    
    ENTITY_B {
        string id
        string data
    }
    
    ENTITY_A ||--o{ ENTITY_B : contains
                    `.trim();
                    
                    console.log('🔄 使用简化的实体关系图');
                    
                // 甘特图简化  
                } else if (simplifiedCode.startsWith('gantt')) {
                    simplifiedCode = `
gantt
    title 简化时间线
    dateFormat YYYY-MM-DD
    
    section 阶段
    任务A : done, 2024-01-01, 30d
    任务B : active, 2024-02-01, 30d
                    `.trim();
                    
                    console.log('🔄 使用简化的甘特图');
                    
                // 其他图表类型的简化处理
                } else {
                    console.log('🔄 图表类型不支持简化，显示错误信息');
                    showErrorMessage(container, error, originalCode, index);
                    return;
                }
                
                // 尝试渲染简化版本
                mermaid.render(`${diagramId}-simplified`, simplifiedCode).then(result => {
                    container.innerHTML = `
                        <div style="margin-bottom: 12px; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px; color: #856404;">
                            ⚠️ 原始图表渲染失败，显示简化版本
                        </div>
                        ${result.svg}
                    `;
                    
                    console.log(`✅ 简化版本渲染成功`);
                    
                    // 应用移动端优化
                    applyMobileOptimization(container.querySelector('svg'), simplifiedCode);
                    
                }).catch(simplifiedError => {
                    console.error('❌ 简化版本渲染也失败:', simplifiedError);
                    showErrorMessage(container, error, originalCode, index);
                });
            }
            
            // 应用移动端优化到SVG
            function applyMobileOptimization(svg, code) {
                if (!svg) return;
                
                svg.style.maxWidth = '100%';
                svg.style.height = 'auto';
                svg.style.touchAction = 'pan-x pan-y';
                
                const isGantt = code.trim().startsWith('gantt');
                const isER = code.trim().startsWith('erDiagram');
                
                if (isGantt) {
                    svg.setAttribute('data-chart-type', 'gantt');
                } else if (isER) {
                    svg.setAttribute('data-chart-type', 'er');
                }
            }
            
            // 显示错误信息
            function showErrorMessage(container, error, originalCode, index) {
                const isDarkMode = document.body.classList.contains('dark-mode');
                
                container.innerHTML = `
                    <div style="
                        color: #d73a49; 
                        background-color: ${isDarkMode ? '#2d1b1f' : '#ffeef0'}; 
                        border: 1px solid ${isDarkMode ? '#8b5862' : '#fdaeb7'}; 
                        border-radius: 6px; 
                        padding: 16px; 
                        font-family: inherit;
                        font-size: 14px;
                        margin: 20px 0;
                    ">
                        <strong>📊 Mermaid图表渲染失败</strong><br>
                        <div style="margin: 8px 0; font-size: 13px; color: ${isDarkMode ? '#ff7979' : '#d73a49'};">
                            错误: ${error.message || '未知语法错误'}
                        </div>
                        
                        <div style="margin: 12px 0; padding: 8px; background: ${isDarkMode ? '#1a1a1a' : '#f8f9fa'}; border-radius: 4px; font-size: 12px; color: ${isDarkMode ? '#e1e4e8' : '#586069'};">
                            💡 <strong>可能的解决方案:</strong><br>
                            • 检查实体关系图的属性定义语法<br>
                            • 使用 <code>string field_name</code> 格式定义字段<br>
                            • 避免使用 PK、FK 等关键字<br>
                            • 确保关系语法正确: <code>ENTITY_A ||--o{ ENTITY_B : relationship</code>
                        </div>
                        
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; color: ${isDarkMode ? '#58a6ff' : '#0366d6'}; font-weight: 500;">
                                📝 查看原始代码
                            </summary>
                            <pre style="
                                margin-top: 8px; 
                                background: ${isDarkMode ? '#161b22' : '#f6f8fa'}; 
                                color: ${isDarkMode ? '#e1e4e8' : '#24292e'};
                                padding: 12px; 
                                border-radius: 4px; 
                                overflow-x: auto;
                                font-size: 12px;
                                border: 1px solid ${isDarkMode ? '#30363d' : '#d1d5da'};
                            ">${originalCode}</pre>
                        </details>
                        
                        <div style="margin-top: 12px; font-size: 12px; color: ${isDarkMode ? '#8b949e' : '#6a737d'};">
                            🔧 系统已尝试自动修复语法，但仍然失败。请检查图表语法是否正确。
                        </div>
                    </div>
                `;
            }
            
            // Mermaid语法兼容性修复函数
            function fixMermaidCompatibility(code) {
                let fixedCode = code.trim();
                
                try {
                    // 检测实体关系图并修复常见问题
                    if (fixedCode.startsWith('erDiagram')) {
                        console.log('🔧 检测到实体关系图，应用兼容性修复');
                        
                        // 修复属性定义中的PK/FK问题
                        fixedCode = fixedCode.replace(/(\w+)\s+PK\s*$/gm, 'string $1')
                                           .replace(/(\w+)\s+FK\s*$/gm, 'string $1')
                                           .replace(/(\w+)\s+PK\s+/gm, 'string $1 ')
                                           .replace(/(\w+)\s+FK\s+/gm, 'string $1 ');
                        
                        // 修复没有类型声明的属性
                        const lines = fixedCode.split('\n');
                        let inEntity = false;
                        let fixedLines = [];
                        
                        for (let line of lines) {
                            const trimmedLine = line.trim();
                            
                            if (trimmedLine.includes('{')) {
                                inEntity = true;
                                fixedLines.push(line);
                            } else if (trimmedLine.includes('}')) {
                                inEntity = false;
                                fixedLines.push(line);
                            } else if (inEntity && trimmedLine && !trimmedLine.includes('--') && !trimmedLine.includes(':')) {
                                // 这是一个属性行，检查是否需要添加类型
                                if (!trimmedLine.includes('string ') && !trimmedLine.includes('int ') && !trimmedLine.includes('boolean ')) {
                                    fixedLines.push(`        string ${trimmedLine}`);
                                } else {
                                    fixedLines.push(line);
                                }
                            } else {
                                fixedLines.push(line);
                            }
                        }
                        
                        fixedCode = fixedLines.join('\n');
                        
                        // 修复关系语法兼容性
                        fixedCode = fixedCode.replace(/(\w+)\s*\}o--\|\|\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*\|\|--o\}\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*--\>\s*(\w+)\s*:\s*(.+)/g, '$1 ||--o{ $2 : $3')
                                           .replace(/(\w+)\s*\<--\s*(\w+)\s*:\s*(.+)/g, '$2 ||--o{ $1 : $3');
                        
                        // 修复中文关系标签和特殊字符
                        fixedCode = fixedCode.replace(/:\s*["']([^"']*["'][^"']*["'][^"']*)["']/g, ': contains')
                                           .replace(/:\s*["']?属于["']?/g, ': belongs_to')
                                           .replace(/:\s*["']?包含["']?/g, ': contains')
                                           .replace(/:\s*["']?拥有["']?/g, ': has')
                                           .replace(/:\s*["']?关联["']?/g, ': relates_to')
                                           .replace(/:\s*["']?引用["']?/g, ': references');
                        
                        console.log('✅ 实体关系图语法修复完成');
                    }
                    
                    // 检测甘特图并修复常见问题
                    if (fixedCode.startsWith('gantt')) {
                        console.log('🔧 检测到甘特图，应用兼容性修复');
                        
                        // 确保正确的日期格式
                        if (!fixedCode.includes('dateFormat')) {
                            fixedCode = fixedCode.replace('gantt', 'gantt\n    dateFormat YYYY-MM-DD');
                        }
                        
                        // 修复轴格式
                        fixedCode = fixedCode.replace(/axisFormat\s+['"]?%m\/%d['"]?/g, 'axisFormat %m月');
                        
                        console.log('✅ 甘特图语法修复完成');
                    }
                    
                    // 通用修复：移除不支持的classDef
                    fixedCode = fixedCode.replace(/classDef\s+\w+\s+[^;]+;?\s*/g, '');
                    
                    // 通用修复：移除不支持的class应用
                    fixedCode = fixedCode.replace(/class\s+[\w,\s]+\s+\w+\s*/g, '');
                    
                    if (fixedCode !== code.trim()) {
                        console.log('🔧 Mermaid代码已修复');
                        console.log('📝 原始代码:', code.substring(0, 100) + (code.length > 100 ? '...' : ''));
                        console.log('🔧 修复后:', fixedCode.substring(0, 100) + (fixedCode.length > 100 ? '...' : ''));
                        console.log('📊 长度变化:', code.length, '->', fixedCode.length);
                    }
                    
                } catch (error) {
                    console.warn('⚠️ Mermaid语法修复过程中出现错误:', error);
                    return code.trim(); // 返回原始代码
                }
                
                return fixedCode;
            }
            
            // 处理Mermaid图表
            function renderMermaidDiagrams(element) {
                if (typeof mermaid === 'undefined') {
                    console.warn('⚠️ Mermaid未加载，跳过图表渲染');
                    return;
                }
                
                const mermaidBlocks = element.querySelectorAll('pre code.language-mermaid');
                console.log(`🎨 发现 ${mermaidBlocks.length} 个Mermaid图表`);
                
                mermaidBlocks.forEach((code, index) => {
                    // 避免重复处理
                    if (code.dataset.mermaidProcessed) {
                        return;
                    }
                    
                    const pre = code.parentElement;
                    const mermaidCode = code.textContent.trim();
                    
                    if (!mermaidCode) {
                        console.warn(`⚠️ Mermaid图表 ${index + 1} 内容为空`);
                        return;
                    }
                    
                    console.log(`🎨 渲染Mermaid图表 ${index + 1}:`, mermaidCode.substring(0, 50) + '...');
                    
                    // 预处理Mermaid代码，修复兼容性问题
                    let processedCode = fixMermaidCompatibility(mermaidCode);
                    
                    // 创建Mermaid容器
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid-diagram';
                    mermaidDiv.style.cssText = `
                        margin: 20px 0;
                        text-align: center;
                        background-color: transparent;
                        border-radius: 8px;
                        padding: 20px;
                        overflow-x: auto;
                        border: 1px solid #e1e4e8;
                    `;
                    
                    // 为移动端优化
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    if (isDarkMode) {
                        mermaidDiv.style.borderColor = '#30363d';
                        mermaidDiv.style.backgroundColor = 'rgba(22, 27, 34, 0.5)';
                    }
                    
                    // 生成唯一ID
                    const diagramId = `mermaid-diagram-${Date.now()}-${index}`;
                    
                    try {
                        // 使用mermaid.render渲染图表
                        mermaid.render(diagramId, processedCode).then(result => {
                            mermaidDiv.innerHTML = result.svg;
                            
                            // 优化SVG样式
                            const svg = mermaidDiv.querySelector('svg');
                            if (svg) {
                                svg.style.maxWidth = '100%';
                                svg.style.height = 'auto';
                                
                                // 移动端触摸优化
                                svg.style.touchAction = 'pan-x pan-y';
                                
                                // 检测图表类型并应用特定优化
                                const isGantt = processedCode.trim().startsWith('gantt');
                                const isER = processedCode.trim().startsWith('erDiagram');
                                
                                if (isGantt) {
                                    console.log(`🗓️ 应用甘特图移动端优化`);
                                    // 甘特图特殊优化
                                    svg.setAttribute('data-chart-type', 'gantt');
                                    
                                    // 移动端屏幕宽度检测
                                    if (window.innerWidth <= 768) {
                                        // 调整甘特图在移动端的显示
                                        const tasks = svg.querySelectorAll('.taskText, .sectionTitle');
                                        tasks.forEach(task => {
                                            task.style.fontSize = window.innerWidth <= 480 ? '11px' : '12px';
                                        });
                                        
                                        // 调整时间轴标签
                                        const axisLabels = svg.querySelectorAll('.grid .tick text');
                                        axisLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                        });
                                    }
                                    
                                    // 设置甘特图容器的特殊样式
                                    mermaidDiv.style.overflowX = 'auto';
                                    mermaidDiv.style.WebkitOverflowScrolling = 'touch';
                                    
                                } else if (isER) {
                                    console.log(`🗃️ 应用实体关系图移动端优化`);
                                    // 实体关系图特殊优化
                                    svg.setAttribute('data-chart-type', 'er');
                                    
                                    // 移动端优化
                                    if (window.innerWidth <= 768) {
                                        // 调整实体标签字体
                                        const entityLabels = svg.querySelectorAll('.entityLabel');
                                        entityLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '12px' : '13px';
                                        });
                                        
                                        // 调整属性文本
                                        const attributeTexts = svg.querySelectorAll('.attributeBoxOdd text, .attributeBoxEven text');
                                        attributeTexts.forEach(text => {
                                            text.style.fontSize = window.innerWidth <= 480 ? '10px' : '11px';
                                        });
                                        
                                        // 调整关系标签
                                        const relationLabels = svg.querySelectorAll('.relationshipLabel');
                                        relationLabels.forEach(label => {
                                            label.style.fontSize = window.innerWidth <= 480 ? '9px' : '10px';
                                        });
                                    }
                                    
                                    // 优化实体关系图的垂直布局
                                    mermaidDiv.style.minHeight = 'auto';
                                }
                                
                                // 通用移动端优化
                                if (window.innerWidth <= 768) {
                                    // 添加缩放提示（仅在超宽图表时）
                                    const svgWidth = svg.getBBox ? svg.getBBox().width : svg.viewBox.baseVal.width;
                                    if (svgWidth > window.innerWidth - 40) {
                                        const zoomHint = document.createElement('div');
                                        zoomHint.style.cssText = `
                                            font-size: 12px;
                                            color: #6b7280;
                                            text-align: center;
                                            margin-top: 8px;
                                            padding: 4px 8px;
                                            background: rgba(107, 114, 128, 0.1);
                                            border-radius: 4px;
                                        `;
                                        
                                    }
                                }
                                
                                console.log(`✅ Mermaid图表 ${index + 1} 渲染成功`);
                            }
                            
                            // 标记为已处理
                            code.dataset.mermaidProcessed = 'true';
                            
                        }).catch(error => {
                            console.error(`❌ Mermaid图表 ${index + 1} 渲染失败:`, error);
                            
                            // 尝试备用渲染方案
                            tryFallbackRender(diagramId, mermaidCode, processedCode, mermaidDiv, error, index);
                        });
                        
                    } catch (error) {
                        console.error(`❌ Mermaid图表 ${index + 1} 处理异常:`, error);
                        showErrorMessage(mermaidDiv, error, mermaidCode, index);
                    }
                    
                    // 替换原始代码块
                    pre.parentNode.replaceChild(mermaidDiv, pre);
                });
            }
            
            // 简化HTML处理，专注于基本移动端适配
            function enhanceHTMLElements(element) {
                // 保护LaTeX元素，避免被处理干扰
                const mathElements = element.querySelectorAll('script[type="math/tex"], .MathJax, .MathJax_Display');
                mathElements.forEach(el => {
                    el.setAttribute('data-latex-protected', 'true');
                });
                
                // 基本移动端适配
                const htmlElements = element.querySelectorAll('div, span, section, article, aside, header, footer, nav');
                htmlElements.forEach(el => {
                    // 跳过LaTeX保护的元素
                    if (el.getAttribute('data-latex-protected') || 
                        el.closest('[data-latex-protected]') ||
                        el.classList.contains('MathJax') ||
                        el.classList.contains('MathJax_Display')) {
                        return;
                    }
                    
                    // 基本移动端适配
                    if (!el.style.maxWidth) {
                        el.style.maxWidth = '100%';
                    }
                });
                
                console.log('🏷️ 基本HTML适配完成');
            }
            
            // 渲染函数
            function renderMarkdown(markdownText) {
                try {
                    // 启动性能监控
                    if (window.startRenderingTimer) {
                        window.startRenderingTimer();
                    }
                    
                    nativePrint('🚀 renderMarkdown函数开始执行');
                    nativePrint(`📝 输入内容长度: ${markdownText.length}`);
                    
                    // 确保输入是字符串类型
                    if (typeof markdownText !== 'string') {
                        console.error('❌ 输入的markdown文本不是字符串类型:', typeof markdownText);
                        return;
                    }
                    
                    // 首先执行LaTeX预处理
                    nativePrint('🔧 开始执行LaTeX预处理');
                    let processedText = markdownText;
                    
                    // 检查预处理函数是否存在
                    if (typeof window.preprocessLatexInMarkdown === 'function') {
                        nativePrint('✅ 找到预处理函数，开始处理');
                        processedText = window.preprocessLatexInMarkdown(markdownText);
                        nativePrint(`🔧 预处理完成，原始长度: ${markdownText.length}, 处理后长度: ${processedText.length}`);
                    } else {
                        nativePrint('❌ 预处理函数不存在！');
                    }
                    
                    // 检测iOS WebView环境
                    const isIOSWebView = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    
                    if (isIOSWebView && processedText) {
                        console.log('🍎 检测到iOS WebView环境');
                        // 简化处理，专注于核心渲染功能
                    }
                    
                    // 根据内容大小选择渲染策略
                    const contentSize = processedText.length;
                    console.log('📄 内容大小:', contentSize, '字符');
                    
                    if (contentSize > 50000) {
                        // 大文件使用分块渲染
                        console.log('📄 大文件使用分块渲染');
                        renderOptimizedContent(processedText);
                    } else {
                        // 小文件直接渲染
                        console.log('📄 小文件直接渲染');
                        renderDirectly(processedText);
                    }
                    
                    // iOS WebView基本处理
                    if (isIOSWebView) {
                        console.log('🍎 iOS WebView环境已优化');
                    }
                    
                } catch (error) {
                    console.error('Markdown渲染错误:', error);
                    const contentElement = document.getElementById('rendered-content');
                    if (contentElement) {
                        const isDarkMode = document.body.classList.contains('dark-mode');
                        const bgColor = isDarkMode ? '#161b22' : '#fff5f5';
                        const textColor = isDarkMode ? '#f85149' : '#d73a49';
                        const borderColor = isDarkMode ? '#f85149' : '#d73a49';
                        
                        contentElement.innerHTML = `
                            <div style="
                                background-color: ${bgColor};
                                color: ${textColor};
                                border: 1px solid ${borderColor};
                                border-radius: 8px;
                                padding: 20px;
                                margin: 20px;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                            ">
                                <h3 style="margin-top: 0; font-size: 18px;">📄 Markdown渲染失败</h3>
                                <p style="margin-bottom: 16px;">
                                    渲染过程中遇到问题，这可能是由于：
                                </p>
                                <ul style="margin-bottom: 16px; padding-left: 20px;">
                                    <li>网络连接问题导致解析库加载失败</li>
                                    <li>文档格式不兼容</li>
                                    <li>内容包含不支持的语法</li>
                                </ul>
                                <p style="margin-bottom: 16px; font-size: 14px; opacity: 0.8;">
                                    <strong>技术详情：</strong> ${error.message}
                                </p>
                                <details style="margin-top: 16px;">
                                    <summary style="cursor: pointer; color: ${textColor};">显示原始内容</summary>
                                    <pre style="
                                        margin-top: 10px;
                                        padding: 16px;
                                        background-color: ${isDarkMode ? '#0d1117' : '#f6f8fa'};
                                        border-radius: 6px;
                                        overflow-x: auto;
                                        font-size: 13px;
                                        line-height: 1.4;
                                        white-space: pre-wrap;
                                        word-wrap: break-word;
                                    ">${text || '内容为空'}</pre>
                                </details>
                            </div>
                        `;
                    }
                }
            }
            
            // 新增：直接渲染函数（用于小文件）
            function renderDirectly(processedText) {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) {
                    console.error('未找到内容容器元素');
                    return;
                }
                
                // 清空容器
                contentElement.innerHTML = '';
                
                try {
                    // 使用安全的markdown解析
                    const html = safeMarkdownParse(processedText);
                    contentElement.innerHTML = html;
                    
                    // 处理增强功能
                    processEnhancements(contentElement);
                    
                    // 结束性能监控
                    if (window.endRenderingTimer) {
                        window.endRenderingTimer('直接渲染');
                    }
                    
                    console.log('✅ 直接渲染完成');
                } catch (error) {
                    console.error('❌ 直接渲染失败:', error);
                    
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const bgColor = isDarkMode ? '#161b22' : '#fff5f5';
                    const textColor = isDarkMode ? '#f85149' : '#d73a49';
                    const borderColor = isDarkMode ? '#f85149' : '#d73a49';
                    
                    contentElement.innerHTML = `
                        <div style="
                            background-color: ${bgColor};
                            color: ${textColor};
                            border: 1px solid ${borderColor};
                            border-radius: 8px;
                            padding: 20px;
                            margin: 20px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                        ">
                            <h3 style="margin-top: 0; font-size: 18px;">🔧 渲染引擎故障</h3>
                            <p style="margin-bottom: 12px;">直接渲染模式失败，可能的原因：</p>
                            <ul style="margin-bottom: 16px; padding-left: 20px;">
                                <li>Markdown解析库未正确加载</li>
                                <li>网络连接中断</li>
                                <li>文档内容格式问题</li>
                            </ul>
                            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 16px;">
                                <strong>错误信息：</strong> ${error.message}
                            </p>
                            <div style="
                                background-color: ${isDarkMode ? '#0d1117' : '#f0f8ff'};
                                padding: 12px;
                                border-radius: 6px;
                                font-size: 13px;
                                margin-top: 12px;
                            ">
                                💡 <strong>建议：</strong>请检查网络连接，或尝试刷新页面重新加载
                            </div>
                        </div>
                    `;
                }
            }
            
            // 在markdown解析之前预处理LaTeX公式（简化版本）- 移到全局作用域
            window.preprocessLatexInMarkdown = function(markdownText) {
                nativePrint('🔧 开始预处理markdown中的LaTeX公式');
                nativePrint(`📝 原始文本长度: ${markdownText.length}`);
                nativePrint(`📝 包含$符号数量: ${(markdownText.match(/\$/g) || []).length}`);
                nativePrint(`📝 函数作用域测试: ${typeof window !== 'undefined' ? 'window可用' : 'window不可用'}`);
                
                let processedText = markdownText;
                
                // 简化的LaTeX公式处理函数
                function processLatexFormula(formula) {
                    nativePrint(`🔍 开始处理公式: "${formula}"`);
                    nativePrint(`📊 公式长度: ${formula.length}, 包含中文: ${/[原反补码]/.test(formula)}`);
                    let processed = formula;
                    
                    // 1. 处理\mathrm{中文}转换为\text{中文}
                    const mathrm_matches = processed.match(/\\mathrm\{([^}]*[原反补码][^}]*)\}/g);
                    if (mathrm_matches) {
                        nativePrint(`  找到\\mathrm匹配:`, mathrm_matches);
                        processed = processed.replace(/\\mathrm\{([^}]*[原反补码][^}]*)\}/g, (match, content) => {
                            nativePrint(`  转换 \\mathrm{${content}} -> \\text{${content}}`);
                            return `\\text{${content}}`;
                        });
                    }
                    
                    // 2. 处理裸中文下标：_{中文}
                    const chinese_bracket_matches = processed.match(/_{([^}]*[原反补码][^}]*)}/g);
                    if (chinese_bracket_matches) {
                        nativePrint(`  找到中文下标匹配:`, chinese_bracket_matches);
                        processed = processed.replace(/_{([^}]*[原反补码][^}]*)}/g, (match, content) => {
                            if (content.includes('\\text{') || content.includes('\\mathrm{')) {
                                nativePrint(`  跳过已处理的: ${match}`);
                                return match;
                            }
                            const wrapped = content.replace(/([原反补码])/g, '\\text{$1}');
                            nativePrint(`  处理中文下标: ${content} -> ${wrapped}`);
                            return `_{${wrapped}}`;
                        });
                    }
                    
                    // 3. 处理简单中文下标：_中文
                    const simple_chinese_matches = processed.match(/_([原反补码])/g);
                    if (simple_chinese_matches) {
                        nativePrint(`  找到简单中文下标匹配:`, simple_chinese_matches);
                        processed = processed.replace(/_([原反补码])/g, (match, char) => {
                            nativePrint(`  处理简单中文下标: ${char} -> \\text{${char}}`);
                            return `_{\\text{${char}}}`;
                        });
                    }
                    
                    // 4. 处理英文下标宏
                    const macros = ['orig', 'inv', 'comp', 'code', 'binary', 'decimal', 'hex', 'octal'];
                    macros.forEach(macro => {
                        // 处理_{macro}格式
                        const bracketPattern = new RegExp(`_{(${macro})}`, 'g');
                        const bracketMatches = processed.match(bracketPattern);
                        if (bracketMatches) {
                            nativePrint(`  找到英文下标宏: _{${macro}}`, bracketMatches);
                            processed = processed.replace(bracketPattern, `_{\\${macro}}`);
                        }
                        
                        // 处理_macro格式（单词边界）
                        const simplePattern = new RegExp(`_${macro}\\b`, 'g');
                        const simpleMatches = processed.match(simplePattern);
                        if (simpleMatches) {
                            nativePrint(`  找到简单英文下标宏: _${macro}`, simpleMatches);
                            processed = processed.replace(simplePattern, `_{\\${macro}}`);
                        }
                    });
                    
                    if (processed !== formula) {
                        nativePrint(`  🎯 公式处理结果: "${formula}" -> "${processed}"`);
                    } else {
                        nativePrint(`  ⚪ 公式无需修改: "${formula}"`);
                    }
                    
                    return processed;
                }
                
                // 处理所有LaTeX公式 - 使用改进的匹配方式
                let modified = false;
                
                // 处理行内公式：$...$
                nativePrint('🔍 开始处理行内公式');
                nativePrint(`📝 原始文本: ${processedText}`);
                
                // 改进的LaTeX公式匹配：处理逗号分隔的多个公式
                function processInlineLatex(text) {
                    let result = text;
                    let processedCount = 0;
                    
                    // 使用更精确的匹配：贪婪匹配最短的$...$
                    const matches = [];
                    let index = 0;
                    
                    while (index < result.length) {
                        const startIndex = result.indexOf('$', index);
                        if (startIndex === -1) break;
                        
                        const endIndex = result.indexOf('$', startIndex + 1);
                        if (endIndex === -1) break;
                        
                        const formula = result.substring(startIndex + 1, endIndex);
                        
                        // 确保这不是$$...$$格式的一部分
                        if (startIndex > 0 && result[startIndex - 1] === '$') {
                            nativePrint(`  跳过双$格式开始: ${formula}`);
                            index = startIndex + 1;
                            continue;
                        }
                        if (endIndex < result.length - 1 && result[endIndex + 1] === '$') {
                            nativePrint(`  跳过双$格式结束: ${formula}`);
                            index = endIndex + 1;
                            continue;
                        }
                        
                        matches.push({
                            full: result.substring(startIndex, endIndex + 1),
                            formula: formula,
                            start: startIndex,
                            end: endIndex + 1
                        });
                        
                        index = endIndex + 1;
                    }
                    
                    nativePrint(`🔍 找到 ${matches.length} 个行内公式:`, matches);
                    
                    // 从后向前处理，避免索引偏移
                    for (let i = matches.length - 1; i >= 0; i--) {
                        const match = matches[i];
                        nativePrint(`🔧 处理公式 ${i + 1}: "${match.formula}"`);
                        
                        const processed = processLatexFormula(match.formula);
                        if (processed !== match.formula) {
                            modified = true;
                            nativePrint(`  ✅ 公式已修改: "${match.formula}" -> "${processed}"`);
                        } else {
                            nativePrint(`  ⚪ 公式无需修改: "${match.formula}"`);
                        }
                        
                        const newFormula = `$${processed}$`;
                        result = result.substring(0, match.start) + newFormula + result.substring(match.end);
                        processedCount++;
                    }
                    
                    nativePrint(`✅ 处理完成，共处理 ${processedCount} 个公式`);
                    return result;
                }
                
                processedText = processInlineLatex(processedText);
                nativePrint(`📝 处理后的文本: ${processedText}`);
                
                // 处理块级公式：$$...$$
                processedText = processedText.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `$$${processed}$$`;
                });
                
                // 处理\(...\)格式
                processedText = processedText.replace(/\\\(([^)]+)\\\)/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `\\(${processed}\\)`;
                });
                
                // 处理\[...\]格式
                processedText = processedText.replace(/\\\[([^\]]+)\\\]/g, (match, formula) => {
                    const processed = processLatexFormula(formula);
                    if (processed !== formula) {
                        modified = true;
                    }
                    return `\\[${processed}\\]`;
                });
                
                if (modified) {
                    nativePrint('✅ LaTeX预处理完成，有修改');
                } else {
                    nativePrint('⚪ LaTeX预处理完成，无修改');
                }
                
                nativePrint(`📤 返回处理后的文本: ${processedText}`);
                return processedText;
            };
            
            // 预处理LaTeX公式中的中文下标（修复多个表达式识别问题）
            function preprocessChineseSubscripts(container) {
                console.log('🔧 开始预处理LaTeX公式中的中文下标');
                
                // 改进的预处理函数，修复多个LaTeX表达式识别问题
                function processSubscriptsInText(text) {
                    let content = text;
                    let modified = false;
                    
                    // 通用的LaTeX公式处理函数（不仅处理中文，确保所有公式都能正确渲染）
                    function processSubscriptsInFormula(formula) {
                        let processedFormula = formula;
                        console.log(`🔍 处理公式: ${formula}`);
                        
                        // 1. 处理\mathrm{中文}转换为\text{中文}
                        if (processedFormula.includes('\\mathrm{')) {
                            const originalFormula = processedFormula;
                            processedFormula = processedFormula.replace(/\\mathrm\{([^}]*[原反补码][^}]*)\}/g, (match, subscript) => {
                                console.log(`📝 转换\\mathrm{}为\\text{}: ${match} -> \\text{${subscript}}`);
                                return `\\text{${subscript}}`;
                            });
                            if (processedFormula !== originalFormula) {
                                console.log(`  ✅ \\mathrm{}转换完成`);
                            }
                        }
                        
                        // 2. 处理裸中文下标（没有\text{}包装的）
                        const originalFormulaBeforeChineseProcessing = processedFormula;
                        
                        // 处理带大括号的中文下标：_{中文字符}
                        processedFormula = processedFormula.replace(/_{([^}]*[原反补码][^}]*)}/g, (match, subscript) => {
                            // 如果已经包含\text{}或\mathrm{}，不重复处理
                            if (subscript.includes('\\text{') || subscript.includes('\\mathrm{')) {
                                return match;
                            }
                            
                            const wrappedSubscript = subscript.replace(/([原反补码])/g, '\\text{$1}');
                            console.log(`📝 处理中文下标: ${subscript} -> ${wrappedSubscript}`);
                            return `_{${wrappedSubscript}}`;
                        });
                        
                        // 处理简单的中文下标：_中文（没有大括号）
                        processedFormula = processedFormula.replace(/_([原反补码])/g, (match, subscript) => {
                            console.log(`📝 处理简单中文下标: ${subscript} -> \\text{${subscript}}`);
                            return `_{\\text{${subscript}}}`;
                        });
                        
                        if (processedFormula !== originalFormulaBeforeChineseProcessing) {
                            console.log(`  ✅ 中文下标处理完成`);
                        }
                        
                        // 3. 处理英文下标宏（确保宏能正确识别）
                        const originalFormulaBeforeEnglishProcessing = processedFormula;
                        const englishMacros = ['orig', 'inv', 'comp', 'code', 'binary', 'decimal', 'hex', 'octal'];
                        
                        englishMacros.forEach(macro => {
                            // 处理有大括号的英文下标：_{macro}
                            const bracketPattern = new RegExp(`_{(${macro})}`, 'g');
                            processedFormula = processedFormula.replace(bracketPattern, (match, subscript) => {
                                console.log(`📝 处理英文下标宏: ${subscript} -> \\${subscript}`);
                                return `_{\\${subscript}}`;
                            });
                            
                            // 处理没有大括号的英文下标：_macro
                            const simplePattern = new RegExp(`_${macro}\\b`, 'g');
                            processedFormula = processedFormula.replace(simplePattern, (match) => {
                                console.log(`📝 处理简单英文下标宏: ${macro} -> \\${macro}`);
                                return `_{\\${macro}}`;
                            });
                        });
                        
                        if (processedFormula !== originalFormulaBeforeEnglishProcessing) {
                            console.log(`  ✅ 英文下标宏处理完成`);
                        }
                        
                        // 4. 验证LaTeX语法（确保所有公式都是有效的）
                        const openBraces = (processedFormula.match(/\{/g) || []).length;
                        const closeBraces = (processedFormula.match(/\}/g) || []).length;
                        if (openBraces !== closeBraces) {
                            console.warn(`⚠️  括号不匹配，使用原始公式: ${formula}`);
                            return formula;
                        }
                        
                        // 5. 最终结果
                        if (processedFormula !== formula) {
                            console.log(`  ✅ 公式处理完成: ${formula} -> ${processedFormula}`);
                        } else {
                            console.log(`  ✅ 公式验证通过，无需修改: ${formula}`);
                        }
                        
                        return processedFormula;
                    }
                    
                    // 处理行内公式：$...$（改进版本，避免重复替换）
                    let processedContent = content;
                    const inlineMatches = [...content.matchAll(/\$([^$]+)\$/g)];
                    if (inlineMatches.length > 0) {
                        console.log(`🔍 发现 ${inlineMatches.length} 个行内公式`);
                        
                        // 从后往前处理，避免索引偏移问题
                        for (let i = inlineMatches.length - 1; i >= 0; i--) {
                            const match = inlineMatches[i];
                            const fullMatch = match[0];
                            const formula = match[1];
                            const startIndex = match.index;
                            
                            console.log(`🔧 处理行内公式 ${i + 1}: ${formula}`);
                            const processedFormula = processSubscriptsInFormula(formula);
                            
                            if (processedFormula !== formula) {
                                modified = true;
                                console.log(`  ✅ 已处理: ${formula} -> ${processedFormula}`);
                            }
                            
                            // 精确替换，避免重复替换问题
                            processedContent = processedContent.slice(0, startIndex) + 
                                              `$${processedFormula}$` + 
                                              processedContent.slice(startIndex + fullMatch.length);
                        }
                    }
                    content = processedContent;
                    
                    // 处理块级公式：$$...$$（改进版本，避免重复替换）
                    processedContent = content;
                    const displayMatches = [...content.matchAll(/\$\$([^$]+)\$\$/g)];
                    if (displayMatches.length > 0) {
                        console.log(`🔍 发现 ${displayMatches.length} 个块级公式`);
                        
                        // 从后往前处理，避免索引偏移问题
                        for (let i = displayMatches.length - 1; i >= 0; i--) {
                            const match = displayMatches[i];
                            const fullMatch = match[0];
                            const formula = match[1];
                            const startIndex = match.index;
                            
                            console.log(`🔧 处理块级公式 ${i + 1}: ${formula}`);
                            const processedFormula = processSubscriptsInFormula(formula);
                            
                            if (processedFormula !== formula) {
                                modified = true;
                                console.log(`  ✅ 已处理: ${formula} -> ${processedFormula}`);
                            }
                            
                            // 精确替换，避免重复替换问题
                            processedContent = processedContent.slice(0, startIndex) + 
                                              `$$${processedFormula}$$` + 
                                              processedContent.slice(startIndex + fullMatch.length);
                        }
                    }
                    content = processedContent;
                    
                    // 处理行内公式的另一种形式：\(...\)
                    const parenMatches = content.match(/\\\([^)]+\\\)/g);
                    if (parenMatches) {
                        console.log(`🔍 发现 ${parenMatches.length} 个\\(\\)行内公式:`, parenMatches);
                        
                        parenMatches.forEach((match, index) => {
                            const formula = match.slice(2, -2); // 去掉\(和\)符号
                            const processedFormula = processSubscriptsInFormula(formula);
                            if (processedFormula !== formula) {
                                modified = true;
                                console.log(`🔧 处理\\(\\)行内公式 ${index + 1}: ${formula} -> ${processedFormula}`);
                                content = content.replace(match, `\\(${processedFormula}\\)`);
                            }
                        });
                    }
                    
                    // 处理块级公式的另一种形式：\[...\]
                    const bracketMatches = content.match(/\\\[[^\]]+\\\]/g);
                    if (bracketMatches) {
                        console.log(`🔍 发现 ${bracketMatches.length} 个\\[\\]块级公式:`, bracketMatches);
                        
                        bracketMatches.forEach((match, index) => {
                            const formula = match.slice(2, -2); // 去掉\[和\]符号
                            const processedFormula = processSubscriptsInFormula(formula);
                            if (processedFormula !== formula) {
                                modified = true;
                                console.log(`🔧 处理\\[\\]块级公式 ${index + 1}: ${formula} -> ${processedFormula}`);
                                content = content.replace(match, `\\[${processedFormula}\\]`);
                            }
                        });
                    }
                    
                    return { content, modified };
                }
                
                // 处理容器内的所有文本节点（包括列表项）
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    // 扩展检查条件，确保能够找到所有包含数学公式的节点
                    if (node.textContent.includes('$') || 
                        node.textContent.includes('\\') || 
                        node.textContent.includes('mathrm') ||
                        /[原反补码]/.test(node.textContent)) {
                        textNodes.push(node);
                        console.log(`🔍 发现包含数学公式的文本节点: "${node.textContent.substring(0, 50)}..."`);
                    }
                }
                
                // 处理所有包含数学公式的文本节点
                textNodes.forEach(textNode => {
                    const result = processSubscriptsInText(textNode.textContent);
                    if (result.modified) {
                        textNode.textContent = result.content;
                        console.log('✅ 已更新文本节点内容');
                    }
                });
                
                console.log('🔧 LaTeX中文下标和\\mathrm{}语法预处理完成');
            }
            
            // 检测网络连接状态
            function checkNetworkStatus() {
                if ('onLine' in navigator) {
                    console.log(`🌐 网络状态: ${navigator.onLine ? '在线' : '离线'}`);
                }
                
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    console.log('📶 网络连接信息:', {
                        effectiveType: connection.effectiveType,
                        downlink: connection.downlink,
                        rtt: connection.rtt
                    });
                }
                
                // 测试网络连接
                const testImage = new Image();
                testImage.onload = () => {
                    console.log('✅ 网络连接测试: 成功');
                };
                testImage.onerror = () => {
                    console.error('❌ 网络连接测试: 失败');
                };
                testImage.src = 'https://httpbin.org/image/png?_=' + Date.now();
            }
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    console.log('📱 页面加载完成，开始初始化');
                    
                    // 检测网络状态
                    checkNetworkStatus();
                    
                    // 配置marked.js（如果可用）
                    configureMarked();
                    
                    // 初始化目录功能
                    initTOC();
                    
                    // 初始化Mermaid
                    initMermaid();
                    
                    // 检查viewport设置（移动端优化提醒）
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (!viewport || !viewport.content.includes('width=device-width')) {
                        console.warn('⚠️ 建议添加viewport meta标签以优化移动端显示');
                    }
                    
                    // 监听网络状态变化
                    window.addEventListener('online', () => {
                        console.log('🌐 网络已连接');
                    });
                    
                    window.addEventListener('offline', () => {
                        console.warn('🚫 网络已断开');
                    });
                    
                    console.log('✅ 页面初始化完成');
                } catch (error) {
                    console.error('❌ 初始化错误:', error);
                }
            });
            
            // 优化移动端表格显示
            function optimizeTablesForMobile(element) {
                const tables = element.querySelectorAll('table');
                tables.forEach(table => {
                    // 检查表格是否已经被包装过
                    if (table.parentElement.classList.contains('table-container')) {
                        return;
                    }
                    
                    // 创建包装容器
                    const container = document.createElement('div');
                    container.className = 'table-container';
                    
                    // 插入容器并移动表格
                    table.parentNode.insertBefore(container, table);
                    container.appendChild(table);
                    
                    // 添加移动端优化标识
                    table.setAttribute('data-mobile-optimized', 'true');
                    
                    console.log('📱 已优化表格:', table);
                });
            }
            
            // 核心功能调试
            function debugRendering() {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) return;
                
                console.log('🔍 渲染调试信息:');
                console.log('📱 环境:', /iPad|iPhone|iPod/.test(navigator.userAgent) ? 'iOS WebView' : '其他');
                console.log('🧮 MathJax:', typeof MathJax !== 'undefined' ? '已加载' : '未加载');
                console.log('🎨 Mermaid:', typeof mermaid !== 'undefined' ? '已加载' : '未加载');
                
                const mathElements = contentElement.querySelectorAll('.MathJax, .MathJax_Display');
                const mermaidElements = contentElement.querySelectorAll('.mermaid-diagram');
                
                console.log(`🧮 LaTeX元素: ${mathElements.length}`);
                console.log(`🎨 Mermaid图表: ${mermaidElements.length}`);
                
                return {
                    environment: /iPad|iPhone|iPod/.test(navigator.userAgent) ? 'iOS WebView' : '其他',
                    mathJaxLoaded: typeof MathJax !== 'undefined',
                    mermaidLoaded: typeof mermaid !== 'undefined',
                    mathElements: mathElements.length,
                    mermaidElements: mermaidElements.length
                };
            }
            
            // LaTeX调试函数 - 帮助诊断LaTeX渲染问题
            function debugLaTeXRendering() {
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) return;
                
                console.log('🧮 LaTeX渲染调试信息:');
                console.log('📱 MathJax版本:', typeof MathJax !== 'undefined' ? MathJax.version : '未加载');
                console.log('🔧 MathJax配置:', typeof MathJax !== 'undefined' ? MathJax.config : '未配置');
                
                // 检查LaTeX公式元素
                const mathElements = contentElement.querySelectorAll('.MathJax, .MathJax_Display, script[type="math/tex"]');
                console.log(`🧮 发现 ${mathElements.length} 个LaTeX元素:`);
                
                mathElements.forEach((el, index) => {
                    console.log(`LaTeX元素 ${index + 1}:`, {
                        tagName: el.tagName,
                        className: el.className,
                        type: el.getAttribute('type'),
                        innerHTML: el.innerHTML.substring(0, 100) + '...',
                        isProtected: el.getAttribute('data-latex-protected')
                    });
                });
                
                // 检查原始文本中的LaTeX语法
                const allText = contentElement.textContent;
                const dollarMatches = (allText.match(/\$/g) || []).length;
                const backslashMatches = (allText.match(/\\\(/g) || []).length + (allText.match(/\\\[/g) || []).length;
                
                console.log('📝 LaTeX语法统计:', {
                    dollarSigns: dollarMatches,
                    backslashNotation: backslashMatches,
                    possibleFormulas: Math.floor(dollarMatches / 2) + backslashMatches
                });
                
                return {
                    mathElementsCount: mathElements.length,
                    mathJaxLoaded: typeof MathJax !== 'undefined',
                    possibleFormulas: Math.floor(dollarMatches / 2) + backslashMatches
                };
            }
            
            // 暴露给客户端调用
            window.renderMarkdown = renderMarkdown;
            window.debugRendering = debugRendering;
            window.debugLaTeXRendering = debugLaTeXRendering;
            
                                     // 统一分块渲染 - 修复版本，确保LaTeX预处理被正确调用
            function renderOptimizedContent(content) {
                console.log('🚀 开始统一分块渲染');
                nativePrint('🚀 renderOptimizedContent开始执行');
                nativePrint(`📝 输入内容长度: ${content.length}`);
                
                const contentElement = document.getElementById('rendered-content');
                if (!contentElement) {
                    console.error('未找到内容容器元素');
                    return;
                }
                
                // 清空容器
                contentElement.innerHTML = '';
                
                // 在分块渲染前先执行LaTeX预处理
                nativePrint('🔧 在分块渲染前执行LaTeX预处理');
                let processedContent = content;
                
                // 检查预处理函数是否存在
                if (typeof window.preprocessLatexInMarkdown === 'function') {
                    nativePrint('✅ 找到预处理函数，开始处理');
                    processedContent = window.preprocessLatexInMarkdown(content);
                    nativePrint(`🔧 预处理完成，原始长度: ${content.length}, 处理后长度: ${processedContent.length}`);
                } else {
                    nativePrint('❌ 预处理函数不存在！');
                }
                
                // 创建加载提示
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'text-align: center; padding: 20px; color: #666;';
                loadingDiv.textContent = '正在渲染大文件，请稍候...';
                contentElement.appendChild(loadingDiv);
                
                // 延迟渲染以避免阻塞UI
                setTimeout(() => {
                    try {
                        // 移除加载提示
                        contentElement.removeChild(loadingDiv);
                        
                        // 使用已预处理的内容进行分步渲染
                        nativePrint('🔧 开始分步渲染已预处理的内容');
                        renderContentInSteps(processedContent, contentElement);
                        
                    } catch (error) {
                        console.error('❌ 分块渲染失败:', error);
                        nativePrint(`❌ 分块渲染失败: ${error.message}`);
                        contentElement.innerHTML = '<div style="color: red; padding: 20px;">渲染失败: ' + error.message + '</div>';
                    }
                }, 100);
            }
            
                                     // 分步渲染内容 - 简化版本，专注于正确的LaTeX处理
            function renderContentInSteps(content, container) {
                nativePrint('🚀 开始分步渲染内容');
                nativePrint(`📝 内容长度: ${content.length}`);
                
                // 注意：内容已经在renderOptimizedContent中预处理过了
                // 这里不再需要调用预处理函数，避免重复处理
                
                // 根据内容大小智能调整分块策略
                const contentSize = content.length;
                const strategy = getOptimalChunkStrategy(contentSize);
                
                // 将内容按策略分块
                const chunks = chunkContentByStrategy(content, strategy);
                const totalChunks = chunks.length;
                let currentChunk = 0;
                
                console.log(`📄 智能分块渲染: ${totalChunks} 个块, 策略: ${strategy.name}, 内容大小: ${contentSize}`);
                nativePrint(`📄 智能分块渲染开始: ${totalChunks} 个块, 策略: ${strategy.name}, 内容大小: ${contentSize}`);
                
                function renderNextChunk() {
                    nativePrint(`🔧 renderNextChunk调用: currentChunk=${currentChunk}, totalChunks=${totalChunks}`);
                    
                    if (currentChunk >= totalChunks) {
                        nativePrint('✅ 分步渲染完成 - 已达到最大块数');
                        console.log('✅ 分步渲染完成');
                        
                        // 渲染完成后处理
                        setTimeout(() => {
                            processEnhancements(container);
                            
                            // 结束性能监控
                            if (window.endRenderingTimer) {
                                window.endRenderingTimer('分块渲染');
                            }
                        }, 100);
                        
                        return;
                    }
                    
                    const chunk = chunks[currentChunk];
                    nativePrint(`🔧 获取块${currentChunk}: 长度=${chunk.length}, 内容前100字符="${chunk.substring(0, 100)}"`);
                    
                    if (chunk.trim()) {
                        nativePrint(`🔧 块内容非空，开始处理`);
                        
                        try {
                            // 使用安全的markdown解析已预处理的内容
                            nativePrint(`🔧 使用安全解析器解析第${currentChunk}块`);
                            const chunkHtml = safeMarkdownParse(chunk);
                            
                            // 创建块容器
                            const chunkDiv = document.createElement('div');
                            chunkDiv.className = 'content-chunk';
                            chunkDiv.innerHTML = chunkHtml;
                            chunkDiv.style.cssText = 'opacity: 0; transition: opacity 0.3s ease;';
                            
                            container.appendChild(chunkDiv);
                            
                            // 淡入效果
                            setTimeout(() => {
                                chunkDiv.style.opacity = '1';
                            }, 50);
                            
                            nativePrint(`✅ 第${currentChunk}块渲染完成`);
                        } catch (error) {
                            nativePrint(`❌ 第${currentChunk}块渲染失败: ${error.message}`);
                            console.error('块渲染错误:', error);
                        }
                    } else {
                        nativePrint(`🔧 块${currentChunk}内容为空，跳过处理`);
                    }
                    
                    currentChunk++;
                    nativePrint(`🔧 准备渲染下一个块: ${currentChunk}`);
                    
                    // 使用策略中的延迟时间
                    requestAnimationFrame(() => {
                        setTimeout(renderNextChunk, strategy.delay);
                    });
                }
                
                // 添加错误处理确保renderNextChunk能够被调用
                nativePrint(`🔧 准备开始调用renderNextChunk函数`);
                try {
                    renderNextChunk();
                    nativePrint(`🔧 renderNextChunk初始调用成功`);
                } catch (error) {
                    nativePrint(`❌ renderNextChunk初始调用失败: ${error.message}`);
                    console.error('❌ renderNextChunk初始调用失败:', error);
                }
            }
            
            // 处理增强功能
            function processEnhancements(container) {
                console.log('🔗 处理链接功能');
                processLinks(container);
                
                console.log('🖼️ 处理图片功能');
                addImageZoomFunction(container);
                
                console.log('📋 处理代码复制功能');
                addCodeCopyButtons(container);
                
                console.log('☑️ 处理任务列表功能');
                enhanceTaskLists(container);
                
                console.log('🎨 处理Mermaid图表');
                renderMermaidDiagrams(container);
                
                console.log('📱 优化移动端表格');
                optimizeTablesForMobile(container);
                
                console.log('🏷️ 优化HTML元素');
                enhanceHTMLElements(container);
                
                console.log('📑 生成目录');
                generateTOC();
                
                console.log('✅ 所有增强功能处理完成');
                
                // 最后渲染数学公式
                setTimeout(() => {
                    console.log('🧮 开始渲染LaTeX公式');
                    
                    // 预处理LaTeX公式中的中文下标（双重保护：markdown预处理 + HTML预处理）
                    preprocessChineseSubscripts(container);
                    
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        // 使用异步方式渲染，避免阻塞
                        MathJax.typesetPromise([container])
                        .then(() => {
                            console.log('✅ LaTeX渲染完成');
                        })
                        .catch((err) => {
                            console.error('❌ LaTeX渲染错误:', err);
                            // 如果Promise模式失败，尝试传统模式
                            if (MathJax.typeset) {
                                try {
                                    MathJax.typeset([container]);
                                    console.log('✅ LaTeX渲染完成 (降级模式)');
                                } catch (fallbackErr) {
                                    console.error('❌ LaTeX降级渲染也失败:', fallbackErr);
                                }
                            }
                        });
                    } else if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                        // 使用传统的typeset方法
                        try {
                            MathJax.typeset([container]);
                            console.log('✅ LaTeX渲染完成 (传统模式)');
                        } catch (err) {
                            console.error('❌ LaTeX传统渲染失败:', err);
                        }
                    } else {
                        console.warn('⚠️ MathJax未加载或不支持渲染方法');
                    }
                }, 200);
            }
            
            // 获取最佳分块策略
            function getOptimalChunkStrategy(contentSize) {
                if (contentSize < 10000) { // 小于10KB
                    return {
                        name: "快速渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 8, // 每块最多8个段落
                        delay: 30 // 30ms间隔
                    };
                } else if (contentSize < 50000) { // 10KB - 50KB
                    return {
                        name: "优化渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 5, // 每块最多5个段落
                        delay: 50 // 50ms间隔
                    };
                } else if (contentSize < 100000) { // 50KB - 100KB
                    return {
                        name: "分块渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 3, // 每块最多3个段落
                        delay: 80 // 80ms间隔
                    };
                } else { // 大于100KB
                    return {
                        name: "深度优化渲染",
                        chunkType: "paragraph",
                        maxChunkSize: 2, // 每块最多2个段落
                        delay: 100 // 100ms间隔
                    };
                }
            }
            
            // 根据策略分块内容
            function chunkContentByStrategy(content, strategy) {
                // 按段落分割
                const paragraphs = content.split('\n\n').filter(p => p.trim().length > 0);
                const chunks = [];
                
                if (strategy.chunkType === "paragraph") {
                    // 按段落数量分块
                    for (let i = 0; i < paragraphs.length; i += strategy.maxChunkSize) {
                        const chunkParagraphs = paragraphs.slice(i, i + strategy.maxChunkSize);
                        chunks.push(chunkParagraphs.join('\n\n'));
                    }
                }
                
                // 确保至少有一个块
                if (chunks.length === 0) {
                    chunks.push(content);
                }
                
                return chunks;
            }
        </script>
        
    </body>
</html>
